[ { "title": "Joplinæ’ä»¶å¼€å‘æ•™ç¨‹", "url": "/posts/JoplinPluginDevelopment/", "categories": "æ‰‹å†Œ, å¼€å‘", "tags": "", "date": "2022-10-15 00:00:00 +0800", "snippet": "Joplin æ˜¯ä¸€ä¸ª Markdown ç¬”è®°å·¥å…·ï¼Œç›¸æ¯”äº Obsidian è€Œè¨€ï¼ŒJoplin æ˜¯é€šè¿‡å…³ç³»å‹æ•°æ®åº“å­˜å‚¨æ‰€æœ‰çš„ç¬”è®°ã€ä¿¡æ¯ç­‰ï¼Œè€Œ Obsidian æ˜¯åŸºäºæ–‡ä»¶çš„ã€‚æŠ€æœ¯è¦æ±‚ ä¼šå†™ä»£ç ï¼Œä¼šå¼€å‘ èƒ½å¤Ÿè¯»æ‡‚è‹±è¯­ï¼Œéœ€è¦é˜…è¯»å®˜æ–¹ API æ–‡æ¡£ ç†Ÿæ‚‰ JavaScript çš„ä½¿ç”¨ï¼šä½†ä¸æ˜¯å¿…é¡»å¾—ï¼Œä½¿ç”¨è¿‡å…¶ä»–ç›¸ä¼¼çš„è¯­è¨€ä¹Ÿå¯ä»¥ã€‚åœ¨å¼€å‘ Enhancement æ’ä»¶ ä¹‹å‰ï¼Œæˆ‘ä¹Ÿä¸å¤ªç†Ÿæ‚‰ JS ç†Ÿæ‚‰ Typescript çš„ä½¿ç”¨ï¼šåŒä¸Šï¼Œä¸æ˜¯å¿…é¡»çš„ ç•¥æ‡‚ Reactã€cssï¼šåŒä¸Šï¼Œä¸æ˜¯å¿…é¡»çš„ï¼Œä»…åœ¨å¼€å‘æœ‰ UI ç±»çš„æ’ä»¶éœ€è¦ã€‚ç”šè‡³å¯ä»¥ä¸ä½¿ç”¨ React å¼€å‘ï¼Œåªæ˜¯èƒ½è®©ä½ çš„é¡µé¢ä»£ç æ•´æ´ä¸å°‘æ’ä»¶åŠŸèƒ½åˆ†ç±»åœ¨æ’ä»¶çš„æœ€ç»ˆä½œç”¨å¯¹è±¡ä¸Šï¼Œå¯ä»¥å¤§è‡´åˆ†ä¸ºä»¥ä¸‹å››ç±»ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œéœ€è¦å¤šä¸ªç±»å‹çš„åŠŸèƒ½ä¸€èµ·å®ç°æ‰èƒ½å¤Ÿæä¾›è‰¯å¥½çš„ç”¨æˆ·ä½¿ç”¨ä½“éªŒã€‚ Markdown ç¼–è¾‘å™¨æ’ä»¶ï¼šæ¯”å¦‚ç¼–è¾‘å™¨ä¸­çš„è‡ªåŠ¨è¡¥å…¨ç›¸å…³çš„æ’ä»¶ã€‚ä»»ä½•å’Œç¼–è¾‘å™¨ç›¸å…³çš„åŠŸèƒ½ï¼Œéƒ½é€šè¿‡è¯¥ç±»å®ç°ã€‚åŒ…æ‹¬ä½†ä¸é™äºï¼š è‡ªåŠ¨è¡¥å…¨ï¼šæ¯”å¦‚ NoteLinkSystem æ’ä»¶é€šè¿‡ @@ å³å¯è§¦å‘è‡ªåŠ¨è¡¥å…¨ï¼Œå®ç°å¯¹å…¶ä»–ç¬”è®°é“¾æ¥çš„å¿«é€Ÿæ’å…¥ã€‚ ç¼–è¾‘å™¨çš„å®æ—¶æ¸²æŸ“ï¼šæ¯”å¦‚ Enhancement æ’ä»¶ã€‚å¯ä»¥å°† Mermaid, Math ç­‰ Markdown æ ¼å¼çš„ä»£ç ç›´æ¥æ˜¾ç¤ºå‡ºæ¸²æŸ“åçš„ç»“æœã€‚å½“å®æ—¶æ¸²æŸ“è¶³å¤Ÿå¼ºå¤§æ—¶ï¼Œç”šè‡³å¯ä»¥ä¸å†éœ€è¦é¢å¤–çš„ PDF é¢„è§ˆçª—å£ã€‚ è‡ªå®šä¹‰æ ·å¼ï¼šå’Œ Joplin æä¾›çš„è‡ªå®šä¹‰æ ·å¼æ–‡ä»¶ userchrome.css ç±»ä¼¼ï¼Œä½†æ˜¯é€šè¿‡ä»£ç çº§æ’ä»¶å¯ä»¥å®ç°è‡ªå®šä¹‰å…ƒç´ çš„ class ç±»å‹ï¼Œå†é…åˆ css æ ·å¼ï¼Œå³å¯å®ç°åŸºæœ¬å¯¹ä»»æ„å…ƒç´ è‡ªå®šä¹‰æ ·å¼ã€‚æ¯”å¦‚ä»£ç é«˜äº®ã€ä¸åŒçš„ Markdown ä¸»é¢˜ã€æœç´¢å…³é”®è¯é«˜äº®ç­‰ç­‰ã€‚ å¯¹å†…å®¹çš„ä¿®æ”¹ï¼šä¸€èˆ¬ä¸å¿«æ·é”®ã€å·¥å…·æ ç­‰é…åˆå®ç°å¯¹å†…å®¹çš„è‡ªåŠ¨ä¿®æ”¹ã€‚æ¯”å¦‚é«˜äº®ã€åŠ èƒŒæ™¯è‰²ç­‰ç­‰ã€‚ â€¦ Markdown æ¸²æŸ“æ’ä»¶ï¼šæ¯”å¦‚ Admonition æ’ä»¶ã€‚è¯¥éƒ¨åˆ†è´Ÿè´£ä¿®æ”¹ Markdown æ–‡æœ¬è½¬ä¸º HTML çš„è¿‡ç¨‹ã€‚åŒ…æ‹¬ä½†ä¸é™äºï¼š è‡ªå®šä¹‰ Markdown è¯­æ³•æ¸²æŸ“ï¼šæ¯”å¦‚ Admonition æ’ä»¶èƒ½å¤Ÿå°† !!!note æ¸²æŸ“æˆæ›´é†’ç›®çš„æ ¼å¼ã€‚ ä¿®æ”¹ç°æœ‰ Markdown æ¸²æŸ“ç»“æœï¼šæ¯”å¦‚ Enhancement æ’ä»¶èƒ½å¤Ÿå°† ![title]() æ¸²æŸ“ä¸ºå¸¦æœ‰å›¾æ ‡é¢˜çš„ç»“æœã€‚ å¸¦æœ‰ç‹¬ç«‹ Panel çš„ä¿¡æ¯æ”¶é›†ã€å±•ç¤ºã€äº¤äº’ç­‰ï¼šæ¯”å¦‚ NoteLink æ’ä»¶ã€‚ Joplin æ•°æ®åº“ç›¸å…³æ’ä»¶ï¼šæ¯”å¦‚ BackUp æ’ä»¶ã€‚ä¿®æ”¹ç¬”è®°çš„æ–‡ä»¶å¤¹è·¯å¾„ã€æ ‡é¢˜ï¼Œæ–°å»º/åˆ é™¤ç¬”è®°ç­‰ç­‰ã€‚æ’ä»¶å¼€å‘åˆå§‹åŒ–åˆå§‹åŒ–å·¥å…·Joplin æä¾›äº†æ’ä»¶å¼€å‘å¼€å§‹æ—¶çš„åˆå§‹åŒ–å·¥å…· generaor-joplinã€‚å…·ä½“ç»†èŠ‚è¯·å‚è€ƒå®˜æ–¹ç½‘ç«™ï¼šGetting started with plugin developmentã€‚ å®‰è£… Node.js npm install -g yo generator-joplin åœ¨ä»»æ„æ–‡ä»¶å¤¹å†…ï¼Œæ‰§è¡Œ yo joplin å®Œæˆåˆå§‹åŒ–æ“ä½œã€‚æ–‡ä»¶ç»“æ„é‡Œé¢æœ‰å‡ ä¸ªæ¯”è¾ƒå…³é”®çš„æ–‡ä»¶ï¼š plugin.config.jsonï¼šé‡Œé¢çš„ extraScripts ç”¨äºå­˜æ”¾éœ€è¦è½¬æ¢æˆ *.js çš„ *.ts ä»¥åŠ *.tsx æ–‡ä»¶è·¯å¾„ã€‚**æ‰€æœ‰çš„è·¯å¾„éƒ½æ˜¯ç›¸å¯¹äº ./src ç›®å½•è€Œè¨€ï¼ æ’ä»¶å¼€å‘æ—¶ï¼ŒJoplin çš„æ’ä»¶æ¥å£æœ‰æ—¶å€™éœ€è¦ç›´æ¥æä¾› *.js æ–‡ä»¶è·¯å¾„ï¼Œä½†æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯ç”¨ *.ts æˆ–è€… *.tsx å®ç°çš„ï¼Œè¿™ç§æƒ…å†µä¸‹å°±éœ€è¦åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­é…ç½®ä¸€ä¸‹ï¼Œä¸ç„¶ç¼–è¯‘æ—¶æ— æ³•æ‰¾åˆ°å¯¹åº”çš„ *.js æ–‡ä»¶ã€‚å…¶å®ƒ *.ts æ–‡ä»¶ä¹‹é—´ç›¸äº’å¼•ç”¨çš„æƒ…å†µåˆ™æ— éœ€åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­é…ç½®ã€‚ ./src/index.tsï¼šæ’ä»¶çš„å…¥å£ï¼Œåˆå§‹åŒ–åä¸€èˆ¬åŒ…å«ä»¥ä¸‹æ ¼å¼ï¼Œåªæ›¿æ¢ä¸­é—´çš„éƒ¨åˆ†å³å¯ã€‚ ./apiï¼šè¿™ä¸ªæ˜¯åŒ…å«åœ¨åˆå§‹æ–‡ä»¶ä¸­çš„ã€é…åˆ Joplin æ’ä»¶æ¥å£ã€å‡½æ•°ã€ç±»ç­‰ï¼Œæœ€å¥½ä¸è¦ä¿®æ”¹ã€‚joplin.plugins.register({\tonStart: async function() { // ä»è¿™é‡Œå¼€å§‹å†™ä½ çš„æ’ä»¶é€»è¾‘ }})æ³¨å†Œæ’ä»¶await joplin.contentScripts.register( ContentScriptType.MarkdownItPlugin, // æˆ–è€…æ˜¯ ContentScriptType.CodeMirrorPlugin, åˆ†åˆ«å¯¹åº” markdown æ¸²æŸ“æ’ä»¶ä»¥åŠ markdown ç¼–è¾‘å™¨æ’ä»¶ 'å”¯ä¸€çš„æ’ä»¶ID', './æ’ä»¶çš„è·¯å¾„/index.js' // è¿™é‡Œçš„æ–‡ä»¶å¦‚æœæ˜¯ç”¨ ts å†™çš„ï¼Œé‚£ä¹ˆéœ€è¦å† plugin.config.json æ–‡ä»¶ä¸­é…ç½®);æ›´ç»†è‡´çš„å†…å®¹è¯·å‚è€ƒï¼šjoplinå¼€å‘æ–‡æ¡£Markdown ç¼–è¾‘å™¨æ’ä»¶å¼€å‘æˆªæ­¢åˆ°ç›®å‰ï¼ŒJoplin æ¡Œé¢ç«¯ çš„ Markdown ç¼–è¾‘å™¨æ˜¯åŸºäº Codemirror 5 å¼€å‘çš„ï¼Œç›®å‰è¿˜æ²¡æœ‰å¬åˆ°è¦åˆ‡æ¢åˆ° Codemirror 6 çš„æ¶ˆæ¯ï¼ˆObsidian ç­‰ç”¨çš„å°±æ˜¯ v6ï¼Œv6 ç›¸è¾ƒäº v5 è€Œè¨€æ–°å¢äº†ä¸€äº›åŠŸèƒ½ï¼Œèƒ½å¤Ÿæ›´æ–¹ä¾¿çš„åˆ›å»º decoration ç­‰ï¼Œå®ç° live preview åŠŸèƒ½ï¼‰ã€‚å®‰å“ç«¯çš„ Joplin ä½¿ç”¨çš„åˆ™æ˜¯ v6 ç‰ˆæœ¬ï¼Œä½†æ˜¯ç›®å‰å®‰å“ç‰ˆä¸æ”¯æŒæ’ä»¶ï¼Œå› æ­¤è¿™é‡Œä»…è®¨è®º v5 ç‰ˆæœ¬ä¸‹çš„æ’ä»¶å¼€å‘ã€‚index.ts æ–‡ä»¶çš„ä¸»ä½“å†…å®¹ï¼šmodule.exports = { default: function(context) { return { plugin: function(CodeMirror) { // æ’ä»¶é€»è¾‘éƒ¨åˆ† // è¿™é‡Œæ˜¯é€šè¿‡ defineOption æ–¹å¼å®ç° cm æ’ä»¶ CodeMirror.defineOption('optionçš„å”¯ä¸€ID', false, async function(cm, val, old) { // xxx } }, codeMirrorResources: [ // cm5 è‡ªå¸¦çš„ addonsï¼Œcm5 æœ¬èº«å°±è‡ªå¸¦äº†ä¸å°‘çš„æ’ä»¶ï¼Œæ¯”å¦‚æœç´¢é«˜äº®ç­‰ // å…·ä½“å‚è€ƒï¼šhttps://codemirror.net/5/doc/manual.html#addons // ä¸‹é¢çš„ä¾‹å­å¯¹åº” mode/overlay.js ä»¥åŠ hint/show-hint.js 'addon/mode/overlay', 'addon/hint/show-hint' ], codeMirrorOptions: { // å¿…é¡»åœ¨è¿™é‡Œè¿›è¡Œé…ç½®å¼€å¯ï¼Œå¦åˆ™æ— æ³•ç”Ÿæ•ˆ 'å¯¹åº”ä¸Šé¢ optionçš„å”¯ä¸€ID': true, }, assets: { // é…ç½® css æ ·å¼æ–‡ä»¶ã€‚Joplin ä¸­ cm5 ä¸å…è®¸æºå¸¦ *.js è„šæœ¬ }, } }}Markdown æ¸²æŸ“æ’ä»¶å¼€å‘ç‹¬ç«‹ Panel æ’ä»¶å¼€å‘æ•°æ®åº“ç›¸å…³å¼€å‘æ³¨æ„äº‹é¡¹ç¬¬ä¸‰æ–¹åº“çš„ä½¿ç”¨ç”±äº Joplin éœ€è¦è·¨å¹³å°ï¼Œå®ƒè‡ªå¸¦äº†ä¸€å¥—è‡ªå·±çš„ fs ä»¥åŠ sqlite3 åº“ï¼Œéœ€è¦é€šè¿‡ä»¥ä¸‹æ–¹å¼å¼•å…¥åŒ…ï¼Œä¸èƒ½ç›´æ¥ requireï¼šconst fs = joplin.require('fs-extra')const sqlite3 = joplin.require('sqlite3')è¿™è¿›ä¸€æ­¥å¯¼è‡´æ‰€æœ‰ä¾èµ–äº† fs ä»¥åŠ sqlite3 çš„åº“éƒ½æ— æ³•æ­£å¸¸ä½¿ç”¨ï¼" }, { "title": "çŸ¥è¯†è·å–", "url": "/posts/GetKnowledge/", "categories": "æ‰‹å†Œ, ç ”ç©¶", "tags": "", "date": "2022-08-28 00:00:00 +0800", "snippet": "åœ¨ä¿¡æ¯çˆ†ç‚¸çš„ä»Šå¤©ï¼Œé«˜æ•ˆçš„è·å–é«˜è´¨é‡æ•°æ®èƒ½å¤ŸèŠ‚çœå¤§é‡æ—¶é—´ï¼ŒåŒæ—¶åˆç†çš„çŸ¥è¯†å¤„ç†èƒ½å¤Ÿæ›´å¥½çš„ä¸ºä¸ªäººçš„å·¥ä½œã€å­¦ä¹ ç­‰æ‰“ä¸‹åŸºç¡€ã€‚çŸ¥è¯†è·å–é¦–å…ˆæ˜¯çŸ¥è¯†æ¥æºçš„é€‰æ‹©ï¼Œå–å†³äºå„è‡ªçš„ç›®æ ‡ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š å¾®ä¿¡å…¬ä¼—å· InfoQ çš„å„ç±» topicï¼šhttps://www.infoq.cn/topic/ åšå®¢ å„è®ºæ–‡æœŸåˆŠ å…¶å®ƒä¸çŸ¥é“æœ‰å“ªäº›æ—¶ï¼Œå¤šå’Œèº«è¾¹çš„äººæ²Ÿé€šå³å¯ã€‚åŒæ—¶ï¼Œå¯ä»¥çœ‹åˆ°ä¿¡æ¯çš„æ¥æºå¤šç§å¤šæ ·ï¼Œå¾—ç›Šäº RSSï¼Œæˆ‘ä»¬èƒ½å¤Ÿè®©ä¿¡æ¯ä¸»åŠ¨æ¥æ‰¾æˆ‘ä»¬ï¼Œé¿å…äº†åå¤åœ¨å„ç§è½¯ä»¶ã€è®¾å¤‡ä¸­æ¨ªè·³è·å–ä¿¡æ¯ã€‚ç„¶è€Œå›½å†…ç½‘ç«™å¯¹ RSS æ”¯æŒååˆ†ç³Ÿç³•ï¼Œå› æ­¤éœ€è¦å€ŸåŠ©ç¬¬ä¸‰æ–¹è½¯ä»¶/å¹³å°ç­‰è®©åŸæœ¬ä¸æ”¯æŒ RSS è®¢é˜…çš„ç½‘ç«™ã€å…¬ä¼—å·ä¸Šå‘å¸ƒçš„ä¿¡æ¯èƒ½å¤Ÿä»¥ RSS çš„å½¢å¼è·å–åˆ°ã€‚ RSSHubï¼šç¤¾åŒºå…±åŒç»´æŠ¤çš„å·¥å…·ï¼Œç”¨æ¥ä»åŸæœ¬ä¸æ”¯æŒ RSS çš„ç½‘ç«™ç”Ÿæˆ RSS werssï¼šä¸“æ³¨äºå¾®ä¿¡å…¬ä¼—å·çš„ RSS ç”ŸæˆRSS é˜…è¯»å™¨åˆ™å¤šç§å¤šæ ·ï¼Œä»»ä¸€æ¬¾è‡ªå·±å–œæ¬¢çš„å³å¯ã€‚ Newsblur FreshRss Github rss-readerçŸ¥è¯†å¤„ç†%%{init: { 'theme': 'neutral' } }%%flowchart LR æ¥æº[å„å¤§çŸ¥è¯†æ¥æº] å¶ç„¶[å¶ç„¶å¾—çŸ¥] RSS(RSSé˜…è¯»å™¨) RIL(Read-it-laterå·¥å…·) æœ‰ä»·å€¼{ä¼¼ä¹æœ‰ä»·å€¼?} æœ‰æ—¶é—´{å½“å‰æœ‰æ—¶é—´?} é˜…è¯»([é˜…è¯»]) æ¥æº--&gt;|rss|RSS--&gt;æœ‰ä»·å€¼ æœ‰ä»·å€¼--&gt;|Yes|æœ‰æ—¶é—´--&gt;|Yes|é˜…è¯» æœ‰æ—¶é—´--&gt;|No|RIL--&gt;é˜…è¯» å¶ç„¶--&gt;æœ‰ä»·å€¼%%{init: { 'theme': 'neutral' } }%%flowchart LR é˜…è¯»([é˜…è¯»]) æœ‰ä»·å€¼{æœ‰ä»·å€¼?} äºŒçº§(äºŒçº§çŸ¥è¯†åº“æ”¶å½•) ä¸€çº§(ä¸€çº§çŸ¥è¯†åº“è’¸é¦) é˜…è¯»--&gt;æœ‰ä»·å€¼--&gt;|Yes|äºŒçº§--&gt;ä¸€çº§ ä¸€çº§æ³¨é‡çŸ¥è¯†ç‚¹ä¸çŸ¥è¯†ç‚¹çš„å…³ç³»åŠè‡ªå·±çš„æ€è€ƒæ€»ç»“ï¼Œç”¨äºæ³›å‹çŸ¥è¯†ï¼ŒåŠå‘æ•£æ€è€ƒï¼Œæ³¨é‡å…¨å±€è§‚ äºŒçº§æ³¨é‡ç»†èŠ‚çŸ¥è¯†çš„ç§¯ç´¯ï¼Œç”¨äºè§£å†³å…·ä½“é—®é¢˜ æ£€ç´¢æ—¶ç»Ÿä¸€æ£€ç´¢" }, { "title": "ReadCube Papers API è®°å½•", "url": "/posts/ReadCubePapersAPI/", "categories": "å¼€å‘", "tags": "", "date": "2022-05-21 00:00:00 +0800", "snippet": "æœ¬æ–‡ç”¨äºè®°å½•åœ¨å¼€å‘ Joplin çš„ ReadCube Papers æ’ä»¶ä»¥å®ç°ç¬”è®°è½¯ä»¶ä¸æ–‡çŒ®ç®¡ç†è½¯ä»¶çš„è”åŠ¨æ—¶ï¼Œä½¿ç”¨åˆ°çš„ä¸€äº› web ç‰ˆ papers çš„æ¥å£ã€‚æ’ä»¶åœ°å€ï¼šjoplin-plugin-enhancementã€‚ç™»å½•åŠ cookie è·å– URLï¼šhttps://services.readcube.com/authentication/login æ–¹æ³•ï¼šPOST è¯·æ±‚æ•°æ®ç±»å‹ä¸º formDataï¼ŒåŒ…å«ï¼š client: webapp api: // å¯ä¸ºç©º client_version: // å¯ä¸ºç©º email: ç”¨æˆ·é‚®ç®± password: ç”¨æˆ·å¯†ç  è¿”å›å€¼ set-cookie æœ‰ä¸‰æ¡ï¼Œåˆ†åˆ«ä¸ºï¼š _readcube-login_token _readcube_session user_web_token ä¸‰ä¸ªä¸€èµ·å³ä¸º cookieã€‚ WebSocketç”¨äºæ¥æ”¶æ¥è‡ªæœåŠ¡å™¨ç«¯å…³äºæ•°æ®å˜æ›´çš„æ¶ˆæ¯ï¼Œè¿›è€Œå®ç°å®æ—¶åŒæ­¥ã€‚åœ°å€ï¼šwss://push.readcube.com/bayeux idï¼šæ¯ä¸€æ¡å®¢æˆ·ç«¯å‘å¾€æœåŠ¡ç«¯çš„æ¶ˆæ¯å‡ä¼šæœ‰ä¸€ä¸ª id ä¸º 36 è¿›åˆ¶ã€‚ éœ€è¦å®šæœŸå‘æœåŠ¡ç«¯å‘é€å¿ƒè·³åŒ…ï¼Œå¦åˆ™ä¸€æ®µæ—¶é—´åæœåŠ¡å™¨å°†ä¸»åŠ¨æ–­å¼€ ws è¿æ¥ å‘é€/æ¥æ”¶çš„æ‰€æœ‰æ•°æ®å‡ä¸º Json æ ¼å¼ clientId å¾ˆå…³é”®ï¼Œä¸ç„¶æ— æ³•æˆåŠŸæ¡æ‰‹ï¼Œéœ€è¦å…ˆè·å– clientIdWebSocket æ¡æ‰‹ URLï¼šhttps://push.readcube.com/bayeux?message=[{\"channel\":\"/meta/handshake\",\"version\":\"1.0\",\"supportedConnectionTypes\":[\"websocket\",\"eventsource\",\"long-polling\",\"cross-origin-long-polling\",\"callback-polling\"],\"id\":\"1\"}]&amp;jsonp=__jsonp1__ æ–¹æ³•ï¼šGET è¿”å›ï¼šå†…å«æœ‰ clientId åŠæ˜¯å¦æˆåŠŸï¼Œä¸”è¯¥æ¬¡äº¤äº’ id ä¸º 1ã€‚ éœ€è¦è®¾ç½® CookieWebSocket è¿æ¥ ç¤ºä¾‹è§ï¼šReadCube Papers WebSocket.ts è®¢é˜…ï¼š usersï¼š[{\"channel\":\"/meta/subscribe\",\"clientId\":\"client-6774640\",\"subscription\":\"/production/users/user-id\",\"id\":\"3\"}]ã€‚ä¸çŸ¥é“ä¸ºå•¥å®˜æ–¹è¿ç»­è¯·æ±‚äº† 2 æ¬¡ collections: [{\"channel\":\"/meta/subscribe\",\"clientId\":\"client-6774640\",\"subscription\":\"/production/collections/collection-id/changes\",\"id\":\"4\"}]ã€‚ä¸çŸ¥é“ä¸ºå•¥å®˜æ–¹è¿ç»­è¯·æ±‚äº† 3 æ¬¡ å¿ƒè·³åŒ…ï¼š[{\"channel\":\"/meta/connect\",\"clientId\":\"client-6774640\",\"connectionType\":\"websocket\",\"id\":\"b\"}]ã€‚å‘é€åï¼ŒæœåŠ¡ç«¯çº¦ 25s åè¿”å›æˆåŠŸç»“æœï¼Œæ­¤æ—¶éœ€è¦ç«‹åˆ»å‘é€ä¸‹ä¸€ä¸ªå¿ƒè·³åŒ…ã€‚æœåŠ¡ç«¯è¿”å›çš„ç»“æœä¸­åŒ…å«å“åº”çš„å»¶æ—¶é•¿åº¦ï¼ˆç°åœ¨æ˜¯ 25000ï¼‰ï¼Œå¯ä»¥ä»¥å…¶ä¸ºä¾æ®åˆ¤æ–­ WebSocket çš„å­˜æ´»ã€‚ä¿¡æ¯è·å– å‡éœ€è¦è®¾ç½® cookieã€‚ç¤ºä¾‹è§ï¼šReadCube Papers.tså¯èƒ½æ˜¯å¤šè®ºæ–‡åº“çš„åŸå› ï¼Œæ¯ä¸ªç”¨æˆ·æœ‰è‡³å°‘ä¸€ä¸ª collectionsï¼Œæ¯ä¸ª collection ä¸­æœ‰è‹¥å¹² itemï¼Œæ¯ä¸ªitem å³ä¸ºä¸€ç¯‡è®ºæ–‡ï¼Œæ¯ä¸ª collection å…·å¤‡å”¯ä¸€ idï¼Œitem ä¹Ÿå…·å¤‡å”¯ä¸€ idã€‚ åŠŸèƒ½ URL æ–¹æ³• è¯´æ˜ è·å–æ‰€æœ‰ collections https://sync.readcube.com/collections/ GET Â  è·å–æŒ‡å®š collection ä¸­çš„æ–‡ç«  item åˆ—è¡¨ https://sync.readcube.com/collections/{collectionId}/items?sort%5B%5D=title,asc&amp;size=50 GET ä¸€æ¬¡æœ€å¤šæ‹‰å–çš„ size ä¸º50ï¼Œè¿”å›å€¼ä¸­æœ‰ scroll_idï¼Œæƒ³è¦è·å–åé¢çš„éœ€è¦å¢åŠ å‚æ•° scoll_id ç»§ç»­è°ƒç”¨è¯¥æ¥å£ è·å–æŒ‡å®š item çš„ä¿¡æ¯ https://sync.readcube.com/collections/{collectionId}/items/{itemId} GET ä¸Šä¸€ä¸ª item åˆ—è¡¨ä¸­ä¹ŸåŒ…å«å…·ä½“ item çš„ä¿¡æ¯ï¼Œè¯¥éƒ¨åˆ†åº”è¯¥ä¸»è¦ç”¨äºåŒæ­¥å•ä¸€ item çš„ä¿¡æ¯ è·å–æŒ‡å®š item çš„æ‰€æœ‰ annotation https://sync.readcube.com/collections/{collectionId}/items/{itemId}/annotations GET PDF é‡Œåšçš„æ ‡è®°ã€ç¬”è®°ç­‰ è·å–æŒ‡å®š item çš„ metadata https://services.readcube.com/reader/metadata?doi=${doi} GET æ ¼å¼åŒ–æ•°æ®ï¼ŒåŒ…æ‹¬å¼•ç”¨ã€å›¾ç‰‡ã€ä½œè€…ä¿¡æ¯ç­‰ è¿˜æœ‰è®¸å¤šå…¶å®ƒæ¥å£ï¼Œä¸ªäººéœ€æ±‚åŸå› ä¸éœ€è¦å…¶ä»–æ¥å£ï¼Œå› æ­¤éœ€è¦è‡ªè¡Œç ”ç©¶ã€‚è·³è½¬ ç›´æ¥æµè§ˆå™¨è·³è½¬åˆ° PDFï¼šhttps://www.readcube.com/library/${collectionId}:${itemId} ç›´æ¥æµè§ˆå™¨è·³è½¬åˆ° annotationï¼šhttps://www.readcube.com/library/${collectionId}:${itemId}#annotation:${annotationId}æ›´æ–°item ä¿¡æ¯æ›´æ–°ç»Ÿä¸€é€šè¿‡ PATCH ç±»å‹è¯·æ±‚è¿›è¡Œã€‚ URLï¼šhttps://sync.readcube.com/collections/${collectionId}/items/${itemId}?client=webapp&amp;client_id=${clientId}&amp;client_version=4.12.6 ç±»å‹ï¼šPATCH å‚æ•°ï¼š{â€œitemâ€:{â€œuser_dataâ€:{â€œnotesâ€:â€casâ€}}} è¿”å›å€¼ï¼šitem çš„å…¨éƒ¨ä¿¡æ¯å…¶å®ƒçš„ç±»ä¼¼ã€‚" }, { "title": "æ•°å­¦ä¼˜åŒ–æ¨¡å‹åˆ†ç±»", "url": "/posts/MathOptimizationModel/", "categories": "æ‰‹å†Œ, ç ”ç©¶", "tags": "æ•°å­¦", "date": "2022-04-09 12:54:07 +0800", "snippet": "åœ¨äº‘è®¡ç®—ã€è¾¹ç¼˜è®¡ç®—ã€é›¾è®¡ç®—ç­‰é¢†åŸŸï¼Œä¼˜åŒ–é—®é¢˜ååˆ†å¸¸è§ï¼Œä¸ºæ–¹ä¾¿åç»­ç ”ç©¶å·¥ä½œï¼Œè¿™é‡Œè®°å½•ä¸€äº›ç»å¸¸å‡ºç°çš„æ•°å­¦æ¨¡å‹ä»¥æ–¹ä¾¿åç»­æ±‚è§£é—®é¢˜æ—¶çš„å¿«é€ŸæŸ¥é˜…ï¼Œæ¯ä¸ªæ¨¡å‹åçš„è§£é‡Šå‡æ¥è‡ªå¼•ç”¨è®ºæ–‡ã€‚ ç›®å‰ä»åœ¨å®Œå–„ä¸­ï¼Œä¹‹å‰çœ‹çš„è®ºæ–‡æ²¡æœ‰åšè®°å½•ï¼Œåç»­é˜…è¯»çš„è®ºæ–‡ä¼šä¸æ–­æ‰©å……æœ¬ç¯‡å†…å®¹ å¼•ç”¨çš„è®ºæ–‡å±äºå»ºæ¨¡å‡ºçš„æ¨¡å‹ç¬¦åˆè¯¥ç±»ï¼Œå¹¶ä¸æ˜¯è¯¥ç±»æ¨¡å‹ç¬¬ä¸€æ¬¡å‡ºç°ã€è¢«å®šä¹‰çš„è®ºæ–‡ï¼›è¢«å¼•ç”¨æ–‡ç« çš„å‡ºç°ä¸å¦å–å†³äºæˆ‘ä¸ªäººçš„é˜…è¯»åˆ°å®ƒä»¬çš„é¡ºåº ğŸ˜ƒ å¼•ç”¨è®ºæ–‡ä¸»è¦æ¥æºï¼š TCC Integer Programming (IP)Integer Linear Programming (ILP)å®šä¹‰\\(\\begin{array}{ll}\t\\operatorname{maximize} &amp; \\mathbf{c}^{\\mathrm{T}} \\mathbf{x} \\\\\t\\text { subject to } &amp; A \\mathbf{x} \\leq \\mathbf{b} \\\\\t&amp; \\mathbf{x} \\geq \\mathbf{0} \\\\\t&amp; \\mathbf{x} \\in \\mathbb{Z}^{n}\\end{array}\\) ç°æœ‰æˆç†Ÿçš„å·¥å…·æ±‚è§£ ILP åŠ MILP é—®é¢˜ï¼Œæ¯”å¦‚ CPLEX ç­‰ã€‚ Lenstra et al.1 have proved that no algorithm is able to find a solution in polynomial time with a smaller approximation ratio than 3/2.å®ä¾‹ é€šè¿‡è¿‘ä¼¼ç®—æ³•è¿›è¡Œæ±‚è§£ï¼Œéœ€è¦è€ƒå¯Ÿè¿‘ä¼¼ç‡ï¼ˆApproximation rateï¼‰2ã€‚Mixed Integer Programming (MIP)ILP ä¸­ä»…æœ‰éƒ¨åˆ†å˜é‡å…·æœ‰æ•´æ•°çº¦æŸï¼Œå…¶ä½™å˜é‡ä¸ºå®æ•°çš„æƒ…å†µä¸‹ä¸º MIPTwo Stage Mixed Integer Programming\\[\\begin{array}{clc}\t\\min _{z, x, v} &amp; f_{1}(z)+f_{2}(x)+f_{3}(v) &amp; \\\\\t\\text { s.t. } &amp; B_{1} z+B_{2} x &amp; \\leq b_{2} \\\\\t&amp; B_{3} v &amp; \\leq b_{3} \\\\\t&amp; A_{1} z+A_{2} x+A_{3} v &amp; \\leq b_{1} \\\\\t&amp; z \\in \\mathbb{R}^{n}, x \\in \\mathbb{Z}^{m}, v \\in \\mathbb{R}^{p},\t\\end{array}\\]where Z is the set of integers. The first stage variables are z and x, and the second stage variables are v. The first and second stage constraints which are independent of each other are represented by the first two inequalities, while the constraints which couple the first and second stages are represented by the third inequality3.Mixed Integer Non-Linear Programming (MINLP)å®šä¹‰\\[\\begin{aligned}&amp;\\min &amp;&amp;f(x, y)\\\\&amp;\\text { s.t. } &amp;&amp;c_{i}(x, y)=0 \\quad \\forall i \\in E\\\\&amp; &amp;&amp;c_{i}(x, y) \\leq 0 \\quad \\forall i \\in I\\\\&amp; &amp;&amp;x \\quad \\in X\\\\&amp; &amp;&amp;y \\quad \\in Y \\qquad\\text { integer }\\end{aligned}\\]where each $c_i(x,y)$ is a mapping from $R^n$ to $R$, and $E$ and $I$ are index sets for equality and inequality constraints, respectively. Typically, the functions $f$ and $c_i$ have some smoothness properties, i.e., once or twice continuously differentiable4.Software developed for MINLP has generally followed two approaches4: Outer Approximation/Generalized Benderâ€™s Decomposition: These algorithms alternate between solving a mixed-integer LP master problem and nonlinear programming subproblems. Branch-and-Bound: Branch-and-bound methods for mixed-integer LP can be extended to MINLP with a number of tricks added to improve their performance.å®ä¾‹ å°†æŸä¸ªçº¦æŸæ¡ä»¶æš‚æ—¶ä¸è€ƒè™‘çš„æƒ…å†µä¸‹ï¼Œå°†çº¦æŸä¸­çš„å˜é‡åˆ†ä¸ºäº’ä¸å¹²æ‰°çš„ä¸¤ç»„ï¼Œè¿›è€Œå°†åŸé—®é¢˜åˆ†è§£ä¸ºä¸»ä»é—®é¢˜5ã€‚ ä¼˜åŒ–é—®é¢˜å»ºæ¨¡æ˜¯ MINLPï¼Œæ”¾å®½çº¦æŸè¿›è¡Œäº†åˆ†è§£ï¼Œä½†æ˜¯ä¹‹åç–‘ä¼¼æœªè¿˜åŸçº¦æŸæˆ–è¯æ˜é—®é¢˜ç›¸ç­‰ï¼Œä½¿å¾—æå‡ºçš„è§£æ³•æ˜¯å…·å¤‡å‰ææ¡ä»¶çš„ï¼šWe first consider the scenario that ESs do not cache the relevant services, and generate an initial computing strategy that satisfies the above constraints. å¼•ç”¨ J. K. Lenstra, D. B. Shmoys, and ÌE. Tardos, â€œApproximation algo-rithms for scheduling unrelated parallel machines,â€Mathematicalprogramming, vol. 46, no. 1, pp. 259â€“271, 1990.Â &#8617; Szalay, M., Matray, P. &amp; Toka, L. Real-Time FaaS: Towards a Latency Bounded Serverless Cloud. Ieee Transactions Cloud Comput PP, 1â€“1 (2022).Â &#8617; Sehloff, David Karl, Maitreyee Marathe, Ashray Manur, and Giri Venkataramanan. â€œSelf-sufficient participation in cloud-based demand response.â€ IEEE Transactions on Cloud Computing (2021).Â &#8617; https://neos-guide.org/content/mixed-integer-nonlinear-programmingÂ &#8617;Â &#8617;2 H. Zhou, Z. Zhang, D. Li and Z. Su, â€œJoint Optimization of Computing Offloading and Service Caching in Edge Computing-based Smart Grid,â€ in IEEE Transactions on Cloud Computing, doi: 10.1109/TCC.2022.3163750.Â &#8617; " }, { "title": "ğŸ” Softether VPN æ­å»ºåŠä½¿ç”¨", "url": "/posts/SoftetherVPN/", "categories": "æ‰‹å†Œ, Linux", "tags": "Linux, è½¯ä»¶", "date": "2022-04-06 21:10:30 +0800", "snippet": "åœ¨ä¸€äº›è¯¸å¦‚å…¬å¸ã€å­¦æ ¡å®éªŒå®¤ã€éƒ¨åˆ†å®¶ç”¨ç½‘ç»œç­‰å†…ç½‘ç¯å¢ƒä¸‹ï¼Œéƒ¨åˆ†æœåŠ¡å™¨ã€NASã€Embyç­‰ç”±äºæ²¡æœ‰å…¬ç½‘ IP å¯¼è‡´ç¦»å¼€å†…ç½‘ç¯å¢ƒä¸‹æ— æ³•è®¿é—®ï¼Œæ­¤æ—¶éœ€è¦æ­å»º VPNã€ç«¯å£è½¬å‘ç­‰æ–¹å¼æ¥å®ç°å†…ç½‘å¤–è®¿é—®ã€‚è€ƒè™‘åˆ°ä¸€äº› frp ç­‰ç«¯å£è½¬å‘å·¥å…·ä¸å…³æ³¨ç”¨æˆ·æƒé™ã€zerotier åŠ n2n ç­‰åˆä¸èƒ½ç»†ç²’åº¦çš„æ§åˆ¶ç”¨æˆ·è¯·æ±‚ï¼Œè¿™é‡Œé€‰ç”¨åŠŸèƒ½è¾ƒä¸ºå…¨é¢çš„ Softether VPNã€‚ å¦‚æœåªæ˜¯ä¸ªäººä½¿ç”¨ï¼Œä»…æƒ³è®¿é—®å†…ç½‘å¯¹åº”æœåŠ¡ä¸”ä¸éœ€è¦æƒé™ç®¡ç†ç­‰é¢å¤–åŠŸèƒ½ï¼Œé‚£ä¹ˆæ¨èä½¿ç”¨ frpã€zerotier ç­‰å·¥å…·ï¼Œé…ç½®ç®€æ˜“ï¼Œä½¿ç”¨ç®€å•ï¼Œå®¹æ˜“ä¸Šæ‰‹ã€‚å‡†å¤‡ä¸€å°å…·å¤‡å…¬ç½‘ IP çš„æœåŠ¡å™¨ï¼šSoftether æœåŠ¡ç«¯éœ€è¦èƒ½è¢«æ‰€æœ‰å®¢æˆ·ç«¯è®¿é—®åˆ° CPUã€RAM é…ç½®æ— éœ€å¤ªé«˜ ç½‘ç»œç¯å¢ƒè¦å¥½ï¼Œå’Œ VPN çš„ä½¿ç”¨ä½“éªŒç›´æ¥æŒ‚é’©Softether æœåŠ¡ç«¯å®‰è£… ç°æœ‰å¾ˆå¤šè¾ƒä¸ºå®Œå–„çš„æ•™ç¨‹ï¼Œç›´æ¥å‚è€ƒå³å¯ã€‚ä¾‹å¦‚ï¼šhttps://www.mivm.cn/softether-vpn-lan/ å®˜æ–¹æœ‰å›¾å½¢å®¢æˆ·ç«¯ï¼Œæ— éœ€å…¨ç¨‹å‘½ä»¤è¡Œé‡ç‚¹åŠŸèƒ½ VPN æµé‡ç­‰æƒé™ç®¡æ§ï¼šé€šè¿‡ä¸ºä¸åŒç”¨æˆ·å»ºç«‹ä¸åŒç”¨æˆ·ç»„ï¼Œå¹¶é™åˆ¶ä¸åŒç”¨æˆ·ç»„ä½¿ç”¨ VPN çš„ä¸Šè¡Œã€ä¸‹è¡Œç­‰å®ç°æƒé™æ§åˆ¶ ç”¨æˆ·è¡Œä¸ºç›‘æ§ï¼šæœ‰ä¸°å¯Œçš„æ—¥å¿—åŠŸèƒ½è®°å½•æµé‡ä½¿ç”¨æƒ…å†µï¼Œå¹¶å¯ä»¥è®°å½•æ¯ä¸ªç”¨æˆ·å…·ä½“çš„æ•°æ®é‡ã€æ´»åŠ¨è¿æ¥ã€æ¥æº IP ç­‰ç­‰ å®‰å…¨ï¼šæ”¯æŒå¤šè´¦å·ï¼Œæ”¯æŒç™½åå•ã€é»‘åå•ç­‰Softether å®¢æˆ·ç«¯è¿æ¥é€šç”¨æ–¹æ³•ä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦ VPN åŠŸèƒ½ï¼Œé€‰æ‹© L2TP/IPsec ç±»å‹ï¼š ä¸æ¨è Windows ä½¿ç”¨æ­¤æ–¹æ³• Windowsï¼šç³»ç»Ÿè®¾ç½® -&gt; ç½‘ç»œå’Œ Internet -&gt; VPN -&gt; æ·»åŠ  VPN Linuxï¼šç³»ç»Ÿè®¾ç½® -&gt; ç½‘ç»œ -&gt; VPN MacOSï¼šç³»ç»Ÿè®¾ç½® -&gt; ç½‘ç»œ -&gt; æ–°å»º -&gt; VPN ç§»åŠ¨è®¾å¤‡ï¼šç³»ç»Ÿè®¾ç½® -&gt; æœç´¢ VPNWindows æ¨èç›´æ¥ä½¿ç”¨å®˜æ–¹æä¾›çš„å›¾å½¢å®¢æˆ·ç«¯ ä½¿ç”¨é€šç”¨æ–¹æ³•ä¹‹åï¼Œå¦‚æœå‘ç°æ— æ³•æ­£å¸¸ä¸Šç½‘ï¼Œéœ€è¦ï¼š æ§åˆ¶é¢æ¿ -&gt; ç½‘ç»œå’Œ Internet -&gt; ç½‘ç»œè¿æ¥ é‡Œæ‰¾åˆ°åˆšåˆšçš„ç½‘ç»œé€‚é…å™¨ï¼ŒåŒå‡»ï¼Œç„¶åé€‰æ‹© å±æ€§ -&gt; ç½‘ç»œ -&gt; TCP/IPv4 -&gt; é«˜çº§ -&gt; å–æ¶ˆå‹¾é€‰â€œåœ¨è¿œç¨‹ç½‘ç»œä¸Šä½¿ç”¨é»˜è®¤ç½‘å…³â€Linuxå‘½ä»¤è¡Œè¿æ¥ å®˜ç½‘ä¸‹è½½ Linux å®¢æˆ·ç«¯ï¼ˆä¼¼ä¹åªæœ‰æºç åŒ…ï¼‰ è§£å‹åï¼Œè¿›å…¥ ./vpnclient ç›®å½•ï¼Œæ‰§è¡Œ makeï¼Œç¡®ä¿æ‰§è¡Œå®Œæˆåï¼Œç”Ÿæˆ vpnclient åŠ vpncmd ä¸¤ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ å¯åŠ¨ vpn æœåŠ¡ï¼šsudo ./vpnclient startï¼Œå¼ºçƒˆå»ºè®®ç›´æ¥ä½¿ç”¨ root æƒé™æ‰§è¡Œ é…ç½® vpnï¼š./vpncmd ä¾æ¬¡é€‰æ‹© client -&gt; localhost help å¯æŸ¥çœ‹æ‰€æœ‰å‘½ä»¤åˆ—è¡¨ AccountCreate åˆ›å»ºæ–°è¿æ¥ï¼Œå‚æ•°å’Œé™„ä»¶æŒ‡å—ä¸­ä¸€è‡´å³å¯ï¼Œæ³¨æ„è¿™ä¸€æ­¥éœ€è¦è¾“å…¥è™šæ‹Ÿç½‘å¡åç§°ï¼Œæ²¡æœ‰çš„è¯ä¸€èˆ¬ä¼šè‡ªåŠ¨åˆ›å»ºï¼Œå¦‚æœæ²¡æœ‰è‡ªåŠ¨åˆ›å»ºï¼Œé‚£ä¹ˆæ‰§è¡Œ NicXXXXX å‘½ä»¤æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªç½‘å¡ AccountPasswordSet è®¾ç½®è¿æ¥çš„å¯†ç  AccountConnect è¿æ¥å³å¯ é…ç½® IP åœ°å€ 4.3 ä¸­åˆ›å»ºçš„è™šæ‹Ÿç½‘å¡ååŠ ä¸Š vpn_ å‰ç¼€æ‰æ˜¯çœŸæ­£çš„è™šæ‹Ÿç½‘å¡åç§° sudo ifconfig è™šæ‹Ÿç½‘å¡å 10.1.1.XXX netmask 255.0.0.0 &lt;- æ³¨æ„ä¿®æ”¹ IP åœ°å€ sudo dhclient è™šæ‹Ÿç½‘å¡å &lt;- å¯èƒ½è¦æ‰§è¡Œå‡ åç§’ç”šè‡³ä¸€åˆ†é’Ÿï¼Œç­‰ç€å°±å¥½ è‡ªå¯åŠ¨ æ³¨æ„ä¿®æ”¹è‡ªå¯è„šæœ¬é‡Œçš„è¿æ¥åï¼šCONNECTIONã€è™šæ‹Ÿç½‘å¡å åŠ å›ºå®š IP åœ°å€ï¼ æ–°å»º /etc/init.d/vpnclient: #!/bin/sh # Start/stop the vpnclien daemon # ### BEGIN INIT INFO # Provides: vpnclient # Required-Start: $local_fs $syslog $time # Required-Stop: $local_fs $syslog $time # Should-Start: $network # Should-Stop: $network # Default-Start: 2 3 4 5 # Default-Stop: # Short-Description: vpn client service # Description: Softether vpn client service. ### END INIT INFO EXE_DIR=/opt/vpnclient/ SER=\"$EXE_DIR\"vpnclient CMD=\"$EXE_DIR\"vpncmd start() { echo start $SER start $CMD localhost /client /cmd accountconnect CONNECTION # &lt;======= è¿æ¥å ifconfig vpn_xxx 10.1.1.XXX netmask 255.0.0.0 # &lt;=============== æ³¨æ„ä¿®æ”¹ IP åœ°å€å’Œè™šæ‹Ÿç½‘å¡åç§° echo end } stop() { $SER stop } case \"$1\" in start) start ;; stop) stop ;; esac exit 0 sudo chmod 755 /etc/init.d/vpnclient sudo systemctl daemon-reload sudo systemctl enable vpnclient.service sudo systemctl start vpnclient.serviceGUIå‚è€ƒâ€œé€šç”¨æ–¹æ³•â€ã€‚å›ºå®š IP è®¾ç½® Windowsï¼šåœ¨ç½‘ç»œé€‚é…å™¨ä¸­ä¿®æ”¹ IP4 åœ°å€ Linuxï¼šå‘½ä»¤è¡Œä¿®æ”¹å¯¹åº”é€‚é…å™¨çš„ IP4 åœ°å€ MacOSï¼švpn é«˜çº§è®¾ç½®ä¸­ç›´æ¥æŒ‡å®š IP4 åœ°å€" }, { "title": "dde-grand-search æ’ä»¶å¼€å‘", "url": "/posts/dde-grand-search-plugin-Tutorial/", "categories": "å¼€å‘, Deepin", "tags": "Linux, Deepin", "date": "2022-04-01 14:44:05 +0800", "snippet": "æˆªæ­¢åˆ°ç›®å‰ 2022-04-01 ä¸ºæ­¢ï¼Œgithub ä¸Šæ²¡æœ‰æ”¾å‡º dde-grand-search çš„ä»£ç ä»“åº“ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡ apt source çš„æ–¹å¼ä¸‹è½½åˆ°å…¨éƒ¨ä»£ç ã€‚å› æ­¤ç›®å‰æ²¡æœ‰å®˜æ–¹æ–‡æ¡£å±•ç¤ºå…¶æ’ä»¶å¼€å‘è¿‡ç¨‹ï¼Œä½†æ˜¯å½“å‰ Deepin V20.5 ç‰ˆæœ¬ä¸‹ï¼Œdde-control-center çš„æœç´¢æ•ˆæœæ˜¯ä»¥æ’ä»¶å½¢å¼é›†æˆåˆ° dde-grand-search ä¸­çš„ï¼Œå› æ­¤å¯ä»¥å‚ç…§ dde-control-center ç›¸å…³éƒ¨åˆ†è¿›è¡Œæ¨¡ä»¿å¼€å‘ã€‚ dde-grand-search çš„æ’ä»¶æœºåˆ¶å¯èƒ½ä¼šéšç€ç‰ˆæœ¬å·å˜åŒ–è€Œå˜åŠ¨ï¼Œä½¿å¾—æœ¬ç¯‡å†…å®¹ä¸å†é€‚ç”¨ï¼Œæ­¤æ—¶éœ€è¦æŒ‰ç…§æœ¬ç¯‡æ€è·¯é‡æ–°æ¢³ç†æ’ä»¶å¼€å‘æ–¹æ³•ã€‚æ’ä»¶æ–‡ä»¶ç›®å½•æŒ‰ç…§è½¯ä»¶è®¾è®¡çš„åŸºæœ¬é€»è¾‘æ¨æ–­ï¼Œå†ç»“åˆ dde-dock ä¸­çš„æ’ä»¶æœºåˆ¶ï¼Œå¯ä»¥æ¨æµ‹å¾—åˆ° dde-grand-search æœ‰å¾ˆå¤§æ¦‚ç‡ä¹Ÿæ˜¯é€šè¿‡æ’ä»¶çš„æ–¹å¼è¿›è¡Œåç»­åŠŸèƒ½å¢åŠ çš„ï¼Œå°¤å…¶æ˜¯ç›®å‰ dde-grand-search çš„æœç´¢é¡¹ç›®å¤ªå°‘ï¼Œå‚è€ƒ MacOS çš„èšç„¦åŠŸèƒ½ï¼Œèƒ½å¤Ÿæƒ³è±¡åˆ°çš„åç»­æ‹“å±•åŠŸèƒ½å°±åŒ…æ‹¬ï¼šå­—å…¸ã€å‰ªè´´æ¿ã€é‚®ä»¶ä»¥åŠå…¶ä»–å„ç§ Deepin å…¨å®¶æ¡¶åŠŸèƒ½çš„é›†æˆã€‚å› æ­¤åªéœ€è¦ç¡®å®šæ’ä»¶ç›®å½•ä¸‹æœ‰å“ªäº›ä»¥åŠå­˜åœ¨çš„æ’ä»¶ï¼Œç„¶åå»çœ‹å¯¹åº”éƒ¨åˆ†çš„æºç å³å¯ã€‚æ’ä»¶ç›®å½•åœ¨æ²¡æœ‰å®˜æ–¹æ–‡æ¡£çš„æƒ…å†µä¸‹ï¼Œæœ€ç®€å•å¯é çš„æ–¹æ³•å°±æ˜¯é˜…è¯»æºç ï¼Œä¸è¿‡é¦–å…ˆéœ€è¦ç¡®ä¿ /etc/apt/sources.list ä¸­ deb-src ä¸€è¡Œæ²¡æœ‰è¢«æ³¨é‡Šæ‰ï¼šapt source dde-grand-searchè§£å‹ä»£ç ï¼ŒClion æ‰“å¼€é¡¹ç›®ç›®å½•ï¼Œé€šè¿‡æ–‡ä»¶ååˆ¤æ–­æ’ä»¶ç›¸å…³çš„ä¸»è¦ç±»ä¸º pluginmanager.cpp ä¸­çš„ PluginManagerPrivateï¼Œå…¶ä¸­çš„ defaultPath å³ä¸ºæ’ä»¶è·¯å¾„ã€‚ç„¶ååˆ©ç”¨ Clion çš„å…¨å±€æœç´¢åŠŸèƒ½ï¼Œå¯ä»¥æŸ¥åˆ°è·¯å¾„å®šä¹‰åœ¨ CMakeLists.txt ä¸­ã€‚æœ€ç»ˆå¾—åˆ°è·¯å¾„ï¼š/usr/lib/x86_64-linux-gnu/dde-grand-search-daemon/plugins/searcherï¼ŒåŒæ—¶å‘ç°å·²å­˜åœ¨ä¸€ä¸ªæ’ä»¶æ–‡ä»¶ï¼šcom.deepin.dde-grand-search.dde-control-center-setting.confï¼Œåç§°å¯çŸ¥æ˜¯è®¾ç½®ä¸­å¿ƒçš„æ’ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š[Grand Search]Name=com.deepin.dde-grand-search.dde-control-center-settingMode=TriggerDBusService=com.deepin.dde.ControlCenterDBusAddress=/com/deepin/dde/ControlCenterDBusInterface=com.deepin.dde.ControlCenter.GrandSearchInterfaceVersion=1.0æ˜¾ç„¶ï¼Œæ˜¯é€šè¿‡é…ç½®æ–‡ä»¶å‘Šè¯‰ dde-grand-search å¯¹åº”æ’ä»¶çš„ DBus Interface åœ°å€ï¼Œç„¶åç»Ÿä¸€è°ƒç”¨çš„ã€‚Mode è¿˜æœ‰å…¶å®ƒæ¨¡å¼ï¼Œç°åœ¨æ˜¯æœç´¢æ—¶è§¦å‘æ¨¡å¼ï¼Œå…¶å®ƒå¯ä»¥ç›´æ¥æœç´¢æºç ï¼Œå¯¹åº”æ–‡ä»¶ä¸­æœ‰ç€æ³¨é‡Šã€‚æ¥å£åŠæ•°æ®æ ¼å¼ç”±ä¸Šä¸€èŠ‚å¯çŸ¥ï¼Œå®ç°æ’ä»¶éœ€è¦ä¸¤æ­¥ï¼š é…ç½®æ–‡ä»¶å‘Šè¯‰ dde-grand-search æ’ä»¶çš„ DBus æ¥å£ å®ç°é…ç½®æ–‡ä»¶ä¸­çš„æ¥å£ä½†æ˜¯éœ€è¦å®ç°å“ªäº›å…·ä½“æ¥å£ï¼Œåœ¨æ²¡æœ‰å®˜æ–¹æ–‡æ¡£çš„æƒ…å†µä¸‹ï¼Œç›´æ¥å‚ç…§ dde-control-center çš„æºç ï¼Œåœ¨å®˜æ–¹ github ä»“åº“é‡Œç®€å•çš„æœç´¢ GrandSearch å…³é”®è¯ï¼Œå³å¯å¿«é€Ÿå®šä½åˆ°ç›¸å…³å†…å®¹ï¼Œä¸»è¦å…³é”®æ–‡ä»¶å¦‚ä¸‹ï¼š src/frame/dbuscontrolcenterservice.h src/frame/dbuscontrolcenterservice.cpp src/frame/window/mainwindow.cppé˜…è¯»æºç åï¼Œå¯ä»¥å‘ç°å‡ ä¸ªå…³é”®çš„ DBus æ¥å£ï¼šclass DBusControlCenterGrandSearchService: public QDBusAbstractAdaptor{/* ... */public Q_SLOTS: // METHODS // dde-grand-search è¾“å…¥æ—¶ï¼Œè°ƒç”¨è¯¥æ¥å£è·å–æœç´¢ç»“æœ QString Search(const QString json); bool Stop(const QString json); // æœç´¢ç»“æœè¢«ç‚¹å‡»æ—¶ï¼Œè°ƒç”¨è¯¥æ¥å£è¿›è¡Œå“åº” bool Action(const QString json);/* ... */æ¥ç€åªéœ€æ˜ç¡®è¾“å…¥çš„ json å’Œè¿”å›çš„ QString å…·ä½“æ ¼å¼å³å¯ï¼Œå‚è§ MainWindow::GrandSearchSearch()ã€‚ ä»¥ä¸‹åˆ—å‡ºçš„æ•°æ®ç»“æ„ä¸å…¨ï¼Œä»…åˆ—å‡ºäº†å…³é”®çš„éƒ¨åˆ†ï¼Œæ›´ä¸ºè¯¦ç»†çš„éœ€è¦ç¿»é˜… dde-grand-search æºç Search{ \"ver\": \"åº”è¯¥æ˜¯ç‰ˆæœ¬å·ï¼Œå…·ä½“ç±»å‹éœ€è¦çœ‹ä»£ç \", \"mID\": \"æ¨æµ‹ç”¨æ¥æ ‡è®°æ’ä»¶æœç´¢è¯·æ±‚çš„ï¼Œå…·ä½“ç±»å‹çœ‹ä»£ç \", \"cont\": \"æœç´¢å…³é”®è¯\"}{ \"ver\": \"ç›´æ¥ä½¿ç”¨è¾“å…¥çš„ ver\", \"mID\": \"ç›´æ¥ä½¿ç”¨è¾“å…¥çš„ mID\", \"cont\": [ { \"group\": \"dde-grand-search æ˜¾ç¤ºç»“æœæ—¶çš„ç»„åç§°\", \"items\": [ { \"item\": \"æœç´¢ç»“æœ QStringï¼Œè§¦å‘æ—¶å°†ä½œä¸ºä¼ é€’ç»™ Action æ¥å£çš„å‚æ•°\", \"name\": \"æœç´¢ç»“æœæ˜¾ç¤ºå‡ºçš„å­—ç¬¦ä¸²ï¼Œå¯ä»¥å’Œ item ä¸ä¸€æ ·\", \"icon\": \"æœç´¢ç»“æœæ¡ç›®å›¾æ ‡è·¯å¾„\", \"type\": \"ç±»å‹ï¼Œç›®å‰æ¥çœ‹å¥½åƒæ²¡æœ‰ä»€ä¹ˆä½œç”¨\" }, /* å¯ä»¥æœ‰å¤šä¸ªæœç´¢ç»“æœ */ ] } ]}Stopè¯¥éƒ¨åˆ†æ­¤å¤„ä¸æ¶‰åŠï¼Œè·³è¿‡ã€‚Action{ \"action\": \"åŠ¨ä½œç±»å‹ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨ openitem ç±»å‹ï¼Œè¡¨ç¤ºåŒå‡»äº†æœç´¢ç»“æœ\", \"item\": \"é€‰ä¸­æœç´¢ç»“æœçš„ item å±æ€§ï¼Œå’Œ Search çš„è¿”å›ç»“æœä¸­çš„ item å¯¹åº”\"}ä¾‹å­ï¼š`dde-top-panel`æ”¯æŒæœç´¢èœå• é¡¹ç›®åœ°å€ï¼šhttps://github.com/SeptemberHX/dde-top-panel/tree/dde-grand-searchæ’ä»¶é…ç½®æ–‡ä»¶æ–°å»ºæ–‡ä»¶ /usr/lib/x86_64-linux-gnu/dde-grand-search-daemon/plugins/searcher/com.deepin.dde-grand-search.dde-top-panel-setting.confï¼š[Grand Search]Name=com.deepin.dde-grand-search.dde-top-panel-settingMode=TriggerDBusService=com.septemberhx.dde.TopPanelDBusAddress=/com/septemberhx/dde/TopPanelDBusInterface=com.septemberhx.dde.TopPanel.GrandSearchInterfaceVersion=1.0`DBus` æ¥å£å®ç° DBus æ³¨å†Œç­‰åŸºç¡€éƒ¨åˆ†ä¸åŒ…å«åœ¨ä¸‹é¢QString DBusTopPanelService::Search(const QString json) { //è§£æè¾“å…¥çš„jsonå€¼ QJsonDocument jsonDocument = QJsonDocument::fromJson(json.toLocal8Bit().data()); if(!jsonDocument.isNull()) { QJsonObject jsonObject = jsonDocument.object(); QJsonObject jsonResults; QJsonArray items; // è°ƒç”¨å…·ä½“æ–¹æ³•è·å–èœå•æœç´¢ç»“æœ QStringList searchResult = this-&gt;parent()-&gt;GrandSearchSearch(jsonObject.value(\"cont\").toString()); // å°†æœç´¢ç»“æœæ‹¼æ¥æˆ json æ ¼å¼ for (int i = 0; i &lt; searchResult.length(); i++) { QJsonObject jsonObj; jsonObj.insert(\"item\", searchResult[i]); // å»æ‰ &amp; ç¬¦å·ï¼Œå¦åˆ™å½±å“æœç´¢ç»“æœæ˜¾ç¤ºçš„è§‚æ„Ÿ jsonObj.insert(\"name\", searchResult[i].remove('&amp;')); jsonObj.insert(\"icon\", \"menu\"); jsonObj.insert(\"type\", \"application/x-dde-top-panel-xx\"); items.insert(i, jsonObj); } QJsonObject objCont; objCont.insert(\"group\", \"TopPanel\"); objCont.insert(\"items\", items); QJsonArray arrConts; arrConts.insert(0, objCont); jsonResults.insert(\"ver\", jsonObject.value(\"ver\")); jsonResults.insert(\"mID\", jsonObject.value(\"mID\")); jsonResults.insert(\"cont\", arrConts); QJsonDocument document; document.setObject(jsonResults); return document.toJson(QJsonDocument::Compact); } return QString();}bool DBusTopPanelService::Stop(const QString json) { return true;}bool DBusTopPanelService::Action(const QString json) { QString searchName; QJsonDocument jsonDocument = QJsonDocument::fromJson(json.toLocal8Bit().data()); if(!jsonDocument.isNull()) { QJsonObject jsonObject = jsonDocument.object(); if (jsonObject.value(\"action\") == \"openitem\") { // æ‰“å¼€ item çš„æ“ä½œ searchName = jsonObject.value(\"item\").toString(); // è°ƒç”¨ç»“æ„æ‰§è¡Œ return this-&gt;parent()-&gt;GrandSearchAction(searchName); } } return false;}å®ç°æ•ˆæœ" }, { "title": "å¼ºåŒ–å­¦ä¹ ç¬¬äºŒç‰ˆå¯¼å›¾ï¼ˆä¸‰ï¼‰ï¼šPlanning", "url": "/posts/RL-MindMap-3/", "categories": "å­¦ä¹ , Reinforcement Learning", "tags": "å¼ºåŒ–å­¦ä¹ , æ€ç»´å¯¼å›¾", "date": "2022-03-28 22:04:43 +0800", "snippet": "æœ¬ç³»åˆ—ä¸º Sutton &amp; Barto -ã€ŠReinforcement Learning: An Introduction 2nd Editionã€‹çš„ä¸ªäººè¯»åæ€ç»´å¯¼å›¾è®°å½•ï¼Œä¾¿äºåç»­å¿«é€Ÿå¤ä¹ åŠå›å¿†ï¼Œæœ¬ç« å¯¹åº”åŸæ–‡çš„ç¬¬ 8 ç« ã€‚åŸä¹¦åœ°å€ï¼šincompleteideas.netï¼Œå³é”®æ–°æ ‡ç­¾æŸ¥çœ‹å›¾ç‰‡åŸå›¾ã€‚" }, { "title": "å¸¸ç”¨ shell å‘½ä»¤", "url": "/posts/DailyShellCommands/", "categories": "æ‰‹å†Œ, Linux", "tags": "Linux, shell", "date": "2022-03-21 21:17:17 +0800", "snippet": "Kubernetes# 0. Ubuntu 20.04 ä¸€é”®å®‰è£… kubectl kubeadm etcd ç­‰ kubernetes ç›¸å…³å†…å®¹sh -c \"$(curl -fsSL https://raw.githubusercontent.com/SeptemberHX/scripts/master/one-key-k8s-ubuntu.sh)\"# 1. æ¸…ç†å‘½åç©ºé—´ hx-test ä¸‹æ‰€æœ‰åç§°å«æœ‰ service çš„ podkubectl get pods -n hx-test | grep service | awk -F ' ' '{print $1}' | xargs kubectl delete pods -n hx-test# 2. å…è®¸ master èŠ‚ç‚¹è¿è¡Œ podkubectl describe node t0 | grep Taints # æŸ¥çœ‹ taintskubectl taint node t0 node-role.kubernetes.io/master:NoSchedule- # å–æ¶ˆ NoSchedule# 3. ç»™ node æ‰“æ ‡ç­¾kubectl label nodes t0 node=node0 # ç»™èŠ‚ç‚¹ t0 æ‰“ä¸Šæ ‡ç­¾ï¼šnode=node0kubectl get nodes --show-labels # æŸ¥çœ‹èŠ‚ç‚¹æ ‡ç­¾# 4. token è¿‡æœŸåè¿˜éœ€è¦æ·»åŠ æ–°èŠ‚ç‚¹kubeadm token create --print-join-commandDocker# 1. ç»™ç”¨æˆ· user æ“ä½œ docker æƒé™sudo usermod -aG docker user# 2. æ‰§è¡Œä¸€ä¸ªè¿è¡Œä¸­å®¹å™¨ 0e45245944d4 çš„ bashdocker exec -it 0e45245944d4 /bin/bash# 3. åˆ é™¤åŒ…å« service çš„é•œåƒdocker image list | grep service | awk -F ' ' '{print $1}' | xargs docker image rm# 4. åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„ volumeï¼Œimageã€container ç±»ä¼¼docker volume pruneNvidia# 1. åˆ—å‡ºæ‰€æœ‰æ­£åœ¨ä½¿ç”¨ NVIDIA GPU çš„è¿›ç¨‹ä¿¡æ¯nvidia-smi | grep -A 100 \"PID\" | tail -n +3 | sed '$d' | grep -v 'No' | grep -v 'N/A' | awk -F ' ' '{print $3}' | xargs --no-run-if-empty ps -uxæ—¥å¿—# 1. è·å–æŒ‡å®š service çš„æ—¥å¿—sudo journalctl -u emby-server.service" }, { "title": "å¼ºåŒ–å­¦ä¹ ç¬¬äºŒç‰ˆå¯¼å›¾ï¼ˆäºŒï¼‰ï¼šæ—¶åºå·®åˆ†åŠBootstrapping", "url": "/posts/RL-MindMap-2/", "categories": "å­¦ä¹ , Reinforcement Learning", "tags": "å¼ºåŒ–å­¦ä¹ , æ€ç»´å¯¼å›¾", "date": "2022-03-18 13:00:29 +0800", "snippet": "æœ¬ç³»åˆ—ä¸º Sutton &amp; Barto -ã€ŠReinforcement Learning: An Introduction 2nd Editionã€‹çš„ä¸ªäººè¯»åæ€ç»´å¯¼å›¾è®°å½•ï¼Œä¾¿äºåç»­å¿«é€Ÿå¤ä¹ åŠå›å¿†ï¼Œæœ¬ç« å¯¹åº”åŸæ–‡çš„ç¬¬6-7ç« ã€‚åŸä¹¦åœ°å€ï¼šincompleteideas.netï¼Œå³é”®æ–°æ ‡ç­¾æŸ¥çœ‹å›¾ç‰‡åŸå›¾ã€‚" }, { "title": "Kubernetes é›†ç¾¤æ­å»º", "url": "/posts/K8sClusterTutorial/", "categories": "", "tags": "Linux, Kubernetes", "date": "2022-03-15 17:57:19 +0800", "snippet": " å¯ä»¥çœ‹çœ‹ Kubernetes å®è·µæŒ‡å—k8s æ­å»ºæµç¨‹åŸºç¡€å·¥å…·åŠ k8s å®‰è£…CentOSyum install git -ygit clone https://github.com/SeptemberHX/scripts.gitcd scripts./basic_utils.shgit clone https://github.com/SeptemberHX/scripts.git # æ³¨æ„ç‰ˆæœ¬å·æ ¼å¼./k8s_install.sh 1.13.1-0Ubuntush -c \"$(curl -fsSL https://raw.githubusercontent.com/SeptemberHX/scripts/master/one-key-k8s-ubuntu.sh)\"åˆå§‹åŒ– master èŠ‚ç‚¹kubeadm init --pod-network-cidr=10.244.0.0/16 --kubernetes-version=v1.13.1 --apiserver-advertise-address=IPgcr.io æ— æ³•è®¿é—®æ—¶ï¼Œæ‹‰å– k8s é•œåƒçš„æ›¿ä»£æ–¹æ¡ˆ./k8s_gxrcio.sh v1.13.1 # æ³¨æ„ç‰ˆæœ¬å·æ ¼å¼å®‰è£… flannelkubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.ymlå¼€æ”¾ http api ä»¥å…è®¸å¤–éƒ¨æ“ä½œé›†ç¾¤å®˜ç½‘æ–‡æ¡£æ¨èä½¿ç”¨ kubectl proxyï¼Œä»å®‰å…¨å› ç´ è€ƒé‡kubectl proxy --port=8082 --address='0.0.0.0' --accept-hosts='^*$' &amp;æ³¨æ„ --accept-hosts ï¼Œå¦åˆ™å¯èƒ½å‡ºç° forbidden é”™è¯¯ã€‚é—®é¢˜kubelet isn't running or healthyåŸé—®é¢˜é“¾æ¥ï¼šhttps://stackoverflow.com/questions/52119985/kubeadm-init-shows-kubelet-isnt-running-or-healthyè§£å†³ï¼š/etc/docker/daemon.json æ–‡ä»¶ä¸­æ·»åŠ ä¸€ä¸‹å†…å®¹ï¼š{ \"exec-opts\": [\"native.cgroupdriver=systemd\"]}ä¹‹åæ‰§è¡Œå‘½ä»¤ï¼šsudo systemctl daemon-reloadsudo systemctl restart dockersudo systemctl restart kubeletnetwork plugin is not ready: cni config uninitializedå…·ä½“å½±å“ï¼šæ¯ä¸ªèŠ‚ç‚¹çŠ¶æ€æ°¸è¿œæ˜¯ NotReadyï¼Œæ— æ³•è¿›è¡Œå®¹å™¨è°ƒåº¦è§£å†³ï¼škubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.ymlåŸé—®é¢˜é“¾æ¥ï¼šgithub issueæˆ–è€…è¯•ä¸€è¯•ï¼šmkdir /etc/cni/net.dswapkubeadm æ·»åŠ å‚æ•°ï¼š--ignore-preflight-errors Swapkubelet å‚æ•°é…ç½®ï¼š/etc/sysconfig/kubelet ï¼š --fail-swap-on=falseæœ‰æ—¶ /etc/sysconfig/kubelet ä¸å¥½ä½¿æ—¶ï¼Œå¯ä»¥å°†å‚æ•°åŠ åœ¨ /var/lib/kubelet/kubeadm-flags.envKUBELET_EXTRA_ARGS=\"--runtime-cgroups=/systemd/system.slice --kubelet-cgroups=/systemd/system.slice --fail-swap-on=false\"è¾“å‡º pod node status åˆ—è¡¨ï¼škubectl get pod -o=custom-columns=NAME:.metadata.name,STATUS:.status.phase,NODE:.spec.nodeName --all-namespaceskubeadm CPU æ ¸å¿ƒéœ€æ±‚kubeadm the number of available cpus 1 is less than the required 2å®ƒæœ‰é…ç½®è¦æ±‚ï¼š 2 CPUs or more 2 GB or more of RAM per machine (any less will leave little room for your apps) Swap disabled. You MUST disable swap in order for the kubelet to work properly.èŠ‚ç‚¹åŠ å…¥å NotReadykubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.ymlæˆ–è€…mkdir /etc/cni/net.d -psystemctl restart kubeletæœ‰æ—¶ /etc/sysconfig/kubelet ä¸å¥½ä½¿æ—¶ï¼Œå¯ä»¥å°†å‚æ•°åŠ åœ¨ /var/lib/kubelet/kubeadm-flags.envé—®é¢˜ issueï¼šgithub issueFlanneléœ€è¦åœ¨ kubeadm init æ—¶æŒ‡å®š --pod-network-cidr=10.244.0.0/16å®¹å™¨ä¸€ç›´å¤„äºåˆ›å»ºçŠ¶æ€æŸ¥çœ‹ systemctl status kubelet ï¼Œå‘ç°ï¼š Failed to get system container stats for \"/system.slice/docker.service\": failed to get cgroup stats for \"/system.slice/docker.service\": failed toåœ¨ /etc/sysconfig/kubelet ä¸­æ·»åŠ ï¼šKUBELET_EXTRA_ARGS=\"--runtime-cgroups=/systemd/system.slice --kubelet-cgroups=/systemd/system.slice\"Issue é“¾æ¥ï¼šgithub issueé˜¿é‡Œäº‘æ²¡æœ‰å…¬ç½‘ipï¼Œmaster ä¸Šåªçœ‹è§å®ƒçš„å±€åŸŸç½‘ipï¼šæ— è§£åˆ›å»ºå…¬ç½‘ipï¼šifconfig eth0:0 IPç„¶ååœ¨ /etc/sysconfig/kubelet ä¸­çš„ KUBELET_EXTRA_ARGS æ·»åŠ  --node-ip=IP å³å¯å¸¸ç”¨å‘½ä»¤åˆå§‹åŒ–kubeadm init --pod-network-cidr=10.244.0.0/16 --kubernetes-version=v1.13.1 --apiserver-advertise-address=IPå®‰è£… flannelkubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.ymlå®‰è£… weave scopekubectl apply -f \"https://cloud.weave.works/k8s/scope.yaml?k8s-version=$(kubectl version | base64 | tr -d '\\n')\"weave scope å¼€æ”¾ç«¯å£ï¼ŒåŠ ssh éš§é“kubectl port-forward -n weave \"$(kubectl get -n weave pod --selector=weave-scope-component=app -o jsonpath='{.items..metadata.name}')\" 4040ssh -N -L 0.0.0.0:4041:localhost:4040 root@IP -p 22è¿è¡Œ master èŠ‚ç‚¹è¿è¡Œ podkubectl describe node t0 | grep Taints # æŸ¥çœ‹ taintskubectl taint node t0 node-role.kubernetes.io/master:NoSchedule- # å–æ¶ˆ NoScheduleç»™èŠ‚ç‚¹æ‰“æ ‡ç­¾kubectl label nodes t0 node=node0 # ç»™èŠ‚ç‚¹ t0 æ‰“ä¸Šæ ‡ç­¾ï¼šnode=node0kubectl get nodes --show-labels # æŸ¥çœ‹èŠ‚ç‚¹æ ‡ç­¾æ¸…ç† cniï¼šifconfig cni0 downip link delete flannel.1brctl delbr cni0æ³¨æ„ kubeadm reset åè¿˜ä¸å¤Ÿï¼Œè¿˜éœ€è¦æ¸…ç† network interface: cni0 å’Œ flannel.1ï¼Œå¦åˆ™å¯èƒ½å‡ºç°æ— æ³•è§£æåœ°å€ç«¯å£é˜²ç«å¢™æ–¹é¢éœ€è¦æ”¾è¡Œï¼Œå…·ä½“å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šPorts and Protocols Kubernetes" }, { "title": "æ»´ç­”æ¸…å•ç½‘é¡µç‰ˆ API è®°å½•", "url": "/posts/DiDaWebAPI/", "categories": "", "tags": "", "date": "2022-02-23 00:00:00 +0800", "snippet": " å®˜æ–¹å·²æ›´æ–° API æ–‡æ¡£ï¼Œç›´æ¥æŸ¥è¯¢å®˜æ–¹å³å¯ï¼šTickTick Developerå› ä¸ºè®¡ç®—æœºæ˜¯æˆ‘æ¯å¤©å­¦ä¹ å·¥ä½œçš„ä¸»åŠ›ï¼Œæœ‰æ—¶å€™æƒ³åœ¨æ¸…ç†æ»´ç­”æ¸…å•ä»»åŠ¡çš„æ—¶å€™è®¡æ—¶ï¼Œä½†åˆå‘ç°æ»´ç­”æ¸…å•æ²¡æœ‰è®¡æ—¶åŠŸèƒ½ï¼Œæ‰€ä»¥æƒ³ç€åç»­æœ‰æ—¶é—´ç”¨æ»´ç­”æ¸…å•çš„ API å†™ä¸ªç®€å•çš„è®¡æ—¶åŠŸèƒ½ï¼Œè¿™æ ·å¯ä»¥ç›´æ¥é›†æˆä¸ç”¨é€  todolist çš„è½®å­äº†ã€‚ä»¥ä¸‹æ˜¯åœ¨ç ”ç©¶æ»´ç­”æ¸…å•ç½‘é¡µç‰ˆæ—¶å‘ç°çš„ä¸€äº› APIã€‚ç›®å‰å®˜ç½‘æœ‰æ„æ„¿æ”¾å‡º API æ–‡æ¡£ï¼Œä½†æ˜¯ç›®å‰åªæœ‰ä¸€ä¸ªç®€é™‹çš„æ—§ç‰ˆæœ¬æ–‡æ¡£ï¼Œæ‰€ä»¥åªèƒ½è‡ªå·±åŠ¨æ‰‹äº†ã€‚åŸºæœ¬è¯´æ˜ éå®˜æ–¹ï¼Œéšæ—¶å¯èƒ½ä¼šå¤±æ•ˆï¼ä¸šåŠ¡é€»è¾‘cookie è®¾ç½® è¯·æ±‚å¤´ä¸­ cookie éœ€è¦åŒ…å« t=xxxxx å­—æ®µï¼Œå¦åˆ™éƒ¨åˆ†è¯·æ±‚ä¼šå‡ºç° 500 é”™è¯¯ç­‰ xxxxx ä¸ºç™»å½•APIè¿”å›çš„tokenå­—æ®µçš„å€¼API åˆ—è¡¨SignOn åœ°å€ï¼šhttps://api.dida365.com/api/v2/user/signon?wc=true&amp;remember=true ç±»å‹ï¼šPOST å…³é”® Headersï¼š x-deviceï¼šé€šè¿‡è°ƒè¯•å·¥å…·åœ¨ç½‘é¡µç‰ˆæ»´ç­”æ¸…å•ä¸Šè·å– bodyï¼š { \"password\": \"å¯†ç \", \"username\": \"é‚®ç®±\"} è¿”å›å€¼ï¼š { \"token\": \"cookieéœ€è¦è¿™ä¸ªä¸œè¥¿\", \"userId\": \"xxxxx\", \"username\": \"xxxx\", \"proStartDate\": \"2018-12-13T11:24:50.000+0000\", \"proEndDate\": \"2022-12-13T12:41:14.000+0000\", \"subscribeType\": \"order\", \"needSubscribe\": true, \"inboxId\": \"xxxx\", \"teamUser\": false, \"activeTeamUser\": false, \"freeTrial\": false, \"pro\": true, \"ds\": false} WebSocket åœ°å€ï¼šwss://wss.dida365.com/web è¯´æ˜ï¼šæ¥æ”¶æ¥è‡ªæœåŠ¡å™¨çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ä»»åŠ¡æ›´æ–°ç­‰ æ¶ˆæ¯ï¼š åˆšè¿æ¥æ—¶ä¼šè¿”å›ä¸€ä¸ª tokenï¼Œç”¨äº PushRegister ä¸­ä¸ websocket å»ºç«‹æ¶ˆæ¯è¿æ¥ éœ€è¦å®šæœŸå‘æœåŠ¡ç«¯å‘é€å¿ƒè·³åŒ…ï¼šwebç‰ˆæœ¬æ˜¯æ¯9åˆ†é’Ÿå‘é€ hello å­—ç¬¦ä¸² æœåŠ¡ç«¯å‘ç”Ÿæ›´æ–°æ—¶ï¼Œä¼šä¸»åŠ¨å‘é€ä¸€ä¸ª checkPointID ç”¨äºBatchCheckè·å–å˜åŒ– PushRegister åœ°å€ï¼šhttps://api.dida365.com/api/v2/push/register ç±»å‹ï¼šPOST bodyï¼š { \"pushToken\": \"WebSocketè¿”å›çš„token\", \"osType\": 41} BatchCheck åœ°å€ï¼šhttps://api.dida365.com/api/v2/batch/check/{checkPointID} ç±»å‹ï¼šGET å‚æ•°ï¼š checkPointIDï¼š 0ï¼šè·å–å…¨éƒ¨ WebSocket ä¸­æä¾›çš„ IDï¼šè·å–ç›¸è¾ƒäºä¸Šä¸€ä¸ª checkPoint çš„æ›´æ–°å†…å®¹ è¿”å›å€¼ï¼š { \"checkPoint\": 1646973127626, // å½“å‰çš„ checkPointID \"syncTaskBean\": { \t\"update\": [ \t\t{ \t\t\t\"id\": \"ä»»åŠ¡ID\", \t\t\t\"projectId\": \"projectId\", ...\t\t\t} ],\t\t\"delete\": [],\t\t\"add\": [] },\t\"projectProfiles\": null,\t\"projectGroups\": [ // é¡¹ç›®æè¿° ... ], \"filters\": null, \"tags\": [], // tag æè¿°\t\"inboxId\": null // checkPointId ä¸º 0 æ—¶å€¼ä¸ºé nullï¼Œè¡¨ç¤ºæ”¶ä»¶ç®± Idï¼Œä¸å…¶ä»–çš„ Project åŒºåˆ†} " }, { "title": "ã€è½¬è½½ã€‘Async IO in Python: A Complete Walkthrough", "url": "/posts/Repost-Async-IO-in-Python-A-Complete-Walkthrough/", "categories": "", "tags": "Python, è½¬è½½", "date": "2021-09-12 00:57:57 +0800", "snippet": "Async IO is a concurrent programming design that has received dedicated support in Python, evolving rapidly from Python 3.4 through 3.7, and probably beyond.You may be thinking with dread, â€œConcurrency, parallelism, threading, multiprocessing. Thatâ€™s a lot to grasp already. Where does async IO fit in?â€This tutorial is built to help you answer that question, giving you a firmer grasp of Pythonâ€™s approach to async IO.Hereâ€™s what youâ€™ll cover: Asynchronous IO (async IO): a language-agnostic paradigm (model) that has implementations across a host of programming languages async/await: two new Python keywords that are used to define coroutines asyncio: the Python package that provides a foundation and API for running and managing coroutinesCoroutines (specialized generator functions) are the heart of async IO in Python, and weâ€™ll dive into them later on. Note: In this article, I use the term async IO to denote the language-agnostic design of asynchronous IO, while asyncio refers to the Python package.Before you get started, youâ€™ll need to make sure youâ€™re set up to use asyncio and other libraries found in this tutorial.Setting Up Your EnvironmentYouâ€™ll need Python 3.7 or above to follow this article in its entirety, as well as the aiohttp and aiofiles packages:$ python3.7 -m venv ./py37async$ source ./py37async/bin/activate # Windows: .\\py37async\\Scripts\\activate.bat$ pip install --upgrade pip aiohttp aiofiles # Optional: aiodnsFor help with installing Python 3.7 and setting up a virtual environment, check out Python 3 Installation &amp; Setup Guide or Virtual Environments Primer.With that, letâ€™s jump in.The 10,000-Foot View of Async IOAsync IO is a bit lesser known than its tried-and-true cousins, multiprocessing and threading. This section will give you a fuller picture of what async IO is and how it fits into its surrounding landscape.Where Does Async IO Fit In?Concurrency and parallelism are expansive subjects that are not easy to wade into. While this article focuses on async IO and its implementation in Python, itâ€™s worth taking a minute to compare async IO to its counterparts in order to have context about how async IO fits into the larger, sometimes dizzying puzzle. Parallelism consists of performing multiple operations at the same time. Multiprocessing is a means to effect parallelism, and it entails spreading tasks over a computerâ€™s central processing units (CPUs, or cores). Multiprocessing is well-suited for CPU-bound tasks: tightly bound for loops and mathematical computations usually fall into this category. Concurrency is a slightly broader term than parallelism. It suggests that multiple tasks have the ability to run in an overlapping manner. (Thereâ€™s a saying that concurrency does not imply parallelism.) Threading is a concurrent execution model whereby multiple threads take turns executing tasks. One process can contain multiple threads. Python has a complicated relationship with threading thanks to its GIL, but thatâ€™s beyond the scope of this article. Whatâ€™s important to know about threading is that itâ€™s better for IO-bound tasks. While a CPU-bound task is characterized by the computerâ€™s cores continually working hard from start to finish, an IO-bound job is dominated by a lot of waiting on input/output to complete.To recap the above, concurrency encompasses both multiprocessing (ideal for CPU-bound tasks) and threading (suited for IO-bound tasks). Multiprocessing is a form of parallelism, with parallelism being a specific type (subset) of concurrency. The Python standard library has offered longstanding support for both of these through its multiprocessing, threading, and concurrent.futures packages.Now itâ€™s time to bring a new member to the mix. Over the last few years, a separate design has been more comprehensively built into CPython: asynchronous IO, enabled through the standard libraryâ€™s asyncio package and the new async and await language keywords. To be clear, async IO is not a newly invented concept, and it has existed or is being built into other languages and runtime environments, such as Go, C#, or Scala.The asyncio package is billed by the Python documentation as a library to write concurrent code. However, async IO is not threading, nor is it multiprocessing. It is not built on top of either of these.In fact, **async IO is a single-threaded, single-process design**: it uses cooperative multitasking, a term that youâ€™ll flesh out by the end of this tutorial. It has been said in other words that async IO gives a feeling of concurrency despite using a single thread in a single process. Coroutines (a central feature of async IO) can be scheduled concurrently, but they are not inherently concurrent.To reiterate, async IO is a style of concurrent programming, but it is not parallelism. Itâ€™s more closely aligned with threading than with multiprocessing but is very much distinct from both of these and is a standalone member in concurrencyâ€™s bag of tricks.That leaves one more term. What does it mean for something to be asynchronous? This isnâ€™t a rigorous definition, but for our purposes here, I can think of two properties: Asynchronous routines are able to â€œpauseâ€ while waiting on their ultimate result and let other routines run in the meantime. Asynchronous code, through the mechanism above, facilitates concurrent execution. To put it differently, asynchronous code gives the look and feel of concurrency.Hereâ€™s a diagram to put it all together. The white terms represent concepts, and the green terms represent ways in which they are implemented or effected:Iâ€™ll stop there on the comparisons between concurrent programming models. This tutorial is focused on the subcomponent that is async IO, how to use it, and the APIs that have sprung up around it. For a thorough exploration of threading versus multiprocessing versus async IO, pause here and check out Jim Andersonâ€™s overview of concurrency in Python. Jim is way funnier than me and has sat in more meetings than me, to boot.Async IO ExplainedAsync IO may at first seem counterintuitive and paradoxical. How does something that facilitates concurrent code use a single thread and a single CPU core? Iâ€™ve never been very good at conjuring up examples, so Iâ€™d like to paraphrase one from Miguel Grinbergâ€™s 2017 PyCon talk, which explains everything quite beautifully: Chess master Judit PolgÃ¡r hosts a chess exhibition in which she plays multiple amateur players. She has two ways of conducting the exhibition: synchronously and asynchronously. Assumptions: 24 opponents Judit makes each chess move in 5 seconds Opponents each take 55 seconds to make a move Games average 30 pair-moves (60 moves total) Synchronous version: Judit plays one game at a time, never two at the same time, until the game is complete. Each game takes (55 + 5) * 30 == 1800 seconds, or 30 minutes. The entire exhibition takes 24 * 30 == 720 minutes, or 12 hours. Asynchronous version: Judit moves from table to table, making one move at each table. She leaves the table and lets the opponent make their next move during the wait time. One move on all 24 games takes Judit 24 * 5 == 120 seconds, or 2 minutes. The entire exhibition is now cut down to 120 * 30 == 3600 seconds, or just 1 hour. (Source)There is only one Judit PolgÃ¡r, who has only two hands and makes only one move at a time by herself. But playing asynchronously cuts the exhibition time down from 12 hours to one. So, cooperative multitasking is a fancy way of saying that a programâ€™s event loop (more on that later) communicates with multiple tasks to let each take turns running at the optimal time.Async IO takes long waiting periods in which functions would otherwise be blocking and allows other functions to run during that downtime. (A function that blocks effectively forbids others from running from the time that it starts until the time that it returns.)Async IO Is Not EasyIâ€™ve heard it said, â€œUse async IO when you can; use threading when you must.â€ The truth is that building durable multithreaded code can be hard and error-prone. Async IO avoids some of the potential speedbumps that you might otherwise encounter with a threaded design.But thatâ€™s not to say that async IO in Python is easy. Be warned: when you venture a bit below the surface level, async programming can be difficult too! Pythonâ€™s async model is built around concepts such as callbacks, events, transports, protocols, and futuresâ€”just the terminology can be intimidating. The fact that its API has been changing continually makes it no easier.Luckily, asyncio has matured to a point where most of its features are no longer provisional, while its documentation has received a huge overhaul and some quality resources on the subject are starting to emerge as well.The asyncio Package and async/awaitNow that you have some background on async IO as a design, letâ€™s explore Pythonâ€™s implementation. Pythonâ€™s asyncio package (introduced in Python 3.4) and its two keywords, async and await, serve different purposes but come together to help you declare, build, execute, and manage asynchronous code.The async/await Syntax and Native Coroutines A Word of Caution: Be careful what you read out there on the Internet. Pythonâ€™s async IO API has evolved rapidly from Python 3.4 to Python 3.7. Some old patterns are no longer used, and some things that were at first disallowed are now allowed through new introductions.At the heart of async IO are coroutines. A coroutine is a specialized version of a Python generator function. Letâ€™s start with a baseline definition and then build off of it as you progress here: a coroutine is a function that can suspend its execution before reaching return, and it can indirectly pass control to another coroutine for some time.Later, youâ€™ll dive a lot deeper into how exactly the traditional generator is repurposed into a coroutine. For now, the easiest way to pick up how coroutines work is to start making some.Letâ€™s take the immersive approach and write some async IO code. This short program is the Hello World of async IO but goes a long way towards illustrating its core functionality:#!/usr/bin/env python3# countasync.pyimport asyncioasync def count(): print(\"One\") await asyncio.sleep(1) print(\"Two\")async def main(): await asyncio.gather(count(), count(), count())if __name__ == \"__main__\": import time s = time.perf_counter() asyncio.run(main()) elapsed = time.perf_counter() - s print(f\"{__file__} executed in {elapsed:0.2f} seconds.\")When you execute this file, take note of what looks different than if you were to define the functions with just def and time.sleep():$ python3 countasync.pyOneOneOneTwoTwoTwocountasync.py executed in 1.01 seconds.The order of this output is the heart of async IO. Talking to each of the calls to count() is a single event loop, or coordinator. When each task reaches await asyncio.sleep(1), the function yells up to the event loop and gives control back to it, saying, â€œIâ€™m going to be sleeping for 1 second. Go ahead and let something else meaningful be done in the meantime.â€Contrast this to the synchronous version:#!/usr/bin/env python3# countsync.pyimport timedef count(): print(\"One\") time.sleep(1) print(\"Two\")def main(): for _ in range(3): count()if __name__ == \"__main__\": s = time.perf_counter() main() elapsed = time.perf_counter() - s print(f\"{__file__} executed in {elapsed:0.2f} seconds.\")When executed, there is a slight but critical change in order and execution time:$ python3 countsync.pyOneTwoOneTwoOneTwocountsync.py executed in 3.01 seconds.While using time.sleep() and asyncio.sleep() may seem banal, they are used as stand-ins for any time-intensive processes that involve wait time. (The most mundane thing you can wait on is a sleep() call that does basically nothing.) That is, time.sleep() can represent any time-consuming blocking function call, while asyncio.sleep() is used to stand in for a non-blocking call (but one that also takes some time to complete).As youâ€™ll see in the next section, the benefit of awaiting something, including asyncio.sleep(), is that the surrounding function can temporarily cede control to another function thatâ€™s more readily able to do something immediately. In contrast, `time.sleep()` or any other blocking call is incompatible with asynchronous Python code, because it will stop everything in its tracks for the duration of the sleep time.The Rules of Async IOAt this point, a more formal definition of async, await, and the coroutine functions that they create are in order. This section is a little dense, but getting a hold of async/await is instrumental, so come back to this if you need to: The syntax async def introduces either a native coroutine or an asynchronous generator. The expressions async with and async for are also valid, and youâ€™ll see them later on. The keyword await passes function control back to the event loop. (It suspends the execution of the surrounding coroutine.) If Python encounters an await f() expression in the scope of g(), this is how await tells the event loop, â€œSuspend execution of g() until whatever Iâ€™m waiting onâ€”the result of f()â€”is returned. In the meantime, go let something else run.â€In code, that second bullet point looks roughly like this:async def g(): # Pause here and come back to g() when f() is ready r = await f() return rThereâ€™s also a strict set of rules around when and how you can and cannot use async/await. These can be handy whether you are still picking up the syntax or already have exposure to using async/await: A function that you introduce with async def is a coroutine. It may use await, return, or yield, but all of these are optional. Declaring async def noop(): pass is valid: Using await and/or return creates a coroutine function. To call a coroutine function, you must await it to get its results. It is less common (and only recently legal in Python) to use yield in an async def block. This creates an asynchronous generator, which you iterate over with async for. Forget about async generators for the time being and focus on getting down the syntax for coroutine functions, which use await and/or return. Anything defined with async def may not use yield from, which will raise a SyntaxError. Just like itâ€™s a SyntaxError to use yield outside of a def function, it is a SyntaxError to use await outside of an async def coroutine. You can only use await in the body of coroutines.Here are some terse examples meant to summarize the above few rules:async def f(x): y = await z(x) # OK - `await` and `return` allowed in coroutines return yasync def g(x): yield x # OK - this is an async generatorasync def m(x): yield from gen(x) # No - SyntaxErrordef m(x): y = await z(x) # Still no - SyntaxError (no `async def` here) return yFinally, when you use await f(), itâ€™s required that f() be an object that is awaitable. Well, thatâ€™s not very helpful, is it? For now, just know that an awaitable object is either (1) another coroutine or (2) an object defining an .__await__() dunder method that returns an iterator. If youâ€™re writing a program, for the large majority of purposes, you should only need to worry about case #1.That brings us to one more technical distinction that you may see pop up: an older way of marking a function as a coroutine is to decorate a normal def function with @asyncio.coroutine. The result is a generator-based coroutine. This construction has been outdated since the async/await syntax was put in place in Python 3.5.These two coroutines are essentially equivalent (both are awaitable), but the first is generator-based, while the second is a native coroutine:import asyncio@asyncio.coroutinedef py34_coro(): \"\"\"Generator-based coroutine, older syntax\"\"\" yield from stuff()async def py35_coro(): \"\"\"Native coroutine, modern syntax\"\"\" await stuff()If youâ€™re writing any code yourself, prefer native coroutines for the sake of being explicit rather than implicit. Generator-based coroutines will be removed in Python 3.10.Towards the latter half of this tutorial, weâ€™ll touch on generator-based coroutines for explanationâ€™s sake only. The reason that async/await were introduced is to make coroutines a standalone feature of Python that can be easily differentiated from a normal generator function, thus reducing ambiguity.Donâ€™t get bogged down in generator-based coroutines, which have been deliberately outdated by async/await. They have their own small set of rules (for instance, await cannot be used in a generator-based coroutine) that are largely irrelevant if you stick to the async/await syntax.Without further ado, letâ€™s take on a few more involved examples.Hereâ€™s one example of how async IO cuts down on wait time: given a coroutine makerandom() that keeps producing random integers in the range [0, 10], until one of them exceeds a threshold, you want to let multiple calls of this coroutine not need to wait for each other to complete in succession. You can largely follow the patterns from the two scripts above, with slight changes:#!/usr/bin/env python3# rand.pyimport asyncioimport random# ANSI colorsc = ( \"\\033[0m\", # End of color \"\\033[36m\", # Cyan \"\\033[91m\", # Red \"\\033[35m\", # Magenta)async def makerandom(idx: int, threshold: int = 6) -&gt; int: print(c[idx + 1] + f\"Initiated makerandom({idx}).\") i = random.randint(0, 10) while i &lt;= threshold: print(c[idx + 1] + f\"makerandom({idx}) == {i} too low; retrying.\") await asyncio.sleep(idx + 1) i = random.randint(0, 10) print(c[idx + 1] + f\"---&gt; Finished: makerandom({idx}) == {i}\" + c[0]) return iasync def main(): res = await asyncio.gather(*(makerandom(i, 10 - i - 1) for i in range(3))) return resif __name__ == \"__main__\": random.seed(444) r1, r2, r3 = asyncio.run(main()) print() print(f\"r1: {r1}, r2: {r2}, r3: {r3}\")The colorized output says a lot more than I can and gives you a sense for how this script is carried out:This program uses one main coroutine, makerandom(), and runs it concurrently across 3 different inputs. Most programs will contain small, modular coroutines and one wrapper function that serves to chain each of the smaller coroutines together. main() is then used to gather tasks (futures) by mapping the central coroutine across some iterable or pool.In this miniature example, the pool is range(3). In a fuller example presented later, it is a set of URLs that need to be requested, parsed, and processed concurrently, and main() encapsulates that entire routine for each URL.While â€œmaking random integersâ€ (which is CPU-bound more than anything) is maybe not the greatest choice as a candidate for asyncio, itâ€™s the presence of asyncio.sleep() in the example that is designed to mimic an IO-bound process where there is uncertain wait time involved. For example, the asyncio.sleep() call might represent sending and receiving not-so-random integers between two clients in a message application.Async IO Design PatternsAsync IO comes with its own set of possible script designs, which youâ€™ll get introduced to in this section.Chaining CoroutinesA key feature of coroutines is that they can be chained together. (Remember, a coroutine object is awaitable, so another coroutine can await it.) This allows you to break programs into smaller, manageable, recyclable coroutines:#!/usr/bin/env python3# chained.pyimport asyncioimport randomimport timeasync def part1(n: int) -&gt; str: i = random.randint(0, 10) print(f\"part1({n}) sleeping for {i} seconds.\") await asyncio.sleep(i) result = f\"result{n}-1\" print(f\"Returning part1({n}) == {result}.\") return resultasync def part2(n: int, arg: str) -&gt; str: i = random.randint(0, 10) print(f\"part2{n, arg} sleeping for {i} seconds.\") await asyncio.sleep(i) result = f\"result{n}-2 derived from {arg}\" print(f\"Returning part2{n, arg} == {result}.\") return resultasync def chain(n: int) -&gt; None: start = time.perf_counter() p1 = await part1(n) p2 = await part2(n, p1) end = time.perf_counter() - start print(f\"--&gt;Chained result{n} =&gt; {p2} (took {end:0.2f} seconds).\")async def main(*args): await asyncio.gather(*(chain(n) for n in args))if __name__ == \"__main__\": import sys random.seed(444) args = [1, 2, 3] if len(sys.argv) == 1 else map(int, sys.argv[1:]) start = time.perf_counter() asyncio.run(main(*args)) end = time.perf_counter() - start print(f\"Program finished in {end:0.2f} seconds.\")Pay careful attention to the output, where part1() sleeps for a variable amount of time, and part2() begins working with the results as they become available:$ python3 chained.py 9 6 3part1(9) sleeping for 4 seconds.part1(6) sleeping for 4 seconds.part1(3) sleeping for 0 seconds.Returning part1(3) == result3-1.part2(3, 'result3-1') sleeping for 4 seconds.Returning part1(9) == result9-1.part2(9, 'result9-1') sleeping for 7 seconds.Returning part1(6) == result6-1.part2(6, 'result6-1') sleeping for 4 seconds.Returning part2(3, 'result3-1') == result3-2 derived from result3-1.--&gt;Chained result3 =&gt; result3-2 derived from result3-1 (took 4.00 seconds).Returning part2(6, 'result6-1') == result6-2 derived from result6-1.--&gt;Chained result6 =&gt; result6-2 derived from result6-1 (took 8.01 seconds).Returning part2(9, 'result9-1') == result9-2 derived from result9-1.--&gt;Chained result9 =&gt; result9-2 derived from result9-1 (took 11.01 seconds).Program finished in 11.01 seconds.In this setup, the runtime of main() will be equal to the maximum runtime of the tasks that it gathers together and schedules.Using a QueueThe asyncio package provides queue classes that are designed to be similar to classes of the queue module. In our examples so far, we havenâ€™t really had a need for a queue structure. In chained.py, each task (future) is composed of a set of coroutines that explicitly await each other and pass through a single input per chain.There is an alternative structure that can also work with async IO: a number of producers, which are not associated with each other, add items to a queue. Each producer may add multiple items to the queue at staggered, random, unannounced times. A group of consumers pull items from the queue as they show up, greedily and without waiting for any other signal.In this design, there is no chaining of any individual consumer to a producer. The consumers donâ€™t know the number of producers, or even the cumulative number of items that will be added to the queue, in advance.It takes an individual producer or consumer a variable amount of time to put and extract items from the queue, respectively. The queue serves as a throughput that can communicate with the producers and consumers without them talking to each other directly. Note: While queues are often used in threaded programs because of the thread-safety of queue.Queue(), you shouldnâ€™t need to concern yourself with thread safety when it comes to async IO. (The exception is when youâ€™re combining the two, but that isnâ€™t done in this tutorial.) One use-case for queues (as is the case here) is for the queue to act as a transmitter for producers and consumers that arenâ€™t otherwise directly chained or associated with each other.The synchronous version of this program would look pretty dismal: a group of blocking producers serially add items to the queue, one producer at a time. Only after all producers are done can the queue be processed, by one consumer at a time processing item-by-item. There is a ton of latency in this design. Items may sit idly in the queue rather than be picked up and processed immediately.An asynchronous version, asyncq.py, is below. The challenging part of this workflow is that there needs to be a signal to the consumers that production is done. Otherwise, await q.get() will hang indefinitely, because the queue will have been fully processed, but consumers wonâ€™t have any idea that production is complete.(Big thanks for some help from a StackOverflow user for helping to straighten out main(): the key is to await q.join(), which blocks until all items in the queue have been received and processed, and then to cancel the consumer tasks, which would otherwise hang up and wait endlessly for additional queue items to appear.)Here is the full script:#!/usr/bin/env python3# asyncq.pyimport asyncioimport itertools as itimport osimport randomimport timeasync def makeitem(size: int = 5) -&gt; str: return os.urandom(size).hex()async def randsleep(caller=None) -&gt; None: i = random.randint(0, 10) if caller: print(f\"{caller} sleeping for {i} seconds.\") await asyncio.sleep(i)async def produce(name: int, q: asyncio.Queue) -&gt; None: n = random.randint(0, 10) for _ in it.repeat(None, n): # Synchronous loop for each single producer await randsleep(caller=f\"Producer {name}\") i = await makeitem() t = time.perf_counter() await q.put((i, t)) print(f\"Producer {name} added &lt;{i}&gt; to queue.\")async def consume(name: int, q: asyncio.Queue) -&gt; None: while True: await randsleep(caller=f\"Consumer {name}\") i, t = await q.get() now = time.perf_counter() print(f\"Consumer {name} got element &lt;{i}&gt;\" f\" in {now-t:0.5f} seconds.\") q.task_done()async def main(nprod: int, ncon: int): q = asyncio.Queue() producers = [asyncio.create_task(produce(n, q)) for n in range(nprod)] consumers = [asyncio.create_task(consume(n, q)) for n in range(ncon)] await asyncio.gather(*producers) await q.join() # Implicitly awaits consumers, too for c in consumers: c.cancel()if __name__ == \"__main__\": import argparse random.seed(444) parser = argparse.ArgumentParser() parser.add_argument(\"-p\", \"--nprod\", type=int, default=5) parser.add_argument(\"-c\", \"--ncon\", type=int, default=10) ns = parser.parse_args() start = time.perf_counter() asyncio.run(main(**ns.__dict__)) elapsed = time.perf_counter() - start print(f\"Program completed in {elapsed:0.5f} seconds.\")The first few coroutines are helper functions that return a random string, a fractional-second performance counter, and a random integer. A producer puts anywhere from 1 to 5 items into the queue. Each item is a tuple of (i, t) where i is a random string and t is the time at which the producer attempts to put the tuple into the queue.When a consumer pulls an item out, it simply calculates the elapsed time that the item sat in the queue using the timestamp that the item was put in with.Keep in mind that asyncio.sleep() is used to mimic some other, more complex coroutine that would eat up time and block all other execution if it were a regular blocking function.Here is a test run with two producers and five consumers:$ python3 asyncq.py -p 2 -c 5Producer 0 sleeping for 3 seconds.Producer 1 sleeping for 3 seconds.Consumer 0 sleeping for 4 seconds.Consumer 1 sleeping for 3 seconds.Consumer 2 sleeping for 3 seconds.Consumer 3 sleeping for 5 seconds.Consumer 4 sleeping for 4 seconds.Producer 0 added &lt;377b1e8f82&gt; to queue.Producer 0 sleeping for 5 seconds.Producer 1 added &lt;413b8802f8&gt; to queue.Consumer 1 got element &lt;377b1e8f82&gt; in 0.00013 seconds.Consumer 1 sleeping for 3 seconds.Consumer 2 got element &lt;413b8802f8&gt; in 0.00009 seconds.Consumer 2 sleeping for 4 seconds.Producer 0 added &lt;06c055b3ab&gt; to queue.Producer 0 sleeping for 1 seconds.Consumer 0 got element &lt;06c055b3ab&gt; in 0.00021 seconds.Consumer 0 sleeping for 4 seconds.Producer 0 added &lt;17a8613276&gt; to queue.Consumer 4 got element &lt;17a8613276&gt; in 0.00022 seconds.Consumer 4 sleeping for 5 seconds.Program completed in 9.00954 seconds.In this case, the items process in fractions of a second. A delay can be due to two reasons: Standard, largely unavoidable overhead Situations where all consumers are sleeping when an item appears in the queueWith regards to the second reason, luckily, it is perfectly normal to scale to hundreds or thousands of consumers. You should have no problem with python3 asyncq.py -p 5 -c 100. The point here is that, theoretically, you could have different users on different systems controlling the management of producers and consumers, with the queue serving as the central throughput.So far, youâ€™ve been thrown right into the fire and seen three related examples of asyncio calling coroutines defined with async and await. If youâ€™re not completely following or just want to get deeper into the mechanics of how modern coroutines came to be in Python, youâ€™ll start from square one with the next section.Async IOâ€™s Roots in GeneratorsEarlier, you saw an example of the old-style generator-based coroutines, which have been outdated by more explicit native coroutines. The example is worth re-showing with a small tweak:import asyncio@asyncio.coroutinedef py34_coro(): \"\"\"Generator-based coroutine\"\"\" # No need to build these yourself, but be aware of what they are s = yield from stuff() return sasync def py35_coro(): \"\"\"Native coroutine, modern syntax\"\"\" s = await stuff() return sasync def stuff(): return 0x10, 0x20, 0x30As an experiment, what happens if you call py34_coro() or py35_coro() on its own, without await, or without any calls to asyncio.run() or other asyncio â€œporcelainâ€ functions? Calling a coroutine in isolation returns a coroutine object:&gt;&gt;&gt; py35_coro()&lt;coroutine object py35_coro at 0x10126dcc8&gt;This isnâ€™t very interesting on its surface. The result of calling a coroutine on its own is an awaitable coroutine object.Time for a quiz: what other feature of Python looks like this? (What feature of Python doesnâ€™t actually â€œdo muchâ€ when itâ€™s called on its own?)Hopefully youâ€™re thinking of generators as an answer to this question, because coroutines are enhanced generators under the hood. The behavior is similar in this regard:&gt;&gt;&gt; def gen():... yield 0x10, 0x20, 0x30...&gt;&gt;&gt; g = gen()&gt;&gt;&gt; g # Nothing much happens - need to iterate with `.__next__()`&lt;generator object gen at 0x1012705e8&gt;&gt;&gt;&gt; next(g)(16, 32, 48)Generator functions are, as it so happens, the foundation of async IO (regardless of whether you declare coroutines with async def rather than the older @asyncio.coroutine wrapper). Technically, await is more closely analogous to yield from than it is to yield. (But remember that yield from x() is just syntactic sugar to replace for i in x(): yield i.)One critical feature of generators as it pertains to async IO is that they can effectively be stopped and restarted at will. For example, you can break out of iterating over a generator object and then resume iteration on the remaining values later. When a generator function reaches yield, it yields that value, but then it sits idle until it is told to yield its subsequent value.This can be fleshed out through an example:&gt;&gt;&gt; from itertools import cycle&gt;&gt;&gt; def endless():... \"\"\"Yields 9, 8, 7, 6, 9, 8, 7, 6, ... forever\"\"\"... yield from cycle((9, 8, 7, 6))&gt;&gt;&gt; e = endless()&gt;&gt;&gt; total = 0&gt;&gt;&gt; for i in e:... if total &lt; 30:... print(i, end=\" \")... total += i... else:... print()... # Pause execution. We can resume later.... break9 8 7 6 9 8 7 6 9 8 7 6 9 8&gt;&gt;&gt; # Resume&gt;&gt;&gt; next(e), next(e), next(e)(6, 9, 8)The await keyword behaves similarly, marking a break point at which the coroutine suspends itself and lets other coroutines work. â€œSuspended,â€ in this case, means a coroutine that has temporarily ceded control but not totally exited or finished. Keep in mind that yield, and by extension yield from and await, mark a break point in a generatorâ€™s execution.This is the fundamental difference between functions and generators. A function is all-or-nothing. Once it starts, it wonâ€™t stop until it hits a return, then pushes that value to the caller (the function that calls it). A generator, on the other hand, pauses each time it hits a yield and goes no further. Not only can it push this value to calling stack, but it can keep a hold of its local variables when you resume it by calling next() on it.Thereâ€™s a second and lesser-known feature of generators that also matters. You can send a value into a generator as well through its .send() method. This allows generators (and coroutines) to call (await) each other without blocking. I wonâ€™t get any further into the nuts and bolts of this feature, because it matters mainly for the implementation of coroutines behind the scenes, but you shouldnâ€™t ever really need to use it directly yourself.If youâ€™re interested in exploring more, you can start at PEP 342, where coroutines were formally introduced. Brett Cannonâ€™s How the Heck Does Async-Await Work in Python is also a good read, as is the PYMOTW writeup on asyncio. Lastly, thereâ€™s David Beazleyâ€™s Curious Course on Coroutines and Concurrency, which dives deep into the mechanism by which coroutines run.Letâ€™s try to condense all of the above articles into a few sentences: there is a particularly unconventional mechanism by which these coroutines actually get run. Their result is an attribute of the exception object that gets thrown when their .send() method is called. Thereâ€™s some more wonky detail to all of this, but it probably wonâ€™t help you use this part of the language in practice, so letâ€™s move on for now.To tie things together, here are some key points on the topic of coroutines as generators: Coroutines are repurposed generators that take advantage of the peculiarities of generator methods. Old generator-based coroutines use yield from to wait for a coroutine result. Modern Python syntax in native coroutines simply replaces yield from with await as the means of waiting on a coroutine result. The await is analogous to yield from, and it often helps to think of it as such. The use of await is a signal that marks a break point. It lets a coroutine temporarily suspend execution and permits the program to come back to it later.Other Features: async for and Async Generators + ComprehensionsAlong with plain async/await, Python also enables async for to iterate over an asynchronous iterator. The purpose of an asynchronous iterator is for it to be able to call asynchronous code at each stage when it is iterated over.A natural extension of this concept is an asynchronous generator. Recall that you can use await, return, or yield in a native coroutine. Using yield within a coroutine became possible in Python 3.6 (via PEP 525), which introduced asynchronous generators with the purpose of allowing await and yield to be used in the same coroutine function body:&gt;&gt;&gt; async def mygen(u: int = 10):... \"\"\"Yield powers of 2.\"\"\"... i = 0... while i &lt; u:... yield 2 ** i... i += 1... await asyncio.sleep(0.1)Last but not least, Python enables asynchronous comprehension with async for. Like its synchronous cousin, this is largely syntactic sugar:&gt;&gt;&gt; async def main():... # This does *not* introduce concurrent execution... # It is meant to show syntax only... g = [i async for i in mygen()]... f = [j async for j in mygen() if not (j // 3 % 5)]... return g, f...&gt;&gt;&gt; g, f = asyncio.run(main())&gt;&gt;&gt; g[1, 2, 4, 8, 16, 32, 64, 128, 256, 512]&gt;&gt;&gt; f[1, 2, 16, 32, 256, 512]This is a crucial distinction: neither asynchronous generators nor comprehensions make the iteration concurrent. All that they do is provide the look-and-feel of their synchronous counterparts, but with the ability for the loop in question to give up control to the event loop for some other coroutine to run.In other words, asynchronous iterators and asynchronous generators are not designed to concurrently map some function over a sequence or iterator. Theyâ€™re merely designed to let the enclosing coroutine allow other tasks to take their turn. The async for and async with statements are only needed to the extent that using plain for or with would â€œbreakâ€ the nature of await in the coroutine. This distinction between asynchronicity and concurrency is a key one to grasp.The Event Loop and asyncio.run()You can think of an event loop as something like a while True loop that monitors coroutines, taking feedback on whatâ€™s idle, and looking around for things that can be executed in the meantime. It is able to wake up an idle coroutine when whatever that coroutine is waiting on becomes available.Thus far, the entire management of the event loop has been implicitly handled by one function call:asyncio.run(main()) # Python 3.7+asyncio.run(), introduced in Python 3.7, is responsible for getting the event loop, running tasks until they are marked as complete, and then closing the event loop.Thereâ€™s a more long-winded way of managing the asyncio event loop, with get_event_loop(). The typical pattern looks like this:loop = asyncio.get_event_loop()try: loop.run_until_complete(main())finally: loop.close()Youâ€™ll probably see loop.get_event_loop() floating around in older examples, but unless you have a specific need to fine-tune control over the event loop management, asyncio.run() should be sufficient for most programs.If you do need to interact with the event loop within a Python program, loop is a good-old-fashioned Python object that supports introspection with loop.is_running() and loop.is_closed(). You can manipulate it if you need to get more fine-tuned control, such as in scheduling a callback by passing the loop as an argument.What is more crucial is understanding a bit beneath the surface about the mechanics of the event loop. Here are a few points worth stressing about the event loop.#1: Coroutines donâ€™t do much on their own until they are tied to the event loop.You saw this point before in the explanation on generators, but itâ€™s worth restating. If you have a main coroutine that awaits others, simply calling it in isolation has little effect:&gt;&gt;&gt; import asyncio&gt;&gt;&gt; async def main():... print(\"Hello ...\")... await asyncio.sleep(1)... print(\"World!\")&gt;&gt;&gt; routine = main()&gt;&gt;&gt; routine&lt;coroutine object main at 0x1027a6150&gt;Remember to use asyncio.run() to actually force execution by scheduling the main() coroutine (future object) for execution on the event loop:&gt;&gt;&gt; asyncio.run(routine)Hello ...World!(Other coroutines can be executed with await. It is typical to wrap just main() in asyncio.run(), and chained coroutines with await will be called from there.)#2: By default, an async IO event loop runs in a single thread and on a single CPU core. Usually, running one single-threaded event loop in one CPU core is more than sufficient. It is also possible to run event loops across multiple cores. Check out this talk by John Reese for more, and be warned that your laptop may spontaneously combust.#3. Event loops are pluggable. That is, you could, if you really wanted, write your own event loop implementation and have it run tasks just the same. This is wonderfully demonstrated in the uvloop package, which is an implementation of the event loop in Cython.That is what is meant by the term â€œpluggable event loopâ€: you can use any working implementation of an event loop, unrelated to the structure of the coroutines themselves. The asyncio package itself ships with two different event loop implementations, with the default being based on the selectors module. (The second implementation is built for Windows only.)A Full Program: Asynchronous RequestsYouâ€™ve made it this far, and now itâ€™s time for the fun and painless part. In this section, youâ€™ll build a web-scraping URL collector, areq.py, using aiohttp, a blazingly fast async HTTP client/server framework. (We just need the client part.) Such a tool could be used to map connections between a cluster of sites, with the links forming a directed graph. Note: You may be wondering why Pythonâ€™s requests package isnâ€™t compatible with async IO. requests is built on top of urllib3, which in turn uses Pythonâ€™s http and socket modules. By default, socket operations are blocking. This means that Python wonâ€™t like await requests.get(url) because .get() is not awaitable. In contrast, almost everything in aiohttp is an awaitable coroutine, such as session.request() and response.text(). Itâ€™s a great package otherwise, but youâ€™re doing yourself a disservice by using requests in asynchronous code.The high-level program structure will look like this: Read a sequence of URLs from a local file, urls.txt. Send GET requests for the URLs and decode the resulting content. If this fails, stop there for a URL. Search for the URLs within href tags in the HTML of the responses. Write the results to foundurls.txt. Do all of the above as asynchronously and concurrently as possible. (Use aiohttp for the requests, and aiofiles for the file-appends. These are two primary examples of IO that are well-suited for the async IO model.)Here are the contents of urls.txt. Itâ€™s not huge, and contains mostly highly trafficked sites:$ cat urls.txthttps://regex101.com/https://docs.python.org/3/this-url-will-404.htmlhttps://www.nytimes.com/guides/https://www.mediamatters.org/https://1.1.1.1/https://www.politico.com/tipsheets/morning-moneyhttps://www.bloomberg.com/markets/economicshttps://www.ietf.org/rfc/rfc2616.txtThe second URL in the list should return a 404 response, which youâ€™ll need to handle gracefully. If youâ€™re running an expanded version of this program, youâ€™ll probably need to deal with much hairier problems than this, such a server disconnections and endless redirects.The requests themselves should be made using a single session, to take advantage of reusage of the sessionâ€™s internal connection pool.Letâ€™s take a look at the full program. Weâ€™ll walk through things step-by-step after:#!/usr/bin/env python3# areq.py\"\"\"Asynchronously get links embedded in multiple pages' HMTL.\"\"\"import asyncioimport loggingimport reimport sysfrom typing import IOimport urllib.errorimport urllib.parseimport aiofilesimport aiohttpfrom aiohttp import ClientSessionlogging.basicConfig( format=\"%(asctime)s %(levelname)s:%(name)s: %(message)s\", level=logging.DEBUG, datefmt=\"%H:%M:%S\", stream=sys.stderr,)logger = logging.getLogger(\"areq\")logging.getLogger(\"chardet.charsetprober\").disabled = TrueHREF_RE = re.compile(r'href=\"(.*?)\"')async def fetch_html(url: str, session: ClientSession, **kwargs) -&gt; str: \"\"\"GET request wrapper to fetch page HTML. kwargs are passed to `session.request()`. \"\"\" resp = await session.request(method=\"GET\", url=url, **kwargs) resp.raise_for_status() logger.info(\"Got response [%s] for URL: %s\", resp.status, url) html = await resp.text() return htmlasync def parse(url: str, session: ClientSession, **kwargs) -&gt; set: \"\"\"Find HREFs in the HTML of `url`.\"\"\" found = set() try: html = await fetch_html(url=url, session=session, **kwargs) except ( aiohttp.ClientError, aiohttp.http_exceptions.HttpProcessingError, ) as e: logger.error( \"aiohttp exception for %s [%s]: %s\", url, getattr(e, \"status\", None), getattr(e, \"message\", None), ) return found except Exception as e: logger.exception( \"Non-aiohttp exception occured: %s\", getattr(e, \"__dict__\", {}) ) return found else: for link in HREF_RE.findall(html): try: abslink = urllib.parse.urljoin(url, link) except (urllib.error.URLError, ValueError): logger.exception(\"Error parsing URL: %s\", link) pass else: found.add(abslink) logger.info(\"Found %d links for %s\", len(found), url) return foundasync def write_one(file: IO, url: str, **kwargs) -&gt; None: \"\"\"Write the found HREFs from `url` to `file`.\"\"\" res = await parse(url=url, **kwargs) if not res: return None async with aiofiles.open(file, \"a\") as f: for p in res: await f.write(f\"{url}\\t{p}\\n\") logger.info(\"Wrote results for source URL: %s\", url)async def bulk_crawl_and_write(file: IO, urls: set, **kwargs) -&gt; None: \"\"\"Crawl &amp; write concurrently to `file` for multiple `urls`.\"\"\" async with ClientSession() as session: tasks = [] for url in urls: tasks.append( write_one(file=file, url=url, session=session, **kwargs) ) await asyncio.gather(*tasks)if __name__ == \"__main__\": import pathlib import sys assert sys.version_info &gt;= (3, 7), \"Script requires Python 3.7+.\" here = pathlib.Path(__file__).parent with open(here.joinpath(\"urls.txt\")) as infile: urls = set(map(str.strip, infile)) outpath = here.joinpath(\"foundurls.txt\") with open(outpath, \"w\") as outfile: outfile.write(\"source_url\\tparsed_url\\n\") asyncio.run(bulk_crawl_and_write(file=outpath, urls=urls))This script is longer than our initial toy programs, so letâ€™s break it down.The constant HREF_RE is a regular expression to extract what weâ€™re ultimately searching for, href tags within HTML:&gt;&gt;&gt; HREF_RE.search('Go to &lt;a href=\"https://realpython.com/\"&gt;Real Python&lt;/a&gt;')&lt;re.Match object; span=(15, 45), match='href=\"https://realpython.com/\"'&gt;The coroutine fetch_html() is a wrapper around a GET request to make the request and decode the resulting page HTML. It makes the request, awaits the response, and raises right away in the case of a non-200 status:resp = await session.request(method=\"GET\", url=url, **kwargs)resp.raise_for_status()If the status is okay, fetch_html() returns the page HTML (a str). Notably, there is no exception handling done in this function. The logic is to propagate that exception to the caller and let it be handled there:html = await resp.text()We await session.request() and resp.text() because theyâ€™re awaitable coroutines. The request/response cycle would otherwise be the long-tailed, time-hogging portion of the application, but with async IO, fetch_html() lets the event loop work on other readily available jobs such as parsing and writing URLs that have already been fetched.Next in the chain of coroutines comes parse(), which waits on fetch_html() for a given URL, and then extracts all of the href tags from that pageâ€™s HTML, making sure that each is valid and formatting it as an absolute path.Admittedly, the second portion of parse() is blocking, but it consists of a quick regex match and ensuring that the links discovered are made into absolute paths.In this specific case, this synchronous code should be quick and inconspicuous. But just remember that any line within a given coroutine will block other coroutines unless that line uses yield, await, or return. If the parsing was a more intensive process, you might want to consider running this portion in its own process with loop.run_in_executor().Next, the coroutine write() takes a file object and a single URL, and waits on parse() to return a set of the parsed URLs, writing each to the file asynchronously along with its source URL through use of aiofiles, a package for async file IO.Lastly, bulk_crawl_and_write() serves as the main entry point into the scriptâ€™s chain of coroutines. It uses a single session, and a task is created for each URL that is ultimately read from urls.txt.Here are a few additional points that deserve mention: The default ClientSession has an adapter with a maximum of 100 open connections. To change that, pass an instance of asyncio.connector.TCPConnector to ClientSession. You can also specify limits on a per-host basis. You can specify max timeouts for both the session as a whole and for individual requests. This script also uses async with, which works with an asynchronous context manager. I havenâ€™t devoted a whole section to this concept because the transition from synchronous to asynchronous context managers is fairly straightforward. The latter has to define .__aenter__() and .__aexit__() rather than .__exit__() and .__enter__(). As you might expect, async with can only be used inside a coroutine function declared with async def.If youâ€™d like to explore a bit more, the companion files for this tutorial up at GitHub have comments and docstrings attached as well.Hereâ€™s the execution in all of its glory, as areq.py gets, parses, and saves results for 9 URLs in under a second:$ python3 areq.py21:33:22 DEBUG:asyncio: Using selector: KqueueSelector21:33:22 INFO:areq: Got response [200] for URL: https://www.mediamatters.org/21:33:22 INFO:areq: Found 115 links for https://www.mediamatters.org/21:33:22 INFO:areq: Got response [200] for URL: https://www.nytimes.com/guides/21:33:22 INFO:areq: Got response [200] for URL: https://www.politico.com/tipsheets/morning-money21:33:22 INFO:areq: Got response [200] for URL: https://www.ietf.org/rfc/rfc2616.txt21:33:22 ERROR:areq: aiohttp exception for https://docs.python.org/3/this-url-will-404.html [404]: Not Found21:33:22 INFO:areq: Found 120 links for https://www.nytimes.com/guides/21:33:22 INFO:areq: Found 143 links for https://www.politico.com/tipsheets/morning-money21:33:22 INFO:areq: Wrote results for source URL: https://www.mediamatters.org/21:33:22 INFO:areq: Found 0 links for https://www.ietf.org/rfc/rfc2616.txt21:33:22 INFO:areq: Got response [200] for URL: https://1.1.1.1/21:33:22 INFO:areq: Wrote results for source URL: https://www.nytimes.com/guides/21:33:22 INFO:areq: Wrote results for source URL: https://www.politico.com/tipsheets/morning-money21:33:22 INFO:areq: Got response [200] for URL: https://www.bloomberg.com/markets/economics21:33:22 INFO:areq: Found 3 links for https://www.bloomberg.com/markets/economics21:33:22 INFO:areq: Wrote results for source URL: https://www.bloomberg.com/markets/economics21:33:23 INFO:areq: Found 36 links for https://1.1.1.1/21:33:23 INFO:areq: Got response [200] for URL: https://regex101.com/21:33:23 INFO:areq: Found 23 links for https://regex101.com/21:33:23 INFO:areq: Wrote results for source URL: https://regex101.com/21:33:23 INFO:areq: Wrote results for source URL: https://1.1.1.1/Thatâ€™s not too shabby! As a sanity check, you can check the line-count on the output. In my case, itâ€™s 626, though keep in mind this may fluctuate:$ wc -l foundurls.txt 626 foundurls.txt$ head -n 3 foundurls.txtsource_url parsed_urlhttps://www.bloomberg.com/markets/economics https://www.bloomberg.com/feedbackhttps://www.bloomberg.com/markets/economics https://www.bloomberg.com/notices/tos Next Steps: If youâ€™d like to up the ante, make this webcrawler recursive. You can use aio-redis to keep track of which URLs have been crawled within the tree to avoid requesting them twice, and connect links with Pythonâ€™s networkx library. Remember to be nice. Sending 1000 concurrent requests to a small, unsuspecting website is bad, bad, bad. There are ways to limit how many concurrent requests youâ€™re making in one batch, such as in using the sempahore objects of asyncio or using a pattern like this one. If you donâ€™t heed this warning, you may get a massive batch of TimeoutError exceptions and only end up hurting your own program.Async IO in ContextNow that youâ€™ve seen a healthy dose of code, letâ€™s step back for a minute and consider when async IO is an ideal option and how you can make the comparison to arrive at that conclusion or otherwise choose a different model of concurrency.When and Why Is Async IO the Right Choice?This tutorial is no place for an extended treatise on async IO versus threading versus multiprocessing. However, itâ€™s useful to have an idea of when async IO is probably the best candidate of the three.The battle over async IO versus multiprocessing is not really a battle at all. In fact, they can be used in concert. If you have multiple, fairly uniform CPU-bound tasks (a great example is a grid search in libraries such as scikit-learn or keras), multiprocessing should be an obvious choice.Simply putting async before every function is a bad idea if all of the functions use blocking calls. (This can actually slow down your code.) But as mentioned previously, there are places where async IO and multiprocessing can live in harmony.The contest between async IO and threading is a little bit more direct. I mentioned in the introduction that â€œthreading is hard.â€ The full story is that, even in cases where threading seems easy to implement, it can still lead to infamous impossible-to-trace bugs due to race conditions and memory usage, among other things.Threading also tends to scale less elegantly than async IO, because threads are a system resource with a finite availability. Creating thousands of threads will fail on many machines, and I donâ€™t recommend trying it in the first place. Creating thousands of async IO tasks is completely feasible.Async IO shines when you have multiple IO-bound tasks where the tasks would otherwise be dominated by blocking IO-bound wait time, such as: Network IO, whether your program is the server or the client side Serverless designs, such as a peer-to-peer, multi-user network like a group chatroom Read/write operations where you want to mimic a â€œfire-and-forgetâ€ style but worry less about holding a lock on whatever youâ€™re reading and writing toThe biggest reason not to use it is that await only supports a specific set of objects that define a specific set of methods. If you want to do async read operations with a certain DBMS, youâ€™ll need to find not just a Python wrapper for that DBMS, but one that supports the async/await syntax. Coroutines that contain synchronous calls block other coroutines and tasks from running.For a shortlist of libraries that work with async/await, see the list at the end of this tutorial.Async IO It Is, but Which One?This tutorial focuses on async IO, the async/await syntax, and using asyncio for event-loop management and specifying tasks. asyncio certainly isnâ€™t the only async IO library out there. This observation from Nathaniel J. Smith says a lot: [In] a few years, asyncio might find itself relegated to becoming one of those stdlib libraries that savvy developers avoid, like urllib2. â€¦ What Iâ€™m arguing, in effect, is that asyncio is a victim of its own success: when it was designed, it used the best approach possible; but since then, work inspired by asyncio â€“ like the addition of async/await â€“ has shifted the landscape so that we can do even better, and now asyncio is hamstrung by its earlier commitments. (Source)To that end, a few big-name alternatives that do what asyncio does, albeit with different APIs and different approaches, are curio and trio. Personally, I think that if youâ€™re building a moderately sized, straightforward program, just using asyncio is plenty sufficient and understandable, and lets you avoid adding yet another large dependency outside of Pythonâ€™s standard library.But by all means, check out curio and trio, and you might find that they get the same thing done in a way thatâ€™s more intuitive for you as the user. Many of the package-agnostic concepts presented here should permeate to alternative async IO packages as well.Odds and EndsIn these next few sections, youâ€™ll cover some miscellaneous parts of asyncio and async/await that havenâ€™t fit neatly into the tutorial thus far, but are still important for building and understanding a full program.Other Top-Level asyncio FunctionsIn addition to asyncio.run(), youâ€™ve seen a few other package-level functions such as asyncio.create_task() and asyncio.gather().You can use create_task() to schedule the execution of a coroutine object, followed by asyncio.run():&gt;&gt;&gt; import asyncio&gt;&gt;&gt; async def coro(seq) -&gt; list:... \"\"\"'IO' wait time is proportional to the max element.\"\"\"... await asyncio.sleep(max(seq))... return list(reversed(seq))...&gt;&gt;&gt; async def main():... # This is a bit redundant in the case of one task... # We could use `await coro([3, 2, 1])` on its own... t = asyncio.create_task(coro([3, 2, 1])) # Python 3.7+... await t... print(f't: type {type(t)}')... print(f't done: {t.done()}')...&gt;&gt;&gt; t = asyncio.run(main())t: type &lt;class '_asyncio.Task'&gt;t done: TrueThereâ€™s a subtlety to this pattern: if you donâ€™t await t within main(), it may finish before main() itself signals that it is complete. Because asyncio.run(main()) calls loop.run_until_complete(main()), the event loop is only concerned (without await t present) that main() is done, not that the tasks that get created within main() are done. Without await t, the loopâ€™s other tasks will be cancelled, possibly before they are completed. If you need to get a list of currently pending tasks, you can use asyncio.Task.all_tasks().Note: asyncio.create_task() was introduced in Python 3.7. In Python 3.6 or lower, use asyncio.ensure_future() in place of create_task().Separately, thereâ€™s asyncio.gather(). While it doesnâ€™t do anything tremendously special, gather() is meant to neatly put a collection of coroutines (futures) into a single future. As a result, it returns a single future object, and, if you await asyncio.gather() and specify multiple tasks or coroutines, youâ€™re waiting for all of them to be completed. (This somewhat parallels queue.join() from our earlier example.) The result of gather() will be a list of the results across the inputs:&gt;&gt;&gt; import time&gt;&gt;&gt; async def main():... t = asyncio.create_task(coro([3, 2, 1]))... t2 = asyncio.create_task(coro([10, 5, 0])) # Python 3.7+... print('Start:', time.strftime('%X'))... a = await asyncio.gather(t, t2)... print('End:', time.strftime('%X')) # Should be 10 seconds... print(f'Both tasks done: {all((t.done(), t2.done()))}')... return a...&gt;&gt;&gt; a = asyncio.run(main())Start: 16:20:11End: 16:20:21Both tasks done: True&gt;&gt;&gt; a[[1, 2, 3], [0, 5, 10]]You probably noticed that gather() waits on the entire result set of the Futures or coroutines that you pass it. Alternatively, you can loop over asyncio.as_completed() to get tasks as they are completed, in the order of completion. The function returns an iterator that yields tasks as they finish. Below, the result of coro([3, 2, 1]) will be available before coro([10, 5, 0]) is complete, which is not the case with gather():&gt;&gt;&gt; async def main():... t = asyncio.create_task(coro([3, 2, 1]))... t2 = asyncio.create_task(coro([10, 5, 0]))... print('Start:', time.strftime('%X'))... for res in asyncio.as_completed((t, t2)):... compl = await res... print(f'res: {compl} completed at {time.strftime(\"%X\")}')... print('End:', time.strftime('%X'))... print(f'Both tasks done: {all((t.done(), t2.done()))}')...&gt;&gt;&gt; a = asyncio.run(main())Start: 09:49:07res: [1, 2, 3] completed at 09:49:10res: [0, 5, 10] completed at 09:49:17End: 09:49:17Both tasks done: TrueLastly, you may also see asyncio.ensure_future(). You should rarely need it, because itâ€™s a lower-level plumbing API and largely replaced by create_task(), which was introduced later.The Precedence of awaitWhile they behave somewhat similarly, the await keyword has significantly higher precedence than yield. This means that, because it is more tightly bound, there are a number of instances where youâ€™d need parentheses in a yield from statement that are not required in an analogous await statement. For more information, see examples of await expressions from PEP 492.ConclusionYouâ€™re now equipped to use async/await and the libraries built off of it. Hereâ€™s a recap of what youâ€™ve covered: Asynchronous IO as a language-agnostic model and a way to effect concurrency by letting coroutines indirectly communicate with each other The specifics of Pythonâ€™s new async and await keywords, used to mark and define coroutines asyncio, the Python package that provides the API to run and manage coroutinesResourcesPython Version SpecificsAsync IO in Python has evolved swiftly, and it can be hard to keep track of what came when. Hereâ€™s a list of Python minor-version changes and introductions related to asyncio: 3.3: The yield from expression allows for generator delegation. 3.4: asyncio was introduced in the Python standard library with provisional API status. 3.5: async and await became a part of the Python grammar, used to signify and wait on coroutines. They were not yet reserved keywords. (You could still define functions or variables named async and await.) 3.6: Asynchronous generators and asynchronous comprehensions were introduced. The API of asyncio was declared stable rather than provisional. 3.7: async and await became reserved keywords. (They cannot be used as identifiers.) They are intended to replace the asyncio.coroutine() decorator. asyncio.run() was introduced to the asyncio package, among a bunch of other features.If you want to be safe (and be able to use asyncio.run()), go with Python 3.7 or above to get the full set of features.ArticlesHereâ€™s a curated list of additional resources: Real Python: Speed up your Python Program with Concurrency Real Python: What is the Python Global Interpreter Lock? CPython: The asyncio package source Python docs: Data model &gt; Coroutines TalkPython: Async Techniques and Examples in Python Brett Cannon: How the Heck Does Async-Await Work in Python 3.5? PYMOTW: asyncio A. Jesse Jiryu Davis and Guido van Rossum: A Web Crawler With asyncio Coroutines Andy Pearce: The State of Python Coroutines: yield from Nathaniel J. Smith: Some Thoughts on Asynchronous API Design in a Post-async/await World Armin Ronacher: I donâ€™t understand Pythonâ€™s Asyncio Andy Balaam: series on asyncio (4 posts) Stack Overflow: Python asyncio.semaphore in async-await function Yeray Diaz: AsyncIO for the Working Python Developer Asyncio Coroutine Patterns: Beyond await A few Python Whatâ€™s New sections explain the motivation behind language changes in more detail: Whatâ€™s New in Python 3.3 (yield from and PEP 380) Whatâ€™s New in Python 3.6 (PEP 525 &amp; 530)From David Beazley: Generator: Tricks for Systems Programmers A Curious Course on Coroutines and Concurrency Generators: The Final FrontierYouTube talks: John Reese - Thinking Outside the GIL with AsyncIO and Multiprocessing - PyCon 2018 Keynote David Beazley - Topics of Interest (Python Asyncio) David Beazley - Python Concurrency From the Ground Up: LIVE! - PyCon 2015 Raymond Hettinger, Keynote on Concurrency, PyBay 2017 Thinking about Concurrency, Raymond Hettinger, Python core developer Miguel Grinberg Asynchronous Python for the Complete Beginner PyCon 2017 Yury Selivanov asyncawait and asyncio in Python 3 6 and beyond PyCon 2017 Fear and Awaiting in Async: A Savage Journey to the Heart of the Coroutine Dream What Is Async, How Does It Work, and When Should I Use It? (PyCon APAC 2014)Related PEPs PEP Date Created PEP 342 â€“ Coroutines via Enhanced Generators 2005-05 PEP 380 â€“ Syntax for Delegating to a Subgenerator 2009-02 PEP 3153 â€“ Asynchronous IO support 2011-05 PEP 3156 â€“ Asynchronous IO Support Rebooted: the â€œasyncioâ€ Module 2012-12 PEP 492 â€“ Coroutines with async and await syntax 2015-04 PEP 525 â€“ Asynchronous Generators 2016-07 PEP 530 â€“ Asynchronous Comprehensions 2016-09 Libraries That Work With async/awaitFrom aio-libs: aiohttp: Asynchronous HTTP client/server framework aioredis: Async IO Redis support aiopg: Async IO PostgreSQL support aiomcache: Async IO memcached client aiokafka: Async IO Kafka client aiozmq: Async IO ZeroMQ support aiojobs: Jobs scheduler for managing background tasks async_lru: Simple LRU cache for async IOFrom magicstack: uvloop: Ultra fast async IO event loop asyncpg: (Also very fast) async IO PostgreSQL supportFrom other hosts: trio: Friendlier asyncio intended to showcase a radically simpler design aiofiles: Async file IO asks: Async requests-like http library asyncio-redis: Async IO Redis support aioprocessing: Integrates multiprocessing module with asyncio umongo: Async IO MongoDB client unsync: Unsynchronize asyncio aiostream: Like itertools, but async" }, { "title": "å¼ºåŒ–å­¦ä¹ ç¬¬äºŒç‰ˆå¯¼å›¾ï¼ˆä¸€ï¼‰ï¼šMDPã€åŠ¨æ€è§„åˆ’åŠè’™ç‰¹å¡æ´›æ³•", "url": "/posts/RL-MindMap-1/", "categories": "å­¦ä¹ , Reinforcement Learning", "tags": "å¼ºåŒ–å­¦ä¹ , æ€ç»´å¯¼å›¾", "date": "2021-09-11 22:15:05 +0800", "snippet": "æœ¬ç³»åˆ—ä¸º Sutton &amp; Barto -ã€ŠReinforcement Learning: An Introduction 2nd Editionã€‹çš„ä¸ªäººè¯»åæ€ç»´å¯¼å›¾è®°å½•ï¼Œä¾¿äºåç»­å¿«é€Ÿå¤ä¹ åŠå›å¿†ï¼Œæœ¬ç« å¯¹åº”åŸæ–‡çš„ç¬¬1-5ç« ã€‚åŸä¹¦åœ°å€ï¼šincompleteideas.netï¼Œå³é”®æ–°æ ‡ç­¾æŸ¥çœ‹å›¾ç‰‡åŸå›¾ã€‚" }, { "title": "ã€è½¬è½½ã€‘A Python Interpreter Written in Python", "url": "/posts/Repost-A-Python-Interpreter-Written-in-Python/", "categories": "", "tags": "Python, è½¬è½½", "date": "2021-07-19 05:39:10 +0800", "snippet": "æœ¬æ–‡ä¸ºè½¬è½½ã€‚éå¸¸æœ‰åŠ©äºç†è§£ Python è§£é‡Šå™¨çš„åŸç†ç­‰ï¼Œä»æ­¤å¯¹å„ç§ Python æ’ä»¶ã€åº“ç­‰ä¸åœ¨è¿·èŒ«ã€æ¯”å¦‚ laike9m/Cyberbrain: Python debugging, redefined. (github.com)ã€‘ã€‚ä¸­æ–‡ç‰ˆç”± qingyunha ç¿»è¯‘ç»´æŠ¤ï¼ŒåŸæ–‡åœ°å€ä¸º 500linesã€‚åŸä½œè€…Allisonæ˜¯Dropboxçš„å·¥ç¨‹å¸ˆï¼Œåœ¨é‚£é‡Œå¥¹ç»´æŠ¤ç€ä¸–ç•Œä¸Šæœ€å¤§çš„ç”±Pythonå®¢æˆ·ç»„æˆçš„ç½‘ç»œã€‚åœ¨Dropboxä¹‹å‰ï¼Œå¥¹æ˜¯Recurse Centerçš„å¼•å¯¼å¸ˆ, â€¦ å¥¹åœ¨åŒ—ç¾çš„PyConåšè¿‡å…³äºPythonå†…éƒ¨æœºåˆ¶çš„æ¼”è®²ï¼Œå¹¶ä¸”å¥¹å–œæ¬¢å¥‡æ€ªçš„bugsã€‚å¥¹çš„åšå®¢åœ°å€æ˜¯akaptur.com.IntroductionByterunæ˜¯ä¸€ä¸ªç”¨Pythonå®ç°çš„Pythonè§£é‡Šå™¨ã€‚éšç€æˆ‘åœ¨Byterunä¸Šçš„å·¥ä½œï¼Œæˆ‘æƒŠè®¶å¹¶å¾ˆé«˜å…´åœ°çš„å‘ç°ï¼Œè¿™ä¸ªPythonè§£é‡Šå™¨çš„åŸºç¡€ç»“æ„å¯ä»¥æ»¡è¶³500è¡Œçš„é™åˆ¶ã€‚åœ¨è¿™ä¸€ç« æˆ‘ä»¬ä¼šææ¸…æ¥šè¿™ä¸ªè§£é‡Šå™¨çš„ç»“æ„ï¼Œç»™ä½ è¶³å¤Ÿçš„çŸ¥è¯†æ¢ç´¢ä¸‹å»ã€‚æˆ‘ä»¬çš„ç›®æ ‡ä¸æ˜¯å‘ä½ å±•ç¤ºè§£é‡Šå™¨çš„æ¯ä¸ªç»†èŠ‚â€”åƒç¼–ç¨‹å’Œè®¡ç®—æœºç§‘å­¦å…¶ä»–æœ‰è¶£çš„é¢†åŸŸä¸€æ ·ï¼Œä½ å¯èƒ½ä¼šæŠ•å…¥å‡ å¹´çš„æ—¶é—´å»ææ¸…æ¥šè¿™ä¸ªä¸»é¢˜ã€‚Byterunæ˜¯Ned Batchelderå’Œæˆ‘å®Œæˆçš„ï¼Œå»ºç«‹åœ¨Paul Swartzçš„å·¥ä½œä¹‹ä¸Šã€‚å®ƒçš„ç»“æ„å’Œä¸»è¦çš„Pythonå®ç°ï¼ˆCPythonï¼‰å·®ä¸å¤šï¼Œæ‰€ä»¥ç†è§£Byterunä¼šå¸®åŠ©ä½ ç†è§£å¤§å¤šæ•°è§£é‡Šå™¨ç‰¹åˆ«æ˜¯CPythonè§£é‡Šå™¨ã€‚ï¼ˆå¦‚æœä½ ä¸çŸ¥é“ä½ ç”¨çš„æ˜¯ä»€ä¹ˆPythonï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½å®ƒå°±æ˜¯CPythonï¼‰ã€‚å°½ç®¡Byterunå¾ˆå°ï¼Œä½†å®ƒèƒ½æ‰§è¡Œå¤§å¤šæ•°ç®€å•çš„Pythonç¨‹åºã€‚A Python Interpreteråœ¨å¼€å§‹ä¹‹å‰ï¼Œè®©æˆ‘ä»¬ç¼©å°ä¸€ä¸‹â€œPyhtonè§£é‡Šå™¨â€çš„æ„æ€ã€‚åœ¨è®¨è®ºPythonçš„æ—¶å€™ï¼Œâ€œè§£é‡Šå™¨â€è¿™ä¸ªè¯å¯ä»¥ç”¨åœ¨å¾ˆå¤šä¸åŒçš„åœ°æ–¹ã€‚æœ‰çš„æ—¶å€™è§£é‡Šå™¨æŒ‡çš„æ˜¯REPLï¼Œå½“ä½ åœ¨å‘½ä»¤è¡Œä¸‹æ•²ä¸‹pythonæ—¶æ‰€å¾—åˆ°çš„äº¤äº’å¼ç¯å¢ƒã€‚æœ‰æ—¶å€™äººä»¬ä¼šç›¸äº’æ›¿ä»£çš„ä½¿ç”¨Pythonè§£é‡Šå™¨å’ŒPythonæ¥è¯´æ˜æ‰§è¡ŒPythonä»£ç çš„è¿™ä¸€è¿‡ç¨‹ã€‚åœ¨æœ¬ç« ï¼Œâ€œè§£é‡Šå™¨â€æœ‰ä¸€ä¸ªæ›´ç²¾ç¡®çš„æ„æ€ï¼šæ‰§è¡ŒPythonç¨‹åºè¿‡ç¨‹ä¸­çš„æœ€åä¸€æ­¥ã€‚åœ¨è§£é‡Šå™¨æ¥æ‰‹ä¹‹å‰ï¼ŒPythonä¼šæ‰§è¡Œå…¶ä»–3ä¸ªæ­¥éª¤ï¼šè¯æ³•åˆ†æï¼Œè¯­æ³•è§£æå’Œç¼–è¯‘ã€‚è¿™ä¸‰æ­¥åˆèµ·æ¥æŠŠæºä»£ç è½¬æ¢æˆcode object,å®ƒåŒ…å«ç€è§£é‡Šå™¨å¯ä»¥ç†è§£çš„æŒ‡ä»¤ã€‚è€Œè§£é‡Šå™¨çš„å·¥ä½œå°±æ˜¯è§£é‡Šcode objectä¸­çš„æŒ‡ä»¤ã€‚ä½ å¯èƒ½å¾ˆå¥‡æ€ªæ‰§è¡ŒPythonä»£ç ä¼šæœ‰ç¼–è¯‘è¿™ä¸€æ­¥ã€‚Pythoné€šå¸¸è¢«ç§°ä¸ºè§£é‡Šå‹è¯­è¨€ï¼Œå°±åƒRubyï¼ŒPerlä¸€æ ·ï¼Œå®ƒä»¬å’Œç¼–è¯‘å‹è¯­è¨€ç›¸å¯¹ï¼Œæ¯”å¦‚Cï¼ŒRustã€‚ç„¶è€Œï¼Œè¿™é‡Œçš„æœ¯è¯­å¹¶ä¸æ˜¯å®ƒçœ‹èµ·æ¥çš„é‚£æ ·ç²¾ç¡®ã€‚å¤§å¤šæ•°è§£é‡Šå‹è¯­è¨€åŒ…æ‹¬Pythonï¼Œç¡®å®ä¼šæœ‰ç¼–è¯‘è¿™ä¸€æ­¥ã€‚è€ŒPythonè¢«ç§°ä¸ºè§£é‡Šå‹çš„åŸå› æ˜¯ç›¸å¯¹äºç¼–è¯‘å‹è¯­è¨€ï¼Œå®ƒåœ¨ç¼–è¯‘è¿™ä¸€æ­¥çš„å·¥ä½œç›¸å¯¹è¾ƒå°‘ï¼ˆè§£é‡Šå™¨åšç›¸å¯¹å¤šçš„å·¥ä½œï¼‰ã€‚åœ¨è¿™ç« åé¢ä½ ä¼šçœ‹åˆ°ï¼ŒPythonçš„ç¼–è¯‘å™¨æ¯”Cè¯­è¨€ç¼–è¯‘å™¨éœ€è¦æ›´å°‘çš„å…³äºç¨‹åºè¡Œä¸ºçš„ä¿¡æ¯ã€‚A Python Python InterpreterByterunæ˜¯ä¸€ä¸ªç”¨Pythonå†™çš„Pythonè§£é‡Šå™¨ï¼Œè¿™ç‚¹å¯èƒ½è®©ä½ æ„Ÿåˆ°å¥‡æ€ªï¼Œä½†æ²¡æœ‰æ¯”ç”¨Cè¯­è¨€å†™Cè¯­è¨€ç¼–è¯‘å™¨æ›´å¥‡æ€ªã€‚ï¼ˆäº‹å®ä¸Šï¼Œå¹¿æ³›ä½¿ç”¨çš„gccç¼–è¯‘å™¨å°±æ˜¯ç”¨Cè¯­è¨€æœ¬èº«å†™çš„ï¼‰ä½ å¯ä»¥ç”¨å‡ ä¹çš„ä»»ä½•è¯­è¨€å†™ä¸€ä¸ªPythonè§£é‡Šå™¨ã€‚ç”¨Pythonå†™Pythonæ—¢æœ‰ä¼˜ç‚¹åˆæœ‰ç¼ºç‚¹ã€‚æœ€å¤§çš„ç¼ºç‚¹å°±æ˜¯é€Ÿåº¦ï¼šç”¨Byterunæ‰§è¡Œä»£ç è¦æ¯”ç”¨CPythonæ‰§è¡Œæ…¢çš„å¤šï¼ŒCPythonè§£é‡Šå™¨æ˜¯ç”¨Cè¯­è¨€å®ç°çš„å¹¶åšäº†ä¼˜åŒ–ã€‚ç„¶è€ŒByterunæ˜¯ä¸ºäº†å­¦ä¹ è€Œè®¾è®¡çš„ï¼Œæ‰€ä»¥é€Ÿåº¦å¯¹æˆ‘ä»¬ä¸é‡è¦ã€‚ä½¿ç”¨Pythonæœ€å¤§ä¼˜ç‚¹æ˜¯æˆ‘ä»¬å¯ä»¥ä»…ä»…å®ç°è§£é‡Šå™¨ï¼Œè€Œä¸ç”¨æ‹…å¿ƒPythonè¿è¡Œæ—¶çš„éƒ¨åˆ†ï¼Œç‰¹åˆ«æ˜¯å¯¹è±¡ç³»ç»Ÿã€‚æ¯”å¦‚å½“Byterunéœ€è¦åˆ›å»ºä¸€ä¸ªç±»æ—¶ï¼Œå®ƒå°±ä¼šå›é€€åˆ°â€œçœŸæ­£â€çš„Pythonã€‚å¦å¤–ä¸€ä¸ªä¼˜åŠ¿æ˜¯Byterunå¾ˆå®¹æ˜“ç†è§£ï¼Œéƒ¨åˆ†åŸå› æ˜¯å®ƒæ˜¯ç”¨é«˜çº§è¯­è¨€å†™çš„ï¼ˆPythonï¼ï¼‰ï¼ˆå¦å¤–æˆ‘ä»¬ä¸ä¼šå¯¹è§£é‡Šå™¨åšä¼˜åŒ– â€” å†ä¸€æ¬¡ï¼Œæ¸…æ™°å’Œç®€å•æ¯”é€Ÿåº¦æ›´é‡è¦ï¼‰Building an Interpreteråœ¨æˆ‘ä»¬è€ƒå¯ŸByterunä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ä¸€äº›å¯¹è§£é‡Šå™¨ç»“æ„çš„é«˜å±‚æ¬¡è§†è§’ã€‚Pythonè§£é‡Šå™¨æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼ŸPythonè§£é‡Šå™¨æ˜¯ä¸€ä¸ªè™šæ‹Ÿæœº,æ¨¡æ‹ŸçœŸå®è®¡ç®—æœºçš„è½¯ä»¶ã€‚æˆ‘ä»¬è¿™ä¸ªè™šæ‹Ÿæœºæ˜¯æ ˆæœºå™¨ï¼Œå®ƒç”¨å‡ ä¸ªæ ˆæ¥å®Œæˆæ“ä½œï¼ˆä¸ä¹‹ç›¸å¯¹çš„æ˜¯å¯„å­˜å™¨æœºå™¨ï¼Œå®ƒä»ç‰¹å®šçš„å†…å­˜åœ°å€è¯»å†™æ•°æ®ï¼‰ã€‚Pythonè§£é‡Šå™¨æ˜¯ä¸€ä¸ªå­—èŠ‚ç è§£é‡Šå™¨ï¼šå®ƒçš„è¾“å…¥æ˜¯ä¸€äº›å‘½ä»¤é›†åˆç§°ä½œå­—èŠ‚ç ã€‚å½“ä½ å†™Pythonä»£ç æ—¶ï¼Œè¯æ³•åˆ†æå™¨ï¼Œè¯­æ³•è§£æå™¨å’Œç¼–è¯‘å™¨ç”Ÿæˆcode objectè®©è§£é‡Šå™¨å»æ“ä½œã€‚æ¯ä¸ªcode objectéƒ½åŒ…å«ä¸€ä¸ªè¦è¢«æ‰§è¡Œçš„æŒ‡ä»¤é›†åˆ â€” å®ƒå°±æ˜¯å­—èŠ‚ç  â€” å¦å¤–è¿˜æœ‰ä¸€äº›è§£é‡Šå™¨éœ€è¦çš„ä¿¡æ¯ã€‚å­—èŠ‚ç æ˜¯Pythonä»£ç çš„ä¸€ä¸ªä¸­é—´å±‚è¡¨ç¤ºï¼šå®ƒä»¥ä¸€ç§è§£é‡Šå™¨å¯ä»¥ç†è§£çš„æ–¹å¼æ¥è¡¨ç¤ºæºä»£ç ã€‚è¿™å’Œæ±‡ç¼–è¯­è¨€ä½œä¸ºCè¯­è¨€å’Œæœºå™¨è¯­è¨€çš„ä¸­é—´è¡¨ç¤ºå¾ˆç±»ä¼¼ã€‚A Tiny Interpreterä¸ºäº†è®©è¯´æ˜æ›´å…·ä½“ï¼Œè®©æˆ‘ä»¬ä»ä¸€ä¸ªéå¸¸å°çš„è§£é‡Šå™¨å¼€å§‹ã€‚å®ƒåªèƒ½è®¡ç®—ä¸¤ä¸ªæ•°çš„å’Œï¼Œåªèƒ½ç†è§£ä¸‰ä¸ªæŒ‡ä»¤ã€‚å®ƒæ‰§è¡Œçš„æ‰€æœ‰ä»£ç åªæ˜¯è¿™ä¸‰ä¸ªæŒ‡ä»¤çš„ä¸åŒç»„åˆã€‚ä¸‹é¢å°±æ˜¯è¿™ä¸‰ä¸ªæŒ‡ä»¤ï¼š LOAD_VALUE ADD_TWO_VALUES PRINT_ANSWERæˆ‘ä»¬ä¸å…³å¿ƒè¯æ³•ï¼Œè¯­æ³•å’Œç¼–è¯‘ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿä¸åœ¨ä¹è¿™äº›æŒ‡ä»¤æ˜¯å¦‚ä½•äº§ç”Ÿçš„ã€‚ä½ å¯ä»¥æƒ³è±¡ï¼Œä½ å†™ä¸‹7 + 5ï¼Œç„¶åä¸€ä¸ªç¼–è¯‘å™¨ä¸ºä½ ç”Ÿæˆé‚£ä¸‰ä¸ªæŒ‡ä»¤çš„ç»„åˆã€‚å¦‚æœä½ æœ‰ä¸€ä¸ªåˆé€‚çš„ç¼–è¯‘å™¨ï¼Œä½ ç”šè‡³å¯ä»¥ç”¨Lispçš„è¯­æ³•æ¥å†™ï¼Œåªè¦å®ƒèƒ½ç”Ÿæˆç›¸åŒçš„æŒ‡ä»¤ã€‚å‡è®¾7 + 5ç”Ÿæˆè¿™æ ·çš„æŒ‡ä»¤é›†ï¼šwhat_to_execute = { \"instructions\": [(\"LOAD_VALUE\", 0), # the first number (\"LOAD_VALUE\", 1), # the second number (\"ADD_TWO_VALUES\", None), (\"PRINT_ANSWER\", None)], \"numbers\": [7, 5] }Pythonè§£é‡Šå™¨æ˜¯ä¸€ä¸ªæ ˆæœºå™¨ï¼Œæ‰€ä»¥å®ƒå¿…é¡»é€šè¿‡æ“ä½œæ ˆæ¥å®Œæˆè¿™ä¸ªåŠ æ³•ã€‚(Figure 1.1)è§£é‡Šå™¨å…ˆæ‰§è¡Œç¬¬ä¸€æ¡æŒ‡ä»¤ï¼ŒLOAD_VALUEï¼ŒæŠŠç¬¬ä¸€ä¸ªæ•°å‹åˆ°æ ˆä¸­ã€‚æ¥ç€å®ƒæŠŠç¬¬äºŒä¸ªæ•°ä¹Ÿå‹åˆ°æ ˆä¸­ã€‚ç„¶åï¼Œç¬¬ä¸‰æ¡æŒ‡ä»¤ï¼ŒADD_TWO_VALUES,å…ˆæŠŠä¸¤ä¸ªæ•°ä»æ ˆä¸­å¼¹å‡ºï¼ŒåŠ èµ·æ¥ï¼Œå†æŠŠç»“æœå‹å…¥æ ˆä¸­ã€‚æœ€åä¸€æ­¥ï¼ŒæŠŠç»“æœå¼¹å‡ºå¹¶è¾“å‡ºã€‚LOAD_VALUEè¿™æ¡æŒ‡ä»¤å‘Šè¯‰è§£é‡Šå™¨æŠŠä¸€ä¸ªæ•°å‹å…¥æ ˆä¸­ï¼Œä½†æŒ‡ä»¤æœ¬èº«å¹¶æ²¡æœ‰æŒ‡æ˜è¿™ä¸ªæ•°æ˜¯å¤šå°‘ã€‚æŒ‡ä»¤éœ€è¦ä¸€ä¸ªé¢å¤–çš„ä¿¡æ¯å‘Šè¯‰è§£é‡Šå™¨å»å“ªé‡Œæ‰¾åˆ°è¿™ä¸ªæ•°ã€‚æ‰€ä»¥æˆ‘ä»¬çš„æŒ‡ä»¤é›†æœ‰ä¸¤ä¸ªéƒ¨åˆ†ï¼šæŒ‡ä»¤æœ¬èº«å’Œä¸€ä¸ªå¸¸é‡åˆ—è¡¨ã€‚ï¼ˆåœ¨Pythonä¸­ï¼Œå­—èŠ‚ç å°±æ˜¯æˆ‘ä»¬ç§°ä¸ºçš„â€œæŒ‡ä»¤â€ï¼Œè€Œè§£é‡Šå™¨æ‰§è¡Œçš„æ˜¯code objectã€‚ï¼‰ä¸ºä»€ä¹ˆä¸æŠŠæ•°å­—ç›´æ¥åµŒå…¥æŒ‡ä»¤ä¹‹ä¸­ï¼Ÿæƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬åŠ çš„ä¸æ˜¯æ•°å­—ï¼Œè€Œæ˜¯å­—ç¬¦ä¸²ã€‚æˆ‘ä»¬å¯ä¸æƒ³æŠŠå­—ç¬¦ä¸²è¿™æ ·çš„ä¸œè¥¿åŠ åˆ°æŒ‡ä»¤ä¸­ï¼Œå› ä¸ºå®ƒå¯ä»¥æœ‰ä»»æ„çš„é•¿åº¦ã€‚å¦å¤–ï¼Œæˆ‘ä»¬è¿™ç§è®¾è®¡ä¹Ÿæ„å‘³ç€æˆ‘ä»¬åªéœ€è¦å¯¹è±¡çš„ä¸€ä»½æ‹·è´ï¼Œæ¯”å¦‚è¿™ä¸ªåŠ æ³• 7 + 7, ç°åœ¨å¸¸é‡è¡¨ \"numbers\"åªéœ€åŒ…å«ä¸€ä¸ª7ã€‚ä½ å¯èƒ½ä¼šæƒ³ä¸ºä»€ä¹ˆä¼šéœ€è¦é™¤äº†ADD_TWO_VALUESä¹‹å¤–çš„æŒ‡ä»¤ã€‚çš„ç¡®ï¼Œå¯¹äºæˆ‘ä»¬ä¸¤ä¸ªæ•°åŠ æ³•ï¼Œè¿™ä¸ªä¾‹å­æ˜¯æœ‰ç‚¹äººä¸ºåˆ¶ä½œçš„æ„æ€ã€‚ç„¶è€Œï¼Œè¿™ä¸ªæŒ‡ä»¤å´æ˜¯å»ºé€ æ›´å¤æ‚ç¨‹åºçš„è½®å­ã€‚æ¯”å¦‚ï¼Œå°±æˆ‘ä»¬ç›®å‰å®šä¹‰çš„ä¸‰ä¸ªæŒ‡ä»¤ï¼Œåªè¦ç»™å‡ºæ­£ç¡®çš„æŒ‡ä»¤ç»„åˆï¼Œæˆ‘ä»¬å¯ä»¥åšä¸‰ä¸ªæ•°çš„åŠ æ³•ï¼Œæˆ–è€…ä»»æ„ä¸ªæ•°çš„åŠ æ³•ã€‚åŒæ—¶ï¼Œæ ˆæä¾›äº†ä¸€ä¸ªæ¸…æ™°çš„æ–¹æ³•å»è·Ÿè¸ªè§£é‡Šå™¨çš„çŠ¶æ€ï¼Œè¿™ä¸ºæˆ‘ä»¬å¢é•¿çš„å¤æ‚æ€§æä¾›äº†æ”¯æŒã€‚ç°åœ¨è®©æˆ‘ä»¬æ¥å®Œæˆæˆ‘ä»¬çš„è§£é‡Šå™¨ã€‚è§£é‡Šå™¨å¯¹è±¡éœ€è¦ä¸€ä¸ªæ ˆï¼Œå®ƒå¯ä»¥ç”¨ä¸€ä¸ªåˆ—è¡¨æ¥è¡¨ç¤ºã€‚å®ƒè¿˜éœ€è¦ä¸€ä¸ªæ–¹æ³•æ¥æè¿°æ€æ ·æ‰§è¡Œæ¯æ¡æŒ‡ä»¤ã€‚æ¯”å¦‚ï¼ŒLOAD_VALUEä¼šæŠŠä¸€ä¸ªå€¼å‹å…¥æ ˆä¸­ã€‚class Interpreter: def __init__(self): self.stack = [] def LOAD_VALUE(self, number): self.stack.append(number) def PRINT_ANSWER(self): answer = self.stack.pop() print(answer) def ADD_TWO_VALUES(self): first_num = self.stack.pop() second_num = self.stack.pop() total = first_num + second_num self.stack.append(total)è¿™ä¸‰ä¸ªæ–¹æ³•å®Œæˆäº†è§£é‡Šå™¨æ‰€ç†è§£çš„ä¸‰æ¡æŒ‡ä»¤ã€‚ä½†è§£é‡Šå™¨è¿˜éœ€è¦ä¸€æ ·ä¸œè¥¿ï¼šä¸€ä¸ªèƒ½æŠŠæ‰€æœ‰ä¸œè¥¿ç»“åˆåœ¨ä¸€èµ·å¹¶æ‰§è¡Œçš„æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•å°±å«åšrun_code, å®ƒæŠŠæˆ‘ä»¬å‰é¢å®šä¹‰çš„å­—å…¸ç»“æ„what-to-executeä½œä¸ºå‚æ•°ï¼Œå¾ªç¯æ‰§è¡Œé‡Œé¢çš„æ¯æ¡æŒ‡ä»¤ï¼Œå¦‚ä½•æŒ‡ä»¤æœ‰å‚æ•°ï¼Œå¤„ç†å‚æ•°ï¼Œç„¶åè°ƒç”¨è§£é‡Šå™¨å¯¹è±¡ä¸­ç›¸åº”çš„æ–¹æ³•ã€‚ def run_code(self, what_to_execute): instructions = what_to_execute[\"instructions\"] numbers = what_to_execute[\"numbers\"] for each_step in instructions: instruction, argument = each_step if instruction == \"LOAD_VALUE\": number = numbers[argument] self.LOAD_VALUE(number) elif instruction == \"ADD_TWO_VALUES\": self.ADD_TWO_VALUES() elif instruction == \"PRINT_ANSWER\": self.PRINT_ANSWER()ä¸ºäº†æµ‹è¯•ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªè§£é‡Šå™¨å¯¹è±¡ï¼Œç„¶åç”¨å‰é¢å®šä¹‰çš„ 7 + 5 çš„æŒ‡ä»¤é›†æ¥è°ƒç”¨run_codeã€‚ interpreter = Interpreter() interpreter.run_code(what_to_execute)æ˜¾ç„¶ï¼Œå®ƒä¼šè¾“å‡º12å°½ç®¡æˆ‘ä»¬çš„è§£é‡Šå™¨åŠŸèƒ½å—é™ï¼Œä½†è¿™ä¸ªåŠ æ³•è¿‡ç¨‹å‡ ä¹å’ŒçœŸæ­£çš„Pythonè§£é‡Šå™¨æ˜¯ä¸€æ ·çš„ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬è¿˜æœ‰å‡ ç‚¹è¦æ³¨æ„ã€‚é¦–å…ˆï¼Œä¸€äº›æŒ‡ä»¤éœ€è¦å‚æ•°ã€‚åœ¨çœŸæ­£çš„Python bytecodeä¸­ï¼Œå¤§æ¦‚æœ‰ä¸€åŠçš„æŒ‡ä»¤æœ‰å‚æ•°ã€‚åƒæˆ‘ä»¬çš„ä¾‹å­ä¸€æ ·ï¼Œå‚æ•°å’ŒæŒ‡ä»¤æ‰“åŒ…åœ¨ä¸€èµ·ã€‚æ³¨æ„æŒ‡ä»¤çš„å‚æ•°å’Œä¼ é€’ç»™å¯¹åº”æ–¹æ³•çš„å‚æ•°æ˜¯ä¸åŒçš„ã€‚ç¬¬äºŒï¼ŒæŒ‡ä»¤ADD_TWO_VALUESä¸éœ€è¦ä»»ä½•å‚æ•°ï¼Œå®ƒä»è§£é‡Šå™¨æ ˆä¸­å¼¹å‡ºæ‰€éœ€çš„å€¼ã€‚è¿™æ­£æ˜¯ä»¥æ ˆä¸ºåŸºç¡€çš„è§£é‡Šå™¨çš„ç‰¹ç‚¹ã€‚è®°å¾—æˆ‘ä»¬è¯´è¿‡åªè¦ç»™å‡ºåˆé€‚çš„æŒ‡ä»¤é›†ï¼Œä¸éœ€è¦å¯¹è§£é‡Šå™¨åšä»»ä½•æ”¹å˜ï¼Œæˆ‘ä»¬åšå¤šä¸ªæ•°çš„åŠ æ³•ã€‚è€ƒè™‘ä¸‹é¢çš„æŒ‡ä»¤é›†ï¼Œä½ è§‰å¾—ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿå¦‚æœä½ æœ‰ä¸€ä¸ªåˆé€‚çš„ç¼–è¯‘å™¨ï¼Œä»€ä¹ˆä»£ç æ‰èƒ½ç¼–è¯‘å‡ºä¸‹é¢çš„æŒ‡ä»¤é›†ï¼Ÿ what_to_execute = { \"instructions\": [(\"LOAD_VALUE\", 0), (\"LOAD_VALUE\", 1), (\"ADD_TWO_VALUES\", None), (\"LOAD_VALUE\", 2), (\"ADD_TWO_VALUES\", None), (\"PRINT_ANSWER\", None)], \"numbers\": [7, 5, 8] }ä»è¿™ç‚¹å‡ºå‘ï¼Œæˆ‘ä»¬å¼€å§‹çœ‹åˆ°è¿™ç§ç»“æ„çš„å¯æ‰©å±•æ€§ï¼šæˆ‘ä»¬å¯ä»¥é€šè¿‡å‘è§£é‡Šå™¨å¯¹è±¡å¢åŠ æ–¹æ³•æ¥æè¿°æ›´å¤šçš„æ“ä½œï¼ˆåªè¦æœ‰ä¸€ä¸ªç¼–è¯‘å™¨èƒ½ä¸ºæˆ‘ä»¬ç”Ÿæˆç»„ç»‡è‰¯å¥½çš„æŒ‡ä»¤é›†ï¼‰ã€‚Variablesæ¥ä¸‹æ¥ç»™æˆ‘ä»¬çš„è§£é‡Šå™¨å¢åŠ å˜é‡çš„æ”¯æŒã€‚æˆ‘ä»¬éœ€è¦ä¸€ä¸ªä¿å­˜å˜é‡å€¼çš„æŒ‡ä»¤ï¼ŒSTORE_NAME;ä¸€ä¸ªå–å˜é‡å€¼çš„æŒ‡ä»¤LOAD_NAME;å’Œä¸€ä¸ªå˜é‡åˆ°å€¼çš„æ˜ å°„å…³ç³»ã€‚ç›®å‰ï¼Œæˆ‘ä»¬ä¼šå¿½ç•¥å‘½åç©ºé—´å’Œä½œç”¨åŸŸï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠå˜é‡å’Œå€¼çš„æ˜ å°„ç›´æ¥å­˜å‚¨åœ¨è§£é‡Šå™¨å¯¹è±¡ä¸­ã€‚æœ€åï¼Œæˆ‘ä»¬è¦ä¿è¯what_to_executeé™¤äº†ä¸€ä¸ªå¸¸é‡åˆ—è¡¨ï¼Œè¿˜è¦æœ‰ä¸ªå˜é‡åå­—çš„åˆ—è¡¨ã€‚&gt;&gt;&gt; def s():... a = 1... b = 2... print(a + b)# a friendly compiler transforms `s` into: what_to_execute = { \"instructions\": [(\"LOAD_VALUE\", 0), (\"STORE_NAME\", 0), (\"LOAD_VALUE\", 1), (\"STORE_NAME\", 1), (\"LOAD_NAME\", 0), (\"LOAD_NAME\", 1), (\"ADD_TWO_VALUES\", None), (\"PRINT_ANSWER\", None)], \"numbers\": [1, 2], \"names\": [\"a\", \"b\"] }æˆ‘ä»¬çš„æ–°çš„çš„å®ç°åœ¨ä¸‹é¢ã€‚ä¸ºäº†è·Ÿè¸ªå“ªåå­—ç»‘å®šåˆ°é‚£ä¸ªå€¼ï¼Œæˆ‘ä»¬åœ¨__init__æ–¹æ³•ä¸­å¢åŠ ä¸€ä¸ªenvironmentå­—å…¸ã€‚æˆ‘ä»¬ä¹Ÿå¢åŠ äº†STORE_NAMEå’ŒLOAD_NAMEæ–¹æ³•ï¼Œå®ƒä»¬è·å¾—å˜é‡åï¼Œç„¶åä»environmentå­—å…¸ä¸­è®¾ç½®æˆ–å–å‡ºè¿™ä¸ªå˜é‡å€¼ã€‚ç°åœ¨æŒ‡ä»¤å‚æ•°å°±æœ‰ä¸¤ä¸ªä¸åŒçš„æ„æ€ï¼Œå®ƒå¯èƒ½æ˜¯numbersåˆ—è¡¨çš„ç´¢å¼•ï¼Œä¹Ÿå¯èƒ½æ˜¯namesåˆ—è¡¨çš„ç´¢å¼•ã€‚è§£é‡Šå™¨é€šè¿‡æ£€æŸ¥æ‰€æ‰§è¡Œçš„æŒ‡ä»¤å°±èƒ½çŸ¥é“æ˜¯é‚£ç§å‚æ•°ã€‚è€Œæˆ‘ä»¬æ‰“ç ´è¿™ç§é€»è¾‘ ï¼ŒæŠŠæŒ‡ä»¤å’Œå®ƒæ‰€ç”¨ä½•ç§å‚æ•°çš„æ˜ å°„å…³ç³»æ”¾åœ¨å¦ä¸€ä¸ªå•ç‹¬çš„æ–¹æ³•ä¸­ã€‚class Interpreter: def __init__(self): self.stack = [] self.environment = {} def STORE_NAME(self, name): val = self.stack.pop() self.environment[name] = val def LOAD_NAME(self, name): val = self.environment[name] self.stack.append(val) def parse_argument(self, instruction, argument, what_to_execute): \"\"\" Understand what the argument to each instruction means.\"\"\" numbers = [\"LOAD_VALUE\"] names = [\"LOAD_NAME\", \"STORE_NAME\"] if instruction in numbers: argument = what_to_execute[\"numbers\"][argument] elif instruction in names: argument = what_to_execute[\"names\"][argument] return argument def run_code(self, what_to_execute): instructions = what_to_execute[\"instructions\"] for each_step in instructions: instruction, argument = each_step argument = self.parse_argument(instruction, argument, what_to_execute) if instruction == \"LOAD_VALUE\": self.LOAD_VALUE(argument) elif instruction == \"ADD_TWO_VALUES\": self.ADD_TWO_VALUES() elif instruction == \"PRINT_ANSWER\": self.PRINT_ANSWER() elif instruction == \"STORE_NAME\": self.STORE_NAME(argument) elif instruction == \"LOAD_NAME\": self.LOAD_NAME(argument)ä»…ä»…äº”ä¸ªæŒ‡ä»¤ï¼Œrun_codeè¿™ä¸ªæ–¹æ³•å·²ç»å¼€å§‹å˜å¾—å†—é•¿äº†ã€‚å¦‚æœä¿æŒè¿™ç§ç»“æ„ï¼Œé‚£ä¹ˆæ¯æ¡æŒ‡ä»¤éƒ½éœ€è¦ä¸€ä¸ªifåˆ†æ”¯ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬è¦åˆ©ç”¨Pythonçš„åŠ¨æ€æ–¹æ³•æŸ¥æ‰¾ã€‚æˆ‘ä»¬æ€»ä¼šç»™ä¸€ä¸ªç§°ä¸ºFOOçš„æŒ‡ä»¤å®šä¹‰ä¸€ä¸ªåä¸ºFOOçš„æ–¹æ³•ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ç”¨Pythonçš„getattrå‡½æ•°åœ¨è¿è¡Œæ—¶åŠ¨æ€æŸ¥æ‰¾æ–¹æ³•ï¼Œè€Œä¸ç”¨è¿™ä¸ªå¤§å¤§çš„åˆ†æ”¯ç»“æ„ã€‚run_codeæ–¹æ³•ç°åœ¨æ˜¯è¿™æ ·ï¼š def execute(self, what_to_execute): instructions = what_to_execute[\"instructions\"] for each_step in instructions: instruction, argument = each_step argument = self.parse_argument(instruction, argument, what_to_execute) bytecode_method = getattr(self, instruction) if argument is None: bytecode_method() else: bytecode_method(argument)Real Python Bytecodeç°åœ¨ï¼Œæ”¾å¼ƒæˆ‘ä»¬çš„å°æŒ‡ä»¤é›†ï¼Œå»çœ‹çœ‹çœŸæ­£çš„Pythonå­—èŠ‚ç ã€‚å­—èŠ‚ç çš„ç»“æ„å’Œæˆ‘ä»¬çš„å°è§£é‡Šå™¨çš„æŒ‡ä»¤é›†å·®ä¸å¤šï¼Œé™¤äº†å­—èŠ‚ç ç”¨ä¸€ä¸ªå­—èŠ‚è€Œä¸æ˜¯ä¸€ä¸ªåå­—æ¥æŒ‡ç¤ºè¿™æ¡æŒ‡ä»¤ã€‚ä¸ºäº†ç†è§£å®ƒçš„ç»“æ„ï¼Œæˆ‘ä»¬å°†è€ƒå¯Ÿä¸€ä¸ªå‡½æ•°çš„å­—èŠ‚ç ã€‚è€ƒè™‘ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š&gt;&gt;&gt; def cond():... x = 3... if x &lt; 5:... return 'yes'... else:... return 'no'...Pythonåœ¨è¿è¡Œæ—¶ä¼šæš´éœ²ä¸€å¤§æ‰¹å†…éƒ¨ä¿¡æ¯ï¼Œå¹¶ä¸”æˆ‘ä»¬å¯ä»¥é€šè¿‡REPLç›´æ¥è®¿é—®è¿™äº›ä¿¡æ¯ã€‚å¯¹äºå‡½æ•°å¯¹è±¡condï¼Œcond.__code__æ˜¯ä¸å…¶å…³è”çš„code objectï¼Œè€Œcond.__code__.co_codeå°±æ˜¯å®ƒçš„å­—èŠ‚ç ã€‚å½“ä½ å†™Pythonä»£ç æ—¶ï¼Œä½ æ°¸è¿œä¹Ÿä¸ä¼šæƒ³ç›´æ¥ä½¿ç”¨è¿™äº›å±æ€§ï¼Œä½†æ˜¯è¿™å¯ä»¥è®©æˆ‘ä»¬åšå‡ºå„ç§æ¶ä½œå‰§ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥çœ‹çœ‹å†…éƒ¨æœºåˆ¶ã€‚&gt;&gt;&gt; cond.__code__.co_code # the bytecode as raw bytesb'd\\x01\\x00}\\x00\\x00|\\x00\\x00d\\x02\\x00k\\x00\\x00r\\x16\\x00d\\x03\\x00Sd\\x04\\x00Sd\\x00 \\x00S'&gt;&gt;&gt; list(cond.__code__.co_code) # the bytecode as numbers[100, 1, 0, 125, 0, 0, 124, 0, 0, 100, 2, 0, 107, 0, 0, 114, 22, 0, 100, 3, 0, 83, 100, 4, 0, 83, 100, 0, 0, 83]å½“æˆ‘ä»¬ç›´æ¥è¾“å‡ºè¿™ä¸ªå­—èŠ‚ç ï¼Œå®ƒçœ‹èµ·æ¥å®Œå…¨æ— æ³•ç†è§£ â€” å”¯ä¸€æˆ‘ä»¬äº†è§£çš„æ˜¯å®ƒæ˜¯ä¸€ä¸²å­—èŠ‚ã€‚å¾ˆå¹¸è¿ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå¾ˆå¼ºå¤§çš„å·¥å…·å¯ä»¥ç”¨ï¼šPythonæ ‡å‡†åº“ä¸­çš„dis moduleã€‚disæ˜¯ä¸€ä¸ªå­—èŠ‚ç åæ±‡ç¼–å™¨ã€‚åæ±‡ç¼–å™¨ä»¥ä¸ºæœºå™¨è€Œå†™çš„åº•å±‚ä»£ç ä½œä¸ºè¾“å…¥ï¼Œæ¯”å¦‚æ±‡ç¼–ä»£ç å’Œå­—èŠ‚ç ï¼Œç„¶åä»¥äººç±»å¯è¯»çš„æ–¹å¼è¾“å‡ºã€‚å½“æˆ‘ä»¬è¿è¡Œdis.dis, å®ƒè¾“å‡ºæ¯ä¸ªå­—èŠ‚ç çš„è§£é‡Šã€‚&gt;&gt;&gt; dis.dis(cond) 2 0 LOAD_CONST 1 (3) 3 STORE_FAST 0 (x) 3 6 LOAD_FAST 0 (x) 9 LOAD_CONST 2 (5) 12 COMPARE_OP 0 (&lt;) 15 POP_JUMP_IF_FALSE 22 4 18 LOAD_CONST 3 ('yes') 21 RETURN_VALUE 6 &gt;&gt; 22 LOAD_CONST 4 ('no') 25 RETURN_VALUE 26 LOAD_CONST 0 (None) 29 RETURN_VALUEè¿™äº›éƒ½æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿè®©æˆ‘ä»¬ä»¥ç¬¬ä¸€æ¡æŒ‡ä»¤LOAD_CONSTä¸ºä¾‹å­ã€‚ç¬¬ä¸€åˆ—çš„æ•°å­—ï¼ˆ2ï¼‰è¡¨ç¤ºå¯¹åº”æºä»£ç çš„è¡Œæ•°ã€‚ç¬¬äºŒåˆ—çš„æ•°å­—æ˜¯å­—èŠ‚ç çš„ç´¢å¼•ï¼Œå‘Šè¯‰æˆ‘ä»¬æŒ‡ä»¤LOAD_CONSTåœ¨0ä½ç½®ã€‚ç¬¬ä¸‰åˆ—æ˜¯æŒ‡ä»¤æœ¬èº«å¯¹åº”çš„äººç±»å¯è¯»çš„åå­—ã€‚å¦‚æœç¬¬å››åˆ—å­˜åœ¨ï¼Œå®ƒè¡¨ç¤ºæŒ‡ä»¤çš„å‚æ•°ã€‚å¦‚æœç¬¬5åˆ—å­˜åœ¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªå…³äºå‚æ•°æ˜¯ä»€ä¹ˆçš„æç¤ºã€‚è€ƒè™‘è¿™ä¸ªå­—èŠ‚ç çš„å‰å‡ ä¸ªå­—èŠ‚ï¼š[100, 1, 0, 125, 0, 0]ã€‚è¿™6ä¸ªå­—èŠ‚è¡¨ç¤ºä¸¤æ¡å¸¦å‚æ•°çš„æŒ‡ä»¤ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨dis.opnameï¼Œä¸€ä¸ªå­—èŠ‚åˆ°å¯è¯»å­—ç¬¦ä¸²çš„æ˜ å°„ï¼Œæ¥æ‰¾åˆ°æŒ‡ä»¤100å’ŒæŒ‡ä»¤125ä»£è¡¨æ˜¯ä»€ä¹ˆï¼š&gt;&gt;&gt; dis.opname[100]'LOAD_CONST'&gt;&gt;&gt; dis.opname[125]'STORE_FAST'ç¬¬äºŒå’Œç¬¬ä¸‰ä¸ªå­—èŠ‚ â€” 1 ï¼Œ0 â€”æ˜¯LOAD_CONSTçš„å‚æ•°ï¼Œç¬¬äº”å’Œç¬¬å…­ä¸ªå­—èŠ‚ â€” 0ï¼Œ0 â€” æ˜¯STORE_FASTçš„å‚æ•°ã€‚å°±åƒæˆ‘ä»¬å‰é¢çš„å°ä¾‹å­ï¼ŒLOAD_CONSTéœ€è¦çŸ¥é“çš„åˆ°å“ªå»æ‰¾å¸¸é‡ï¼ŒSTORE_FASTéœ€è¦æ‰¾åˆ°åå­—ã€‚ï¼ˆPythonçš„LOAD_CONSTå’Œæˆ‘ä»¬å°ä¾‹å­ä¸­çš„LOAD_VALUEä¸€æ ·ï¼ŒLOAD_FASTå’ŒLOAD_NAMEä¸€æ ·ï¼‰ã€‚æ‰€ä»¥è¿™å…­ä¸ªå­—èŠ‚ä»£è¡¨ç¬¬ä¸€è¡Œæºä»£ç x = 3.(ä¸ºä»€ä¹ˆç”¨ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºæŒ‡ä»¤çš„å‚æ•°ï¼Ÿå¦‚æœPythonä½¿ç”¨ä¸€ä¸ªå­—èŠ‚ï¼Œæ¯ä¸ªcode objectä½ åªèƒ½æœ‰256ä¸ªå¸¸é‡/åå­—ï¼Œè€Œç”¨ä¸¤ä¸ªå­—èŠ‚ï¼Œå°±å¢åŠ åˆ°äº†256çš„å¹³æ–¹ï¼Œ65536ä¸ªï¼‰ã€‚Conditionals and Loopsåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬çš„è§£é‡Šå™¨åªèƒ½ä¸€æ¡æ¥ç€ä¸€æ¡çš„æ‰§è¡ŒæŒ‡ä»¤ã€‚è¿™æœ‰ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šæƒ³å¤šæ¬¡æ‰§è¡ŒæŸä¸ªæŒ‡ä»¤ï¼Œæˆ–è€…åœ¨ç‰¹å®šçš„æ¡ä»¶ä¸‹ç•¥è¿‡å®ƒä»¬ã€‚ä¸ºäº†å¯ä»¥å†™å¾ªç¯å’Œåˆ†æ”¯ç»“æ„ï¼Œè§£é‡Šå™¨å¿…é¡»èƒ½å¤Ÿåœ¨æŒ‡ä»¤ä¸­è·³è½¬ã€‚åœ¨æŸç§ç¨‹åº¦ä¸Šï¼ŒPythonåœ¨å­—èŠ‚ç ä¸­ä½¿ç”¨GOTOè¯­å¥æ¥å¤„ç†å¾ªç¯å’Œåˆ†æ”¯ï¼è®©æˆ‘ä»¬å†çœ‹ä¸€ä¸ªcondå‡½æ•°çš„åæ±‡ç¼–ç»“æœï¼š&gt;&gt;&gt; dis.dis(cond) 2 0 LOAD_CONST 1 (3) 3 STORE_FAST 0 (x) 3 6 LOAD_FAST 0 (x) 9 LOAD_CONST 2 (5) 12 COMPARE_OP 0 (&lt;) 15 POP_JUMP_IF_FALSE 22 4 18 LOAD_CONST 3 ('yes') 21 RETURN_VALUE 6 &gt;&gt; 22 LOAD_CONST 4 ('no') 25 RETURN_VALUE 26 LOAD_CONST 0 (None) 29 RETURN_VALUEç¬¬ä¸‰è¡Œçš„æ¡ä»¶è¡¨è¾¾å¼if x &lt; 5è¢«ç¼–è¯‘æˆå››æ¡æŒ‡ä»¤ï¼šLOAD_FAST, LOAD_CONST, COMPARE_OPå’Œ POP_JUMP_IF_FALSEã€‚x &lt; 5å¯¹åº”åŠ è½½xï¼ŒåŠ è½½5ï¼Œæ¯”è¾ƒè¿™ä¸¤ä¸ªå€¼ã€‚æŒ‡ä»¤POP_JUMP_IF_FALSEå®Œæˆifè¯­å¥ã€‚è¿™æ¡æŒ‡ä»¤æŠŠæ ˆé¡¶çš„å€¼å¼¹å‡ºï¼Œå¦‚æœå€¼ä¸ºçœŸï¼Œä»€ä¹ˆéƒ½ä¸å‘ç”Ÿã€‚å¦‚æœå€¼ä¸ºå‡ï¼Œè§£é‡Šå™¨ä¼šè·³è½¬åˆ°å¦ä¸€æ¡æŒ‡ä»¤ã€‚è¿™æ¡å°†è¢«åŠ è½½çš„æŒ‡ä»¤ç§°ä¸ºè·³è½¬ç›®æ ‡ï¼Œå®ƒä½œä¸ºæŒ‡ä»¤POP_JUMPçš„å‚æ•°ã€‚è¿™é‡Œï¼Œè·³è½¬ç›®æ ‡æ˜¯22ï¼Œç´¢å¼•ä¸º22çš„æŒ‡ä»¤æ˜¯LOAD_CONST,å¯¹åº”æºç çš„ç¬¬6è¡Œã€‚ï¼ˆdisç”¨&gt;&gt;æ ‡è®°è·³è½¬ç›®æ ‡ã€‚ï¼‰å¦‚æœX &lt; 5ä¸ºå‡ï¼Œè§£é‡Šå™¨ä¼šå¿½ç•¥ç¬¬å››è¡Œï¼ˆreturn yesï¼‰,ç›´æ¥è·³è½¬åˆ°ç¬¬6è¡Œï¼ˆreturn \"no\"ï¼‰ã€‚å› æ­¤è§£é‡Šå™¨é€šè¿‡è·³è½¬æŒ‡ä»¤é€‰æ‹©æ€§çš„æ‰§è¡ŒæŒ‡ä»¤ã€‚Pythonçš„å¾ªç¯ä¹Ÿä¾èµ–äºè·³è½¬ã€‚åœ¨ä¸‹é¢çš„å­—èŠ‚ç ä¸­ï¼Œwhile x &lt; 5è¿™ä¸€è¡Œäº§ç”Ÿäº†å’Œif x &lt; 10å‡ ä¹ä¸€æ ·çš„å­—èŠ‚ç ã€‚åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œè§£é‡Šå™¨éƒ½æ˜¯å…ˆæ‰§è¡Œæ¯”è¾ƒï¼Œç„¶åæ‰§è¡ŒPOP_JUMP_IF_FALSEæ¥æ§åˆ¶ä¸‹ä¸€æ¡æ‰§è¡Œå“ªä¸ªæŒ‡ä»¤ã€‚ç¬¬å››è¡Œçš„æœ€åä¸€æ¡å­—èŠ‚ç JUMP_ABSOLUT(å¾ªç¯ä½“ç»“æŸçš„åœ°æ–¹ï¼‰ï¼Œè®©è§£é‡Šå™¨è¿”å›åˆ°å¾ªç¯å¼€å§‹çš„ç¬¬9æ¡æŒ‡ä»¤å¤„ã€‚å½“ x &lt; 10å˜ä¸ºå‡ï¼ŒPOP_JUMP_IF_FALSEä¼šè®©è§£é‡Šå™¨è·³åˆ°å¾ªç¯çš„ç»ˆæ­¢å¤„ï¼Œç¬¬34æ¡æŒ‡ä»¤ã€‚&gt;&gt;&gt; def loop():... x = 1... while x &lt; 5:... x = x + 1... return x...&gt;&gt;&gt; dis.dis(loop) 2 0 LOAD_CONST 1 (1) 3 STORE_FAST 0 (x) 3 6 SETUP_LOOP 26 (to 35) &gt;&gt; 9 LOAD_FAST 0 (x) 12 LOAD_CONST 2 (5) 15 COMPARE_OP 0 (&lt;) 18 POP_JUMP_IF_FALSE 34 4 21 LOAD_FAST 0 (x) 24 LOAD_CONST 1 (1) 27 BINARY_ADD 28 STORE_FAST 0 (x) 31 JUMP_ABSOLUTE 9 &gt;&gt; 34 POP_BLOCK 5 &gt;&gt; 35 LOAD_FAST 0 (x) 38 RETURN_VALUEExplore Bytecodeæˆ‘é¼“åŠ±ä½ ç”¨dis.disæ¥è¯•è¯•ä½ è‡ªå·±å†™çš„å‡½æ•°ã€‚ä¸€äº›æœ‰è¶£çš„é—®é¢˜å€¼å¾—æ¢ç´¢ï¼š å¯¹è§£é‡Šå™¨è€Œè¨€forå¾ªç¯å’Œwhileå¾ªç¯æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ èƒ½ä¸èƒ½å†™å‡ºä¸¤ä¸ªä¸åŒå‡½æ•°ï¼Œå´èƒ½äº§ç”Ÿç›¸åŒçš„å­—èŠ‚ç ? elifæ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Ÿåˆ—è¡¨æ¨å¯¼å‘¢ï¼ŸFramesåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº†Pythonè™šæ‹Ÿæœºæ˜¯ä¸€ä¸ªæ ˆæœºå™¨ã€‚å®ƒèƒ½é¡ºåºæ‰§è¡ŒæŒ‡ä»¤ï¼Œåœ¨æŒ‡ä»¤é—´è·³è½¬ï¼Œå‹å…¥æˆ–å¼¹å‡ºæ ˆå€¼ã€‚ä½†æ˜¯è¿™å’Œæˆ‘ä»¬å¿ƒæƒ³çš„è§£é‡Šå™¨è¿˜æœ‰ä¸€å®šè·ç¦»ã€‚åœ¨å‰é¢çš„é‚£ä¸ªä¾‹å­ä¸­ï¼Œæœ€åä¸€æ¡æŒ‡ä»¤æ˜¯RETURN_VALUE,å®ƒå’Œreturnè¯­å¥æƒ³å¯¹åº”ã€‚ä½†æ˜¯å®ƒè¿”å›åˆ°å“ªé‡Œå»å‘¢ï¼Ÿä¸ºäº†å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¿…é¡»ä¸¥å¢åŠ ä¸€å±‚å¤æ‚æ€§ï¼šframeã€‚ä¸€ä¸ªframeæ˜¯ä¸€äº›ä¿¡æ¯çš„é›†åˆå’Œä»£ç çš„æ‰§è¡Œä¸Šä¸‹æ–‡ã€‚framesåœ¨Pythonä»£ç æ‰§è¡Œæ—¶åŠ¨æ€çš„åˆ›å»ºå’Œé”€æ¯ã€‚æ¯ä¸ªframeå¯¹åº”å‡½æ•°çš„ä¸€æ¬¡è°ƒç”¨ã€‚â€” æ‰€ä»¥æ¯ä¸ªframeåªæœ‰ä¸€ä¸ªcode objectä¸ä¹‹å…³è”ï¼Œè€Œä¸€ä¸ªcode objectå¯ä»¥å¾ˆå¤šframeã€‚æ¯”å¦‚ä½ æœ‰ä¸€ä¸ªå‡½æ•°é€’å½’çš„è°ƒç”¨è‡ªå·±10æ¬¡ï¼Œè¿™æ—¶æœ‰11ä¸ªframeã€‚æ€»çš„æ¥è¯´ï¼ŒPythonç¨‹åºçš„æ¯ä¸ªä½œç”¨åŸŸæœ‰ä¸€ä¸ªframeï¼Œæ¯”å¦‚ï¼Œæ¯ä¸ªmoduleï¼Œæ¯ä¸ªå‡½æ•°è°ƒç”¨ï¼Œæ¯ä¸ªç±»å®šä¹‰ã€‚Frameå­˜åœ¨äºè°ƒç”¨æ ˆä¸­ï¼Œä¸€ä¸ªå’Œæˆ‘ä»¬ä¹‹å‰è®¨è®ºçš„å®Œå…¨ä¸åŒçš„æ ˆã€‚ï¼ˆä½ æœ€ç†Ÿæ‚‰çš„æ ˆå°±æ˜¯è°ƒç”¨æ ˆï¼Œå°±æ˜¯ä½ ç»å¸¸çœ‹åˆ°çš„å¼‚å¸¸å›æº¯ï¼Œæ¯ä¸ªä»¥â€File â€˜program.pyâ€™â€œå¼€å§‹çš„å›æº¯å¯¹åº”ä¸€ä¸ªframeã€‚ï¼‰è§£é‡Šå™¨åœ¨æ‰§è¡Œå­—èŠ‚ç æ—¶æ“ä½œçš„æ ˆï¼Œæˆ‘ä»¬å«å®ƒæ•°æ®æ ˆã€‚å…¶å®è¿˜æœ‰ç¬¬ä¸‰ä¸ªæ ˆï¼Œå«åšå—æ ˆï¼Œç”¨äºç‰¹å®šçš„æ§åˆ¶æµå—ï¼Œæ¯”å¦‚å¾ªç¯å’Œå¼‚å¸¸å¤„ç†ã€‚è°ƒç”¨æ ˆä¸­çš„æ¯ä¸ªframeéƒ½æœ‰å®ƒè‡ªå·±çš„æ•°æ®æ ˆå’Œå—æ ˆã€‚è®©æˆ‘ä»¬ç”¨ä¸€ä¸ªå…·ä½“çš„ä¾‹å­æ¥è¯´æ˜ã€‚å‡è®¾Pythonè§£é‡Šå™¨æ‰§è¡Œåˆ°æ ‡è®°ä¸º3çš„åœ°æ–¹ã€‚è§£é‡Šå™¨æ­£åœ¨fooå‡½æ•°çš„è°ƒç”¨ä¸­ï¼Œå®ƒæ¥ç€è°ƒç”¨barã€‚ä¸‹é¢æ˜¯frameè°ƒç”¨æ ˆï¼Œå—æ ˆå’Œæ•°æ®æ ˆçš„ç¤ºæ„å›¾ã€‚æˆ‘ä»¬æ„Ÿå…´è¶£çš„æ˜¯è§£é‡Šå™¨å…ˆä»æœ€åº•ä¸‹çš„foo()å¼€å§‹ï¼Œæ¥ç€æ‰§è¡Œfooçš„å‡½æ•°ä½“ï¼Œç„¶ååˆ°è¾¾barã€‚&gt;&gt;&gt; def bar(y):... z = y + 3 # &lt;--- (3) ... and the interpreter is here.... return z...&gt;&gt;&gt; def foo():... a = 1... b = 2... return a + bar(b) # &lt;--- (2) ... which is returning a call to bar ......&gt;&gt;&gt; foo() # &lt;--- (1) We're in the middle of a call to foo ...3ç°åœ¨ï¼Œè§£é‡Šå™¨åœ¨barå‡½æ•°çš„è°ƒç”¨ä¸­ã€‚è°ƒç”¨æ ˆä¸­æœ‰3ä¸ªframï¼šä¸€ä¸ªå¯¹åº”äºmoduleå±‚ï¼Œä¸€ä¸ªå¯¹åº”å‡½æ•°foo,åˆ«ä¸€ä¸ªå¯¹åº”å‡½æ•°barã€‚(Figure 1.2)ä¸€æ—¦barè¿”å›ï¼Œä¸å®ƒå¯¹åº”çš„frameå°±ä¼šä»è°ƒç”¨æ ˆä¸­å¼¹å‡ºå¹¶ä¸¢å¼ƒã€‚å­—èŠ‚ç æŒ‡ä»¤RETURN_VALUEå‘Šè¯‰è§£é‡Šå™¨åœ¨frameé—´ä¼ é€’ä¸€ä¸ªå€¼ã€‚é¦–å…ˆï¼Œå®ƒæŠŠä½äºè°ƒç”¨æ ˆæ ˆé¡¶çš„frameä¸­çš„æ•°æ®æ ˆçš„æ ˆé¡¶å€¼å¼¹å‡ºã€‚ç„¶åæŠŠæ•´ä¸ªframeå¼¹å‡ºä¸¢å¼ƒã€‚æœ€åæŠŠè¿™ä¸ªå€¼å‹åˆ°ä¸‹ä¸€ä¸ªframeçš„æ•°æ®æ ˆä¸­ã€‚å½“Ned Batchelderå’Œæˆ‘åœ¨å†™Byterunæ—¶ï¼Œå¾ˆé•¿ä¸€æ®µæ—¶é—´æˆ‘ä»¬çš„å®ç°ä¸­ä¸€ç›´æœ‰ä¸ªé‡å¤§çš„é”™è¯¯ã€‚æˆ‘ä»¬æ•´ä¸ªè™šæ‹Ÿæœºä¸­åªæœ‰ä¸€ä¸ªæ•°æ®æ ˆï¼Œè€Œä¸æ˜¯æ¯ä¸ªframeéƒ½æœ‰ä¸ªä¸€ä¸ªã€‚æˆ‘ä»¬åšäº†å¾ˆå¤šæµ‹è¯•ï¼ŒåŒæ—¶åœ¨Byterunå’ŒçœŸæ­£çš„Pythonä¸Šï¼Œä¸ºäº†ä¿è¯ç»“æœä¸€è‡´ã€‚æˆ‘ä»¬å‡ ä¹é€šè¿‡äº†æ‰€æœ‰æµ‹è¯•ï¼Œåªæœ‰ä¸€æ ·ä¸œè¥¿ä¸èƒ½é€šè¿‡ï¼Œé‚£å°±æ˜¯ç”Ÿæˆå™¨ã€‚æœ€åï¼Œé€šè¿‡ä»”ç»†çš„é˜…è¯»Cpythonçš„æºç ï¼Œæˆ‘ä»¬å‘ç°äº†é”™è¯¯æ‰€åœ¨ã€‚æŠŠæ•°æ®æ ˆç§»åˆ°æ¯ä¸ªframeå°±è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚å›å¤´åœ¨çœ‹çœ‹è¿™ä¸ªbugï¼Œæˆ‘æƒŠè®¶çš„å‘ç°PythonçœŸçš„å¾ˆå°‘ä¾èµ–äºæ¯ä¸ªframeæœ‰ä¸€ä¸ªæ•°æ®æ ˆè¿™ä¸ªç‰¹æ€§ã€‚åœ¨Pythonä¸­å‡ ä¹æ‰€æœ‰çš„æ“ä½œéƒ½ä¼šæ¸…ç©ºæ•°æ®æ ˆï¼Œæ‰€ä»¥æ‰€æœ‰çš„frameå…¬ç”¨ä¸€ä¸ªæ•°æ®æ ˆæ˜¯æ²¡é—®é¢˜çš„ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå½“baræ‰§è¡Œå®Œåï¼Œå®ƒçš„æ•°æ®æ ˆä¸ºç©ºã€‚å³ä½¿fooå…¬ç”¨è¿™ä¸€ä¸ªæ ˆï¼Œå®ƒçš„å€¼ä¹Ÿä¸ä¼šå—å½±å“ã€‚ç„¶è€Œï¼Œå¯¹åº”ç”Ÿæˆå™¨ï¼Œä¸€ä¸ªå…³é”®çš„ç‰¹ç‚¹æ˜¯å®ƒèƒ½æš‚åœä¸€ä¸ªframeçš„æ‰§è¡Œï¼Œè¿”å›åˆ°å…¶ä»–çš„frameï¼Œä¸€æ®µæ—¶é—´åå®ƒèƒ½è¿”å›åˆ°åŸæ¥çš„frameï¼Œå¹¶ä»¥å®ƒç¦»å¼€æ—¶çš„åŒæ ·çš„çŠ¶æ€ç»§ç»­æ‰§è¡Œã€‚Byterunç°åœ¨æˆ‘ä»¬æœ‰è¶³å¤Ÿçš„Pythonè§£é‡Šå™¨çš„çŸ¥è¯†èƒŒæ™¯å»è€ƒå¯ŸByterunã€‚Byterunä¸­æœ‰å››ç§å¯¹è±¡ã€‚ VirtualMachineç±»ï¼Œå®ƒç®¡ç†é«˜å±‚ç»“æ„ï¼Œframeè°ƒç”¨æ ˆï¼ŒæŒ‡ä»¤åˆ°æ“ä½œçš„æ˜ å°„ã€‚è¿™æ˜¯ä¸€ä¸ªæ¯”å‰é¢Inteprterå¯¹è±¡æ›´å¤æ‚çš„ç‰ˆæœ¬ã€‚ Frameç±»ï¼Œæ¯ä¸ªFrameç±»éƒ½æœ‰ä¸€ä¸ªcode objectï¼Œå¹¶ä¸”ç®¡ç†è€…å…¶ä»–ä¸€äº›å¿…è¦çš„çŠ¶æ€ä¿¡æ¯ï¼Œå…¨å±€å’Œå±€éƒ¨å‘½åç©ºé—´ï¼ŒæŒ‡å‘è°ƒç”¨å®ƒçš„frameçš„æŒ‡é’ˆå’Œæœ€åæ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ã€‚ Functionç±»ï¼Œå®ƒè¢«ç”¨æ¥ä»£æ›¿çœŸæ­£çš„Pythonå‡½æ•°ã€‚å›æƒ³ä¸€ä¸‹ï¼Œè°ƒç”¨å‡½æ•°æ—¶ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„frameã€‚æˆ‘ä»¬è‡ªå·±å®ç°Functionï¼Œæ‰€ä»¥æˆ‘ä»¬æ§åˆ¶æ–°frameçš„åˆ›å»ºã€‚ Blockç±»ï¼Œå®ƒåªæ˜¯åŒ…è£…äº†ä»£ç å—çš„3ä¸ªå±æ€§ã€‚ï¼ˆä»£ç å—çš„ç»†èŠ‚ä¸æ˜¯è§£é‡Šå™¨çš„æ ¸å¿ƒï¼Œæˆ‘ä»¬ä¸ä¼šèŠ±æ—¶é—´åœ¨å®ƒèº«ä¸Šï¼ŒæŠŠå®ƒåˆ—åœ¨è¿™é‡Œï¼Œæ˜¯å› ä¸ºByterunéœ€è¦å®ƒã€‚ï¼‰The VirtualMachine Classç¨‹åºè¿è¡Œæ—¶åªæœ‰ä¸€ä¸ªVirtualMachineè¢«åˆ›å»ºï¼Œå› ä¸ºæˆ‘ä»¬åªæœ‰ä¸€ä¸ªè§£é‡Šå™¨ã€‚VirtualMachineä¿å­˜è°ƒç”¨æ ˆï¼Œå¼‚å¸¸çŠ¶æ€ï¼Œåœ¨frameä¸­ä¼ é€’çš„è¿”å›å€¼ã€‚å®ƒçš„å…¥å£ç‚¹æ˜¯run_codeæ–¹æ³•ï¼Œå®ƒä»¥ç¼–è¯‘åçš„code objectä¸ºå‚æ•°ï¼Œä»¥åˆ›å»ºä¸€ä¸ªframeä¸ºå¼€å§‹ï¼Œç„¶åè¿è¡Œè¿™ä¸ªframeã€‚è¿™ä¸ªframeå¯èƒ½å†åˆ›å»ºå‡ºæ–°çš„frameï¼›è°ƒç”¨æ ˆéšç€ç¨‹åºçš„è¿è¡Œå¢é•¿ç¼©çŸ­ã€‚å½“ç¬¬ä¸€ä¸ªframeè¿”å›æ—¶ï¼Œæ‰§è¡Œç»“æŸã€‚class VirtualMachineError(Exception): passclass VirtualMachine(object): def __init__(self): self.frames = [] # The call stack of frames. self.frame = None # The current frame. self.return_value = None self.last_exception = None def run_code(self, code, global_names=None, local_names=None): \"\"\" An entry point to execute code using the virtual machine.\"\"\" frame = self.make_frame(code, global_names=global_names, local_names=local_names) self.run_frame(frame)The Frame Classæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥å†™Frameå¯¹è±¡ã€‚frameæ˜¯ä¸€ä¸ªå±æ€§çš„é›†åˆï¼Œå®ƒæ²¡æœ‰ä»»ä½•æ–¹æ³•ã€‚å‰é¢æåˆ°è¿‡ï¼Œè¿™äº›å±æ€§åŒ…æ‹¬ç”±ç¼–è¯‘å™¨ç”Ÿæˆçš„code objectï¼›å±€éƒ¨ï¼Œå…¨å±€å’Œå†…ç½®å‘½åç©ºé—´ï¼›å‰ä¸€ä¸ªframeçš„å¼•ç”¨ï¼›ä¸€ä¸ªæ•°æ®æ ˆï¼›ä¸€ä¸ªå—æ ˆï¼›æœ€åæ‰§è¡Œçš„æŒ‡ä»¤ã€‚ï¼ˆå¯¹äºå†…ç½®å‘½åç©ºé—´æˆ‘ä»¬éœ€è¦å¤šåšä¸€ç‚¹å·¥ä½œï¼ŒPythonå¯¹å¾…è¿™ä¸ªå‘½åç©ºé—´ä¸åŒï¼›ä½†è¿™ä¸ªç»†èŠ‚å¯¹æˆ‘ä»¬çš„è™šæ‹Ÿæœºä¸é‡è¦ã€‚ï¼‰class Frame(object): def __init__(self, code_obj, global_names, local_names, prev_frame): self.code_obj = code_obj self.global_names = global_names self.local_names = local_names self.prev_frame = prev_frame self.stack = [] if prev_frame: self.builtin_names = prev_frame.builtin_names else: self.builtin_names = local_names['__builtins__'] if hasattr(self.builtin_names, '__dict__'): self.builtin_names = self.builtin_names.__dict__ self.last_instruction = 0 self.block_stack = []æ¥ç€ï¼Œæˆ‘ä»¬åœ¨è™šæ‹Ÿæœºä¸­å¢åŠ å¯¹frameçš„æ“ä½œã€‚è¿™æœ‰3ä¸ªå¸®åŠ©å‡½æ•°ï¼šä¸€ä¸ªåˆ›å»ºæ–°çš„frameçš„æ–¹æ³•ï¼Œå’Œå‹æ ˆå’Œå‡ºæ ˆçš„æ–¹æ³•ã€‚ç¬¬å››ä¸ªå‡½æ•°ï¼Œrun_frame,å®Œæˆæ‰§è¡Œframeçš„ä¸»è¦å·¥ä½œï¼Œå¾…ä¼šæˆ‘ä»¬å†è®¨è®ºè¿™ä¸ªæ–¹æ³•ã€‚class VirtualMachine(object): [... snip ...] # Frame manipulation def make_frame(self, code, callargs={}, global_names=None, local_names=None): if global_names is not None and local_names is not None: local_names = global_names elif self.frames: global_names = self.frame.global_names local_names = {} else: global_names = local_names = { '__builtins__': __builtins__, '__name__': '__main__', '__doc__': None, '__package__': None, } local_names.update(callargs) frame = Frame(code, global_names, local_names, self.frame) return frame def push_frame(self, frame): self.frames.append(frame) self.frame = frame def pop_frame(self): self.frames.pop() if self.frames: self.frame = self.frames[-1] else: self.frame = None def run_frame(self): pass # we'll come back to this shortlyThe Function ClassFunctionçš„å®ç°æœ‰ç‚¹æ‰­æ›²ï¼Œä½†æ˜¯å¤§éƒ¨åˆ†çš„ç»†èŠ‚å¯¹ç†è§£è§£é‡Šå™¨ä¸é‡è¦ã€‚é‡è¦çš„æ˜¯å½“è°ƒç”¨å‡½æ•°æ—¶ â€” __call__æ–¹æ³•è¢«è°ƒç”¨ â€” å®ƒåˆ›å»ºä¸€ä¸ªæ–°çš„Frameå¹¶è¿è¡Œå®ƒã€‚class Function(object): \"\"\" Create a realistic function object, defining the things the interpreter expects. \"\"\" __slots__ = [ 'func_code', 'func_name', 'func_defaults', 'func_globals', 'func_locals', 'func_dict', 'func_closure', '__name__', '__dict__', '__doc__', '_vm', '_func', ] def __init__(self, name, code, globs, defaults, closure, vm): \"\"\"You don't need to follow this closely to understand the interpreter.\"\"\" self._vm = vm self.func_code = code self.func_name = self.__name__ = name or code.co_name self.func_defaults = tuple(defaults) self.func_globals = globs self.func_locals = self._vm.frame.f_locals self.__dict__ = {} self.func_closure = closure self.__doc__ = code.co_consts[0] if code.co_consts else None # Sometimes, we need a real Python function. This is for that. kw = { 'argdefs': self.func_defaults, } if closure: kw['closure'] = tuple(make_cell(0) for _ in closure) self._func = types.FunctionType(code, globs, **kw) def __call__(self, *args, **kwargs): \"\"\"When calling a Function, make a new frame and run it.\"\"\" callargs = inspect.getcallargs(self._func, *args, **kwargs) # Use callargs to provide a mapping of arguments: values to pass into the new # frame. frame = self._vm.make_frame( self.func_code, callargs, self.func_globals, {} ) return self._vm.run_frame(frame)def make_cell(value): \"\"\"Create a real Python closure and grab a cell.\"\"\" # Thanks to Alex Gaynor for help with this bit of twistiness. fn = (lambda x: lambda: x)(value) return fn.__closure__[0]æ¥ç€ï¼Œå›åˆ°VirtualMachineå¯¹è±¡ï¼Œæˆ‘ä»¬å¯¹æ•°æ®æ ˆçš„æ“ä½œä¹Ÿå¢åŠ ä¸€äº›å¸®åŠ©æ–¹æ³•ã€‚å­—èŠ‚ç æ“ä½œçš„æ ˆæ€»æ˜¯åœ¨å½“å‰frameçš„æ•°æ®æ ˆã€‚è¿™è®©æˆ‘ä»¬èƒ½å®ŒæˆPOP_TOP,LOAD_FAST,å¹¶ä¸”è®©å…¶ä»–æ“ä½œæ ˆçš„æŒ‡ä»¤å¯è¯»æ€§æ›´é«˜ã€‚class VirtualMachine(object): [... snip ...] # Data stack manipulation def top(self): return self.frame.stack[-1] def pop(self): return self.frame.stack.pop() def push(self, *vals): self.frame.stack.extend(vals) def popn(self, n): \"\"\"Pop a number of values from the value stack. A list of `n` values is returned, the deepest value first. \"\"\" if n: ret = self.frame.stack[-n:] self.frame.stack[-n:] = [] return ret else: return []åœ¨æˆ‘ä»¬è¿è¡Œframeä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜éœ€ä¸¤ä¸ªæ–¹æ³•ã€‚ç¬¬ä¸€ä¸ªæ–¹æ³•ï¼Œparse_byte_and_args,ä»¥ä¸€ä¸ªå­—èŠ‚ç ä¸ºè¾“å…¥ï¼Œå…ˆæ£€æŸ¥å®ƒæ˜¯å¦æœ‰å‚æ•°ï¼Œå¦‚æœæœ‰ï¼Œå°±è§£æå®ƒçš„å‚æ•°ã€‚è¿™ä¸ªæ–¹æ³•åŒæ—¶ä¹Ÿæ›´æ–°frameçš„last_instructionå±æ€§ï¼Œå®ƒæŒ‡å‘æœ€åæ‰§è¡Œçš„æŒ‡ä»¤ã€‚ä¸€æ¡æ²¡æœ‰å‚æ•°çš„æŒ‡ä»¤åªæœ‰ä¸€ä¸ªå­—èŠ‚é•¿åº¦ï¼Œè€Œæœ‰å‚æ•°çš„å­—èŠ‚æœ‰3ä¸ªå­—èŠ‚é•¿ã€‚å‚æ•°çš„æ„ä¹‰ä¾èµ–äºæŒ‡ä»¤æ˜¯ä»€ä¹ˆã€‚æ¯”å¦‚ï¼Œå‰é¢è¯´è¿‡ï¼ŒæŒ‡ä»¤POP_JUMP_IF_FALSE,å®ƒçš„å‚æ•°æŒ‡çš„æ˜¯è·³è½¬ç›®æ ‡ã€‚BUILD_LIST, å®ƒçš„å‚æ•°æ˜¯åˆ—è¡¨çš„ä¸ªæ•°ã€‚LOAD_CONST,å®ƒçš„å‚æ•°æ˜¯å¸¸é‡çš„ç´¢å¼•ã€‚ä¸€äº›æŒ‡ä»¤ç”¨ç®€å•çš„æ•°å­—ä½œä¸ºå‚æ•°ã€‚å¯¹äºå¦ä¸€äº›ï¼Œè™šæ‹Ÿæœºéœ€è¦ä¸€ç‚¹åŠªåŠ›å»å‘ç°å®ƒæ„ä¹‰ã€‚æ ‡å‡†åº“ä¸­çš„dismoduleä¸­æœ‰ä¸€ä¸ªå¤‡å¿˜å•è§£é‡Šä»€ä¹ˆå‚æ•°æœ‰ä»€ä¹ˆæ„æ€ï¼Œè¿™è®©æˆ‘ä»¬çš„ä»£ç æ›´åŠ ç®€æ´ã€‚æ¯”å¦‚ï¼Œåˆ—è¡¨dis.hasnameå‘Šè¯‰æˆ‘ä»¬LOAD_NAME, IMPORT_NAME,LOAD_GLOBAL,å’Œå¦å¤–çš„9ä¸ªæŒ‡ä»¤éƒ½æœ‰åŒæ ·çš„æ„æ€ï¼šåå­—åˆ—è¡¨çš„ç´¢å¼•ã€‚class VirtualMachine(object): [... snip ...] def parse_byte_and_args(self): f = self.frame opoffset = f.last_instruction byteCode = f.code_obj.co_code[opoffset] f.last_instruction += 1 byte_name = dis.opname[byteCode] if byteCode &gt;= dis.HAVE_ARGUMENT: # index into the bytecode arg = f.code_obj.co_code[f.last_instruction:f.last_instruction+2] f.last_instruction += 2 # advance the instruction pointer arg_val = arg[0] + (arg[1] * 256) if byteCode in dis.hasconst: # Look up a constant arg = f.code_obj.co_consts[arg_val] elif byteCode in dis.hasname: # Look up a name arg = f.code_obj.co_names[arg_val] elif byteCode in dis.haslocal: # Look up a local name arg = f.code_obj.co_varnames[arg_val] elif byteCode in dis.hasjrel: # Calculate a relative jump arg = f.last_instruction + arg_val else: arg = arg_val argument = [arg] else: argument = [] return byte_name, argumentä¸‹ä¸€ä¸ªæ–¹æ³•æ˜¯dispatch,å®ƒæŸ¥çœ‹ç»™å®šçš„æŒ‡ä»¤å¹¶æ‰§è¡Œç›¸åº”çš„æ“ä½œã€‚åœ¨CPythonä¸­ï¼Œè¿™ä¸ªåˆ†æ´¾å‡½æ•°ç”¨ä¸€ä¸ªå·¨å¤§çš„switchè¯­å¥å®Œæˆï¼Œæœ‰è¶…è¿‡1500è¡Œçš„ä»£ç ã€‚å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬ç”¨çš„æ˜¯Pythonï¼Œæˆ‘ä»¬çš„ä»£ç ä¼šç®€æ´çš„å¤šã€‚æˆ‘ä»¬ä¼šä¸ºæ¯ä¸€ä¸ªå­—èŠ‚ç åå­—å®šä¹‰ä¸€ä¸ªæ–¹æ³•ï¼Œç„¶åç”¨getattræ¥æŸ¥æ‰¾ã€‚å°±åƒæˆ‘ä»¬å‰é¢çš„å°è§£é‡Šå™¨ä¸€æ ·ï¼Œå¦‚æœä¸€æ¡æŒ‡ä»¤å«åšFOO_BARï¼Œé‚£ä¹ˆå®ƒå¯¹åº”çš„æ–¹æ³•å°±æ˜¯byte_FOO_BARã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å…ˆæŠŠè¿™äº›æ–¹æ³•å½“åšä¸€ä¸ªé»‘ç›’å­ã€‚æ¯ä¸ªæŒ‡ä»¤æ–¹æ³•éƒ½ä¼šè¿”å›Noneæˆ–è€…ä¸€ä¸ªå­—ç¬¦ä¸²why,æœ‰äº›æƒ…å†µä¸‹è™šæ‹Ÿæœºéœ€è¦è¿™ä¸ªé¢å¤–whyä¿¡æ¯ã€‚è¿™äº›æŒ‡ä»¤æ–¹æ³•çš„è¿”å›å€¼ï¼Œä»…ä½œä¸ºè§£é‡Šå™¨çŠ¶æ€çš„å†…éƒ¨æŒ‡ç¤ºï¼Œåƒä¸‡ä¸è¦å’Œæ‰§è¡Œframeçš„è¿”å›å€¼ç›¸æ··æ·†ã€‚class VirtualMachine(object): [... snip ...] def dispatch(self, byte_name, argument): \"\"\" Dispatch by bytename to the corresponding methods. Exceptions are caught and set on the virtual machine.\"\"\" # When later unwinding the block stack, # we need to keep track of why we are doing it. why = None try: bytecode_fn = getattr(self, 'byte_%s' % byte_name, None) if bytecode_fn is None: if byte_name.startswith('UNARY_'): self.unaryOperator(byte_name[6:]) elif byte_name.startswith('BINARY_'): self.binaryOperator(byte_name[7:]) else: raise VirtualMachineError( \"unsupported bytecode type: %s\" % byte_name ) else: why = bytecode_fn(*argument) except: # deal with exceptions encountered while executing the op. self.last_exception = sys.exc_info()[:2] + (None,) why = 'exception' return why def run_frame(self, frame): \"\"\"Run a frame until it returns (somehow). Exceptions are raised, the return value is returned. \"\"\" self.push_frame(frame) while True: byte_name, arguments = self.parse_byte_and_args() why = self.dispatch(byte_name, arguments) # Deal with any block management we need to do while why and frame.block_stack: why = self.manage_block_stack(why) if why: break self.pop_frame() if why == 'exception': exc, val, tb = self.last_exception e = exc(val) e.__traceback__ = tb raise e return self.return_valueThe Block Classåœ¨æˆ‘ä»¬å®Œæˆæ¯ä¸ªå­—èŠ‚ç æ–¹æ³•å‰ï¼Œæˆ‘ä»¬ç®€å•çš„è®¨è®ºä¸€ä¸‹å—ã€‚ä¸€ä¸ªå—è¢«ç”¨äºæŸç§æ§åˆ¶æµï¼Œç‰¹åˆ«æ˜¯å¼‚å¸¸å¤„ç†å’Œå¾ªç¯ã€‚å®ƒè´Ÿè´£ä¿è¯å½“æ“ä½œå®Œæˆåæ•°æ®æ ˆå¤„äºæ­£ç¡®çš„çŠ¶æ€ã€‚æ¯”å¦‚ï¼Œåœ¨ä¸€ä¸ªå¾ªç¯ä¸­ï¼Œä¸€ä¸ªç‰¹æ®Šçš„è¿­ä»£å™¨ä¼šå­˜åœ¨æ ˆä¸­ï¼Œå½“å¾ªç¯å®Œæˆæ—¶å®ƒä»æ ˆä¸­å¼¹å‡ºã€‚è§£é‡Šå™¨éœ€è¦æ£€æŸ¥å¾ªç¯ä»åœ¨ç»§ç»­è¿˜æ˜¯å·²ç»åœæ­¢ã€‚ä¸ºäº†è·Ÿè¸ªè¿™äº›é¢å¤–çš„ä¿¡æ¯ï¼Œè§£é‡Šå™¨è®¾ç½®äº†ä¸€ä¸ªæ ‡å¿—æ¥æŒ‡ç¤ºå®ƒçš„çŠ¶æ€ã€‚æˆ‘ä»¬ç”¨ä¸€ä¸ªå˜é‡whyå®ç°è¿™ä¸ªæ ‡å¿—ï¼Œå®ƒå¯ä»¥Noneæˆ–è€…æ˜¯ä¸‹é¢å‡ ä¸ªå­—ç¬¦ä¸²è¿™ä¸€ï¼Œ\"continue\", \"break\",\"excption\",returnã€‚ä»–ä»¬æŒ‡ç¤ºå¯¹å—æ ˆå’Œæ•°æ®æ ˆè¿›è¡Œä»€ä¹ˆæ“ä½œã€‚å›åˆ°æˆ‘ä»¬è¿­ä»£å™¨çš„ä¾‹å­ï¼Œå¦‚æœå—æ ˆçš„æ ˆé¡¶æ˜¯ä¸€ä¸ªloopå—ï¼Œwhyæ˜¯continue,è¿­ä»£å™¨å°±å› è¯¥ä¿å­˜åœ¨æ•°æ®æ ˆä¸Šï¼Œä¸æ˜¯å¦‚æœwhyæ˜¯break,è¿­ä»£å™¨å°±ä¼šè¢«å¼¹å‡ºã€‚å—æ“ä½œçš„ç»†èŠ‚æ¯”è¾ƒç²¾å¯†ï¼Œæˆ‘ä»¬ä¸ä¼šèŠ±æ—¶é—´åœ¨è¿™ä¸Šé¢ï¼Œä½†æ˜¯æœ‰å…´è¶£çš„è¯»è€…å€¼å¾—ä»”ç»†çš„çœ‹çœ‹ã€‚Block = collections.namedtuple(\"Block\", \"type, handler, stack_height\")class VirtualMachine(object): [... snip ...] # Block stack manipulation def push_block(self, b_type, handler=None): level = len(self.frame.stack) self.frame.block_stack.append(Block(b_type, handler, stack_height)) def pop_block(self): return self.frame.block_stack.pop() def unwind_block(self, block): \"\"\"Unwind the values on the data stack corresponding to a given block.\"\"\" if block.type == 'except-handler': # The exception itself is on the stack as type, value, and traceback. offset = 3 else: offset = 0 while len(self.frame.stack) &gt; block.level + offset: self.pop() if block.type == 'except-handler': traceback, value, exctype = self.popn(3) self.last_exception = exctype, value, traceback def manage_block_stack(self, why): \"\"\" \"\"\" frame = self.frame block = frame.block_stack[-1] if block.type == 'loop' and why == 'continue': self.jump(self.return_value) why = None return why self.pop_block() self.unwind_block(block) if block.type == 'loop' and why == 'break': why = None self.jump(block.handler) return why if (block.type in ['setup-except', 'finally'] and why == 'exception'): self.push_block('except-handler') exctype, value, tb = self.last_exception self.push(tb, value, exctype) self.push(tb, value, exctype) # yes, twice why = None self.jump(block.handler) return why elif block.type == 'finally': if why in ('return', 'continue'): self.push(self.return_value) self.push(why) why = None self.jump(block.handler) return why return whyThe Instructionså‰©ä¸‹äº†çš„å°±æ˜¯å®Œæˆé‚£äº›æŒ‡ä»¤æ–¹æ³•äº†ï¼šbyte_LOAD_FAST,byte_BINARY_MODULOç­‰ç­‰ã€‚è€Œè¿™äº›æŒ‡ä»¤çš„å®ç°å¹¶ä¸æ˜¯å¾ˆæœ‰è¶£ï¼Œè¿™é‡Œæˆ‘ä»¬åªå±•ç¤ºäº†ä¸€å°éƒ¨åˆ†ï¼Œå®Œæ•´çš„å®ç°åœ¨è¿™å„¿ï¼ˆè¶³å¤Ÿæ‰§è¡Œæˆ‘ä»¬å‰é¢æ‰€è¿°çš„æ‰€æœ‰ä»£ç äº†ã€‚ï¼‰class VirtualMachine(object): [... snip ...] ## Stack manipulation def byte_LOAD_CONST(self, const): self.push(const) def byte_POP_TOP(self): self.pop() ## Names def byte_LOAD_NAME(self, name): frame = self.frame if name in frame.f_locals: val = frame.f_locals[name] elif name in frame.f_globals: val = frame.f_globals[name] elif name in frame.f_builtins: val = frame.f_builtins[name] else: raise NameError(\"name '%s' is not defined\" % name) self.push(val) def byte_STORE_NAME(self, name): self.frame.f_locals[name] = self.pop() def byte_LOAD_FAST(self, name): if name in self.frame.f_locals: val = self.frame.f_locals[name] else: raise UnboundLocalError( \"local variable '%s' referenced before assignment\" % name ) self.push(val) def byte_STORE_FAST(self, name): self.frame.f_locals[name] = self.pop() def byte_LOAD_GLOBAL(self, name): f = self.frame if name in f.f_globals: val = f.f_globals[name] elif name in f.f_builtins: val = f.f_builtins[name] else: raise NameError(\"global name '%s' is not defined\" % name) self.push(val) ## Operators BINARY_OPERATORS = { 'POWER': pow, 'MULTIPLY': operator.mul, 'FLOOR_DIVIDE': operator.floordiv, 'TRUE_DIVIDE': operator.truediv, 'MODULO': operator.mod, 'ADD': operator.add, 'SUBTRACT': operator.sub, 'SUBSCR': operator.getitem, 'LSHIFT': operator.lshift, 'RSHIFT': operator.rshift, 'AND': operator.and_, 'XOR': operator.xor, 'OR': operator.or_, } def binaryOperator(self, op): x, y = self.popn(2) self.push(self.BINARY_OPERATORS[op](x, y)) COMPARE_OPERATORS = [ operator.lt, operator.le, operator.eq, operator.ne, operator.gt, operator.ge, lambda x, y: x in y, lambda x, y: x not in y, lambda x, y: x is y, lambda x, y: x is not y, lambda x, y: issubclass(x, Exception) and issubclass(x, y), ] def byte_COMPARE_OP(self, opnum): x, y = self.popn(2) self.push(self.COMPARE_OPERATORS[opnum](x, y)) ## Attributes and indexing def byte_LOAD_ATTR(self, attr): obj = self.pop() val = getattr(obj, attr) self.push(val) def byte_STORE_ATTR(self, name): val, obj = self.popn(2) setattr(obj, name, val) ## Building def byte_BUILD_LIST(self, count): elts = self.popn(count) self.push(elts) def byte_BUILD_MAP(self, size): self.push({}) def byte_STORE_MAP(self): the_map, val, key = self.popn(3) the_map[key] = val self.push(the_map) def byte_LIST_APPEND(self, count): val = self.pop() the_list = self.frame.stack[-count] # peek the_list.append(val) ## Jumps def byte_JUMP_FORWARD(self, jump): self.jump(jump) def byte_JUMP_ABSOLUTE(self, jump): self.jump(jump) def byte_POP_JUMP_IF_TRUE(self, jump): val = self.pop() if val: self.jump(jump) def byte_POP_JUMP_IF_FALSE(self, jump): val = self.pop() if not val: self.jump(jump) ## Blocks def byte_SETUP_LOOP(self, dest): self.push_block('loop', dest) def byte_GET_ITER(self): self.push(iter(self.pop())) def byte_FOR_ITER(self, jump): iterobj = self.top() try: v = next(iterobj) self.push(v) except StopIteration: self.pop() self.jump(jump) def byte_BREAK_LOOP(self): return 'break' def byte_POP_BLOCK(self): self.pop_block() ## Functions def byte_MAKE_FUNCTION(self, argc): name = self.pop() code = self.pop() defaults = self.popn(argc) globs = self.frame.f_globals fn = Function(name, code, globs, defaults, None, self) self.push(fn) def byte_CALL_FUNCTION(self, arg): lenKw, lenPos = divmod(arg, 256) # KWargs not supported here posargs = self.popn(lenPos) func = self.pop() frame = self.frame retval = func(*posargs) self.push(retval) def byte_RETURN_VALUE(self): self.return_value = self.pop() return \"return\"Dynamic Typing: What the Compiler Doesnâ€™t Knowä½ å¯èƒ½å¬è¿‡Pythonæ˜¯ä¸€ç§åŠ¨æ€è¯­è¨€ â€” æ˜¯å®ƒæ˜¯åŠ¨æ€ç±»å‹çš„ã€‚åœ¨æˆ‘ä»¬å»ºé€ è§£é‡Šå™¨çš„è¿‡ç¨‹ä¸­ï¼Œå·²ç»æµéœ²å‡ºè¿™ä¸ªæè¿°ã€‚åŠ¨æ€çš„ä¸€ä¸ªæ„æ€æ˜¯å¾ˆå¤šå·¥ä½œåœ¨è¿è¡Œæ—¶å®Œæˆã€‚å‰é¢æˆ‘ä»¬çœ‹åˆ°Pythonçš„ç¼–è¯‘å™¨æ²¡æœ‰å¾ˆå¤šå…³äºä»£ç çœŸæ­£åšä»€ä¹ˆçš„ä¿¡æ¯ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œè€ƒè™‘ä¸‹é¢è¿™ä¸ªç®€å•çš„å‡½æ•°modã€‚å®ƒåŒºä¸¤ä¸ªå‚æ•°ï¼Œè¿”å›å®ƒä»¬çš„æ¨¡è¿ç®—å€¼ã€‚ä»å®ƒçš„å­—èŠ‚ç ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°å˜é‡aå’Œbé¦–å…ˆè¢«åŠ è½½ï¼Œç„¶åå­—èŠ‚ç BINAY_MODULOå®Œæˆè¿™ä¸ªæ¨¡è¿ç®—ã€‚&gt;&gt;&gt; def mod(a, b):... return a % b&gt;&gt;&gt; dis.dis(mod) 2 0 LOAD_FAST 0 (a) 3 LOAD_FAST 1 (b) 6 BINARY_MODULO 7 RETURN_VALUE&gt;&gt;&gt; mod(19, 5)4è®¡ç®—19 % 5å¾—4ï¼Œâ€” ä¸€ç‚¹ä¹Ÿä¸å¥‡æ€ªã€‚å¦‚æœæˆ‘ä»¬ç”¨ä¸åŒç±»çš„å‚æ•°å‘¢ï¼Ÿ&gt;&gt;&gt; mod(\"by%sde\", \"teco\")'bytecode'åˆšæ‰å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿä½ å¯èƒ½è§è¿‡è¿™æ ·çš„è¯­æ³•ï¼Œæ ¼å¼åŒ–å­—ç¬¦ä¸²ã€‚&gt;&gt;&gt; print(\"by%sde\" % \"teco\")bytecodeç”¨ç¬¦å·%å»æ ¼å¼åŒ–å­—ç¬¦ä¸²ä¼šè°ƒç”¨å­—èŠ‚ç BUNARY_MODULO.å®ƒå–æ ˆé¡¶çš„ä¸¤ä¸ªå€¼æ±‚æ¨¡ï¼Œä¸ç®¡è¿™ä¸¤ä¸ªå€¼æ˜¯å­—ç¬¦ä¸²ï¼Œæ•°å­—æˆ–æ˜¯ä½ è‡ªå·±å®šä¹‰çš„ç±»çš„å®ä¾‹ã€‚å­—èŠ‚ç åœ¨å‡½æ•°ç¼–è¯‘æ—¶ç”Ÿæˆï¼ˆæˆ–è€…è¯´ï¼Œå‡½æ•°å®šä¹‰æ—¶ï¼‰ç›¸åŒçš„å­—èŠ‚ç ä¼šç”¨äºä¸åŒç±»çš„å‚æ•°ã€‚Pythonçš„ç¼–è¯‘å™¨å…³äºå­—èŠ‚ç çš„åŠŸèƒ½çŸ¥é“çš„å¾ˆå°‘ã€‚è€Œå–å†³äºè§£é‡Šå™¨æ¥å†³å®šBINAYR_MODULOåº”ç”¨äºä»€ä¹ˆç±»å‹çš„å¯¹è±¡å¹¶å®ŒæˆçœŸç¡®çš„æ“ä½œã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆPythonè¢«æè¿°ä¸ºåŠ¨æ€ç±»å‹ï¼šç›´åˆ°ä½ è¿è¡Œå‰ä½ ä¸å¿…çŸ¥é“è¿™ä¸ªå‡½æ•°å‚æ•°çš„ç±»å‹ã€‚ç›¸åï¼Œåœ¨ä¸€ä¸ªé™æ€ç±»å‹è¯­è¨€ä¸­ï¼Œç¨‹åºå‘˜éœ€è¦å‘Šè¯‰ç¼–è¯‘å™¨å‚æ•°çš„ç±»å‹æ˜¯ä»€ä¹ˆï¼ˆæˆ–è€…ç¼–è¯‘å™¨è‡ªå·±æ¨æ–­å‡ºå‚æ•°çš„ç±»å‹ã€‚ï¼‰ç¼–è¯‘å™¨çš„æ— çŸ¥æ˜¯ä¼˜åŒ–Pythonçš„ä¸€ä¸ªæŒ‘æˆ˜ â€” åªçœ‹å­—èŠ‚ç ï¼Œè€Œä¸çœŸæ­£è¿è¡Œå®ƒï¼Œä½ å°±ä¸çŸ¥é“æ¯æ¡å­—èŠ‚ç åœ¨å¹²ä»€ä¹ˆï¼ä½ å¯ä»¥å®šä¹‰ä¸€ä¸ªç±»ï¼Œå®ç°__mod__æ–¹æ³•ï¼Œå½“ä½ å¯¹è¿™ä¸ªç±»çš„å®ä¾‹ä½¿ç”¨%æ—¶ï¼ŒPythonå°±ä¼šè‡ªåŠ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚æ‰€ä»¥ï¼ŒBINARY_MODULOå…¶å®å¯ä»¥è¿è¡Œä»»ä½•ä»£ç ã€‚çœ‹çœ‹ä¸‹é¢çš„ä»£ç ï¼Œç¬¬ä¸€ä¸ªa % bçœ‹èµ·æ¥æ²¡æœ‰ç”¨ã€‚def mod(a,b): a % b return a %bä¸å¹¸çš„æ˜¯ï¼Œå¯¹è¿™æ®µä»£ç è¿›è¡Œé™æ€åˆ†æ â€” ä¸è¿è¡Œå®ƒ â€” ä¸èƒ½ç¡®å®šç¬¬ä¸€ä¸ªa % bæ²¡æœ‰åšä»»ä½•äº‹ã€‚ç”¨ %è°ƒç”¨__mod__å¯èƒ½ä¼šå†™ä¸€ä¸ªæ–‡ä»¶ï¼Œæˆ–æ˜¯å’Œç¨‹åºçš„å…¶ä»–éƒ¨åˆ†äº¤äº’ï¼Œæˆ–è€…å…¶ä»–ä»»ä½•å¯ä»¥åœ¨Pythonä¸­å®Œæˆçš„äº‹ã€‚å¾ˆéš¾ä¼˜åŒ–ä¸€ä¸ªä½ ä¸çŸ¥é“å®ƒä¼šåšä»€ä¹ˆçš„å‡½æ•°ã€‚åœ¨Russell Powerå’ŒAlex Rubinsteynçš„ä¼˜ç§€è®ºæ–‡ä¸­å†™é“ï¼Œâ€œæˆ‘ä»¬å¯ç”¨å¤šå¿«çš„é€Ÿåº¦è§£é‡ŠPythonï¼Ÿâ€ï¼Œä»–ä»¬è¯´ï¼Œâ€œåœ¨æ™®éç¼ºä¹ç±»å‹ä¿¡æ¯ä¸‹ï¼Œæ¯æ¡æŒ‡ä»¤å¿…é¡»è¢«çœ‹ä½œä¸€ä¸ªINVOKE_ARBITRARY_METHODã€‚â€ConclusionByterunæ˜¯ä¸€ä¸ªæ¯”CPythonå®¹æ˜“ç†è§£çš„ç®€æ´çš„Pythonè§£é‡Šå™¨ã€‚Byterunå¤åˆ¶äº†CPythonçš„ä¸»è¦ç»“æ„ï¼šä¸€ä¸ªåŸºäºæ ˆçš„æŒ‡ä»¤é›†ç§°ä¸ºå­—èŠ‚ç ï¼Œå®ƒä»¬é¡ºåºæ‰§è¡Œæˆ–åœ¨æŒ‡ä»¤é—´è·³è½¬ï¼Œå‘æ ˆä¸­å‹å…¥å’Œä»ä¸­å¼¹å‡ºæ•°æ®ã€‚è§£é‡Šå™¨éšç€å‡½æ•°å’Œç”Ÿæˆå™¨çš„è°ƒç”¨å’Œè¿”å›ï¼ŒåŠ¨æ€çš„åˆ›å»ºï¼Œé”€æ¯frameï¼Œå¹¶åœ¨frameé—´è·³è½¬ã€‚Byterunä¹Ÿæœ‰ç€å’ŒçœŸæ­£è§£é‡Šå™¨ä¸€æ ·çš„é™åˆ¶ï¼šå› ä¸ºPythonä½¿ç”¨åŠ¨æ€ç±»å‹ï¼Œè§£é‡Šå™¨å¿…é¡»åœ¨è¿è¡Œæ—¶å†³å®šæŒ‡ä»¤çš„æ­£ç¡®è¡Œä¸ºã€‚æˆ‘é¼“åŠ±ä½ å»åæ±‡ç¼–ä½ çš„ç¨‹åºï¼Œç„¶åç”¨Byterunæ¥è¿è¡Œã€‚ä½ å¾ˆå¿«ä¼šå‘ç°è¿™ä¸ªç¼©çŸ­ç‰ˆçš„Byterunæ‰€æ²¡æœ‰å®ç°çš„æŒ‡ä»¤ã€‚å®Œæ•´çš„å®ç°åœ¨è¿™é‡Œæˆ–è€…ä»”ç»†é˜…è¯»çœŸæ­£çš„CPythonè§£é‡Šå™¨ceval.c,ä½ ä¹Ÿå¯ä»¥å®ç°è‡ªå·±çš„è§£é‡Šå™¨ï¼AcknowledgementsThanks to Ned Batchelder for originating this project and guiding my contributions, Michael Arntzenius for his help debugging the code and editing the prose, Leta Montopoli for her edits, and the entire Recurse Center community for their support and interest. Any errors are my own.A Python Interpreter Written in Python is maintained by qingyunha.This page was generated by GitHub Pages using the Cayman theme by Jason Long." }, { "title": "å¸¸ç”¨è½¯ä»¶è®°å½•", "url": "/posts/DailySoftware/", "categories": "", "tags": "MacOS, è½¯ä»¶", "date": "2021-06-28 00:29:28 +0800", "snippet": "è®°å½•ä¸€ä¸‹è¿™å‡ å¹´ä¸­é»‘è‹¹æœå¸¸ç”¨çš„ä¸€äº›è½¯ä»¶ä»¥å¤‡åç”¨ã€‚æ€»çš„æ¥è¯´ï¼šèŠ±é’±ä¹°æœåŠ¡ï¼Œä½¿ç”¨ä½“éªŒæœ€å¥½çš„å¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½æ˜¯æ”¶è´¹è½¯ä»¶ï¼Œå†é’±åŒ…é¼“é¼“çš„æƒ…å†µä¸‹ç›´æ¥ä½¿ç”¨æ”¶è´¹è½¯ä»¶æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹çš„æœ€ä¼˜è§£ã€‚å·¥å…·MindMasterï¼šäº¿å›¾æ€ç»´å¯¼å›¾ åœ°å€ï¼šäº¿å›¾è„‘å›¾MindMaster å¤šå¹³å°æ€ç»´å¯¼å›¾è½¯ä»¶ï¼Œè®©æ‚¨çš„åˆ›æ„ç ´èŒ§è€Œå‡º (edrawsoft.cn) ä»·æ ¼ï¼šæ”¶è´¹ å¹³å°ï¼šMacï¼ŒIOSï¼ŒWindowsï¼ŒLinuxè·¨å¹³å°ã€æ”¯æŒåœ¨çº¿ç¼–è¾‘ã€å®Œæ•´çš„ LaTeX æ”¯æŒç­‰ç­‰ï¼Œä¸”æ”¯æŒä¸€æ¬¡æ€§ä¹°æ–­å¹¶æä¾›åç»­æ›´æ–°ï¼Œé¿å…æœˆä¾›å®°ç¾Šã€‚æ–‡å­—Texpadï¼šLaTeXç¼–è¾‘å™¨ åœ°å€ï¼šTexpad Â· Smoothest way to write LaTeX ä»·æ ¼ï¼šæ”¶è´¹ å¹³å°ï¼šMacï¼ŒIOSï¼ŒWindowséå¸¸æ£’çš„æœ¬åœ° LaTeX ç¼–è¾‘å™¨ï¼Œæœ‰ç€å®æ—¶é¢„è§ˆï¼Œæç¤ºï¼Œè‡ªåŠ¨è¡¥å…¨ç­‰ç‰¹æ€§ã€‚ç•Œé¢ç¾è§‚ç®€æ´ï¼Œå¼€ç®±å³ç”¨ã€‚Overleafï¼šåœ¨çº¿LaTeXè®ºæ–‡åä½œ åœ°å€ï¼šhttps://www.overleaf.com/ ä»·æ ¼ï¼šå…è´¹+ å¹³å°ï¼šç½‘é¡µç‰ˆåŠŸèƒ½æ²¡æœ‰ Texpad å¼ºå¤§ï¼Œä½†æ˜¯ä¸»æ‰“å¤šäººåœ¨çº¿åä½œåŠŸèƒ½ï¼Œæ”¯æŒå¤šäººè¯„è®ºã€å›å¤ï¼Œä¿®æ”¹è¯„å®¡ã€å†å²è®°å½•ç­‰ç­‰åä½œä¸“ç”¨åŠŸèƒ½ã€‚ç¼ºç‚¹æ˜¯ä¸å®¹æ˜“å¤„ç†å¤§æ–‡ä»¶ï¼Œå¦‚æœæ˜¯æƒ³å†™æ¯•ä¸šè®ºæ–‡ä¹‹ç±»çš„ï¼Œè¿˜æ˜¯æ¨èæœ¬åœ°ï¼Œä¸ç„¶åœ¨çº¿ç¼–è¯‘å®¹æ˜“è¶…æ—¶å‡ºé”™ç­‰ã€‚æ¨èç”¨è¯¥å·¥å…·è¿›è¡Œè®ºæ–‡çš„åä½œä¿®æ”¹ï¼Œå…¶å®ƒæƒ…å†µå°±ç®—äº†ã€‚Typoraï¼šä¼˜ç§€çš„markdownç¼–è¾‘å™¨ åœ°å€ï¼šTypora â€” a markdown editor, markdown reader. ä»·æ ¼ï¼šå…è´¹ å¹³å°ï¼šMacï¼ŒLinuxï¼ŒWindowsæ²¡å•¥å¥½å¤šè¯´çš„ï¼Œåœ¨å•æ–‡ä»¶ç¼–è¾‘ä¸Šè¯¥è½¯ä»¶å¯ä»¥ç§°ä½œé¡¶çº§ï¼Œä¸å…·å¤‡æ–‡ä»¶ç»„ç»‡ã€ç®¡ç†åŠŸèƒ½ã€‚ä½œä¸ºé»˜è®¤çš„ markdown æ–‡ä»¶æ‰“å¼€è½¯ä»¶æ˜¯æœ€ä½³çš„ã€‚Notionï¼šå¥½ç”¨çš„ç¬”è®°è½¯ä»¶ åœ°å€ï¼šNotion â€“ The all-in-one workspace for your notes, tasks, wikis, and databases. ä»·æ ¼ï¼šå…è´¹+ å¹³å°ï¼šMacï¼ŒWindowsï¼ŒAndroidï¼ŒIOSï¼Œéå®˜æ–¹ Linux ç‰ˆæœ¬ ç¼ºç‚¹ ï¼šNotion å‘˜å·¥èƒ½å¤Ÿçœ‹åˆ°ä½ çš„æ‰€æœ‰æ–‡æ¡£ï¼ ä¹‹å‰æ˜¯ç”¨å°è±¡ç¬”è®°çš„ï¼Œä½†æ˜¯åé¢å°è±¡ç¬”è®°æ›´æ–°çš„åŠŸèƒ½è¶Šæ¥è¶Šç”¨ä¸åˆ°ï¼Œä¸€äº›å°ç»†èŠ‚åœ°æ–¹åˆä¸ä¿®æ”¹ï¼Œå°±æ¢è¿‡æ¥äº†ã€‚Notion Enhancerï¼šè®© Notion å˜å¾—æ›´å¥½ç”¨å®˜æ–¹ç‰ˆæœ¬ç¼ºä¹å¾ˆå¤šåŠŸèƒ½ï¼Œæ¯”å¦‚æ‚¬æµ®æ–‡ç« ç›®å½•ï¼Œå¤šæ ‡ç­¾é¡µæ‰“å¼€ç­‰ï¼Œä¸»é¢˜ä¹Ÿå¾ˆç¼ºä¹ã€‚ç›®å‰æ²¡çœ‹åˆ°å®˜æ–¹æœ‰å¢åŠ è¿™äº›åŠŸèƒ½çš„æ„æ„¿ã€‚ åœ°å€ï¼šhttps://github.com/notion-enhancer/notion-enhancer ä»·æ ¼ï¼šå…è´¹ å¹³å°ï¼šMacï¼ŒWindowsï¼ŒLinuxJoplinï¼šéšç§ã€è‡ªå»ºç¬”è®°æ”¯æŒåŠ å¯†ã€è‡ªå»ºåŒæ­¥æœåŠ¡å™¨ç­‰ï¼Œæ³¨é‡éšç§çš„ä¸äºŒä¹‹é€‰ã€‚ åœ°å€ï¼šhttps://joplinapp.org/ ä»·æ ¼ï¼šå…è´¹ï¼Œå®˜æ–¹åŒæ­¥äº‘æ”¶è´¹ï¼Œä½†æ˜¯å¯ä»¥è‡ªå»ºåŒæ­¥æœåŠ¡å™¨ å¹³å°ï¼šMacï¼ŒWindowsï¼ŒLinux" }, { "title": "Jellyfin: ä¸ªäººåª’ä½“ä¸­å¿ƒæ­å»º", "url": "/posts/Jellyfin-Tutorial/", "categories": "", "tags": "Linux, å¨±ä¹", "date": "2021-06-11 22:40:09 +0800", "snippet": " Jellyfinæ˜¯ä¸€ä¸ªå¼€æºå…è´¹çš„åª’ä½“è§£å†³æ–¹æ¡ˆï¼šè®©ä½ èƒ½å¤Ÿå®Œç¾æ§åˆ¶ä½ çš„åª’ä½“æ–‡ä»¶ã€‚å®ƒèƒ½å¤Ÿå®ç°ä»ä¸ªäººæœåŠ¡å™¨ï¼Œæ²¡æœ‰ä»»ä½•é™„åŠ æ¡ä»¶åœ°ä¸²æµè‡³ä»»ä½•è®¾å¤‡ã€‚Your mediaï¼Œyour serverï¼Œyour wayã€‚å¯ä»¥æŠŠJellyfinè§†ä½œä½ ä¸ªäººçš„çˆ±å¥‡è‰ºç­‰è§†é¢‘ç½‘ç«™ï¼å’Œä¼ ç»Ÿæ–‡ä»¶å¤¹ä¿å­˜è§†é¢‘ã€å½±ç‰‡ç­‰ç›¸æ¯”ï¼Œæœ‰ç€ä»¥ä¸‹ä¼˜ç‚¹ï¼š æ›´å¥½çš„ç»„ç»‡ä½ çš„åª’ä½“æ–‡ä»¶ï¼šèƒ½å¤Ÿä» IMDB ç­‰å½±ç‰‡ä¿¡æ¯ç½‘ç«™åŒ¹é…è§†é¢‘ç›¸å…³ä¿¡æ¯å¹¶å±•ç°å‡ºæ¥ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼šå­—å¹•ä¸‹è½½ï¼Œæµ·æŠ¥æ¨ªå¹…ä¸‹è½½ï¼Œæ¼”å‘˜ä¿¡æ¯æ‹‰å–ï¼Œç”µå½±ç®€ä»‹ã€ç”µè§†å‰§å­£é›†ä¿¡æ¯ç­‰è·å–ç­‰ã€‚ ä»»æ„è®¾å¤‡æµè§ˆå™¨å³å¯è§‚çœ‹ï¼šæ— éœ€é›†ä¸­åœ¨ä¸€å°è®¾å¤‡ä¸Šè§‚çœ‹ï¼Œåœ¨èƒ½å¤Ÿè®¿é—®åˆ°ä¸ªäºº Jellyfin æœåŠ¡å™¨çš„ä»»ä½•åœ°æ–¹éƒ½èƒ½å¤Ÿé€šè¿‡æµè§ˆå™¨è§‚çœ‹è§†é¢‘ã€‚ å¤šç”¨æˆ·ï¼šæ¯ä¸ªç”¨æˆ·æœ‰ç€ä¸åŒçš„èµ„æ–™åº“è®¿é—®æƒé™ï¼Œå„è‡ªçš„è§‚çœ‹è¿›åº¦å‡ç‹¬ç«‹ä¿å­˜ã€‚ æ”¯æŒä¸åŒç±»å‹çš„å½±éŸ³æ–‡ä»¶ï¼šç”µå½±ã€ç”µè§†å‰§ã€éŸ³ä¹ä»¥åŠåœ¨çº¿ç”µè§†èŠ‚ç›®ã€‚ å®˜æ–¹åœ¨çº¿ demoï¼šJellyfinæˆªå›¾ï¼š\t \t Jellyfin éƒ¨ç½²Jellyfin èƒ½å¤Ÿç›´æ¥é€šè¿‡åŒ…ç®¡ç†å™¨ç›´æ¥å®‰è£…ï¼Œå®˜æ–¹ä¹Ÿæä¾›äº†dockerå®¹å™¨é•œåƒï¼Œå› æ­¤ Jellyfin å¯ä»¥è¿è¡Œåœ¨ä»»ä½•å…·å¤‡ docker ç¯å¢ƒçš„åœ°æ–¹ï¼Œæ¯”å¦‚ä¸€å° VPS æˆ–è€…ç¾¤è¾‰è®¾å¤‡ç­‰ã€‚å—é™äºè®¾å¤‡é™åˆ¶ï¼Œè¿™é‡Œåªå±•ç¤ºåœ¨ VPS ä¸Šå€ŸåŠ© docker éƒ¨ç½² Jellyfin çš„æ–¹æ³•ã€‚VPS é€‰å–å…·ä½“çš„é…ç½®è¦æ±‚å–å†³äº Jellyfin çš„è®¾ç½®ï¼šæœåŠ¡ç«¯è§£ç è¿˜æ˜¯å®¢æˆ·ç«¯è§£ç ï¼Ÿè§†é¢‘è´¨é‡ï¼ˆåˆ†è¾¨ç‡ç­‰ï¼‰é«˜ä½ï¼ŸåŒæ—¶åœ¨çº¿è§‚çœ‹çš„äººæ•°ï¼Ÿå…·ä½“æƒ…å†µè¿˜æ˜¯éœ€è¦æ ¹æ®è‡ªå·±çš„è§†é¢‘èµ„æºæµ‹è¯•åæ‰èƒ½æœ‰ä¸ªå¤§æ¦‚ï¼Œè¿™é‡Œä»…ä¾›å‚è€ƒï¼Œæé†’ä¸€ä¸‹ VPS çš„é…ç½®å¯¹äºè§†é¢‘è§‚çœ‹çš„è§‚æ„Ÿæœ‰ç€å¾ˆå¤§å½±å“ã€‚è¿™é‡Œæ²¡æœ‰åšè¿‡å…·ä½“çš„å®éªŒï¼Œä»ä¸ªäººä½¿ç”¨ä½“éªŒæ¥çœ‹ï¼Œå¦‚æœåœ¨æœåŠ¡ç«¯è§£ç ï¼Œæœ€å¥½èƒ½å¤Ÿç”± GPU è¿›è¡Œç¡¬ä»¶åŠ é€Ÿï¼Œå•é  CPU è§£ç ä¼šæ¶ˆè€—å¤§é‡èµ„æºï¼Œå°¤å…¶æ˜¯ 4k è§†é¢‘ä¸‹ï¼ŒCPU è§£ç æ—¶æ‹–åŠ¨è§†é¢‘è¿›åº¦æ¡æ— æ³•åŠæ—¶å“åº”ï¼Œä¼šå¡é¡¿å‡ ç§’ï¼Œç”šè‡³æ— æ³•æµç•…æ’­æ”¾ï¼ŒGPU è§£ç å°±å¥½å¤šäº†ã€‚ç½‘ç»œæ–¹é¢ï¼ŒJellyfin å‡ æ¡£é»˜è®¤é…ç½®ï¼š1080p - 10~60 Mï¼Œ4k - 80~120 Mï¼ˆå–å†³äºè§†é¢‘çš„æœ€é«˜è´¨é‡ï¼‰ã€‚Jellyfin å®¹å™¨éƒ¨ç½² è¿™é‡Œè¯·ç›´æ¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š[Installing Jellyfin Documentation - Jellyfin Project](https://jellyfin.org/docs/general/administration/installing.html) ã€‚æ€»ä½“æµç¨‹åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š å®‰è£… docker ç¯å¢ƒï¼š[Install Docker Engine Docker Documentation](https://docs.docker.com/engine/install/) é…ç½® docker ç¯å¢ƒä¸‹çš„ç¡¬ä»¶åŠ é€Ÿã€å¯é€‰ã€‘ï¼š[Hardware Acceleration Documentation - Jellyfin Project](https://jellyfin.org/docs/general/administration/hardware-acceleration.html) é…ç½®å¹¶éƒ¨ç½² Jellyfin å®¹å™¨è¿™é‡Œç»™å‡ºä¸ªäººä½¿ç”¨çš„ docker éƒ¨ç½²å‘½ä»¤ï¼Œå…¶ä¸­ï¼š 3-7 è¡Œä¸º NVIDIA ç¡¬ä»¶åŠ é€Ÿæ‰€éœ€çš„å‚æ•°ï¼Œè§ä¸Šé¢ç¬¬ 2 ç‚¹ 10-13 è¡Œå°† VPS çš„å­˜å‚¨ç©ºé—´æŒ‚è½½åˆ°å®¹å™¨ä¸­ä»¥å®ç°æ•°æ®å­˜å‚¨ï¼Œé˜²æ­¢æ¯æ¬¡é‡å¯å®¹å™¨çš„æ•°æ®ä¸¢å¤±ã€‚å…¶ä¸­ï¼š /config ä¸º Jellyfin çš„é…ç½®ç›¸å…³ç›®å½•ï¼Œå°† /data/jellyfin/.jellyfin/config ä¿®æ”¹ä¸ºä»»æ„ä½ æƒ³ä½¿ç”¨çš„ç›®å½• /cache ä¸º Jellyfin çš„ç¼“å­˜ç›®å½•ï¼Œå°† /data/jellyfin/.jellyfin/cache ä¿®æ”¹ä¸ºä»»æ„ä½ æƒ³ä½¿ç”¨çš„ç›®å½• /media ä¸º Jellyfin çš„åª’ä½“ç›®å½•ï¼Œé‡Œé¢åº”è¯¥å­˜æ”¾ä½ çš„è§†é¢‘ã€éŸ³ä¹ç­‰æ–‡ä»¶ï¼Œå°† /data/jellyfin ä¿®æ”¹ä¸ºä½ æƒ³ä½¿ç”¨çš„ç›®å½• é»˜è®¤ç«¯å£ä¸º 8096ï¼Œæˆ–è€…é€šè¿‡ -p port:8096 å‚æ•°è‡ªå®šä¹‰ docker run -d \\ --name jellyfin \\ -e NVIDIA_DRIVER_CAPABILITIES=all \\ -e NVIDIA_VISIBLE_DEVICES=all \\ --gpus all \\ --device /dev/dri/renderD128:/dev/dri/renderD128 \\ --device /dev/dri/card0:/dev/dri/card0 \\ --user 0:0 \\ --net=host \\ --volume /data/jellyfin/.jellyfin/config:/config \\ --volume /data/jellyfin/.jellyfin/cache:/cache \\ --mount type=bind,source=/data/jellyfin,target=/media \\ --restart=unless-stopped \\ jellyfin/jellyfinJellyfin å¯èƒ½å­˜åœ¨çš„é—®é¢˜ æ— æ³•åˆ®å‰Šè§†é¢‘çš„å…ƒæ•°æ®ï¼šä¸€èˆ¬éƒ½æ˜¯å› ä¸ºç½‘ç»œåŸå› ï¼Œå¯¼è‡´æ— æ³•è®¿é—® IMDB ç­‰å…ƒæ•°æ®ç½‘ç«™ï¼Œæˆ–è€…è®¿é—®è¶…æ—¶ã€‚è™½ç„¶å¯ä»¥é€šè¿‡åˆç†è®¾ç½®ä»£ç†çš„æ–¹å¼è§£å†³ï¼Œä½†æ˜¯é‰´äº Jellyfin æœ¬èº«åœ¨å…ƒæ•°æ®ç®¡ç†ã€ä¿®æ”¹æ–¹é¢è¾ƒå¼±ï¼Œä¸å»ºè®®ä½¿ç”¨ä»£ç†æ–¹æ³•ã€‚è¯·å‚è€ƒä¸‹ä¸€èŠ‚ TinyMediaManager æ–¹æ³•ã€‚ æ— æ³•åŠæ—¶æ‰«ææ–‡ä»¶å¤¹çš„å˜åŒ–ï¼šåœ¨äººä¸ºä¿®æ”¹å…ƒæ•°æ®åï¼Œä¸»åŠ¨è§¦å‘é‡æ–°æ‰«æï¼Œæœ‰æ—¶å‘ç°ä¿®æ”¹åçš„å…ƒæ•°æ®å¹¶æ²¡æœ‰èµ·æ•ˆã€‚è¯¥é—®é¢˜äº¦æ˜¯ç”±äºç½‘ç»œåŸå› å¯¼è‡´ï¼Œæ— æ³•è”ç½‘è·å–å…ƒæ•°æ®å¯¼è‡´äº†æ— æ³•åŠæ—¶åˆ·æ–°ï¼ˆå³ä¾¿äººä¸ºä¿®æ”¹äº†ï¼‰ã€‚è¿™ç§æƒ…å†µéœ€è¦åœ¨åª’ä½“åº“è®¾ç½®ä¸­ï¼Œå°†è‡ªåŠ¨åˆ®å‰Šå…ƒæ•°æ®é€‰é¡¹å–æ¶ˆå‹¾é€‰ã€‚ å­—å¹•ä¸æ˜¾ç¤ºï¼šå­—å¹•åŠ è½½äº†ï¼Œä½†æ˜¯ä¸æ˜¾ç¤ºã€‚ä¸€èˆ¬æ˜¯ç”±äºå­—å¹•çš„å­—ä½“ç¼ºå¤±ã€‚é€šè¿‡ vim ä¹‹ç±»çš„çœ‹ä¸€ä¸‹å­—å¹•é‡Œé¢æ˜¯ä¸æ˜¯æŒ‡å®šäº†å­—ä½“ï¼Œç„¶ååœ¨ Jellyfin è®¾ç½®é‡Œï¼Œå‹¾é€‰å€™è¡¥å­—ä½“ï¼Œç„¶åé€‰æ‹©å€™è¡¥å­—ä½“æ–‡ä»¶å¤¹ï¼Œå†æŠŠç¼ºå¤±å­—ä½“æ”¾è¿›å»å³å¯ã€‚è§†é¢‘å…ƒæ•°æ®åˆ®å‰Šï¼šTinyMediaManagerTinyMediaManager æ˜¯ä¸€ä¸ªåŸºäº Java çš„åª’ä½“ç®¡ç†å·¥å…·ï¼Œèƒ½å¤Ÿä¸º Kodiï¼ŒMediaPortal ä»¥åŠ Plex ç­‰ä» TheMovieDBï¼ŒImdbï¼ŒOfdb ç­‰ç½‘ç«™åˆ®å‰Šåª’ä½“å…ƒæ•°æ®ã€‚ç›¸è¾ƒäº Jellyfin è‡ªå¸¦çš„åŠŸèƒ½ï¼Œè¯¥å·¥å…·æä¾›äº†æ›´ä¸°å¯Œçš„åˆ®å‰Šã€ä¿®æ”¹åŠŸèƒ½ï¼Œä¸”æ“ä½œç•Œé¢æ›´åŠ ç›´è§‚ã€‚å®˜ç½‘è§ï¼štinyMediaManager ï¼Œæˆªå›¾å¦‚ä¸‹ï¼šæ„Ÿè°¢ç¤¾åŒºï¼Œè®© TinyMediaManager èƒ½å¤Ÿä»¥å®¹å™¨çš„æ–¹å¼è·‘åœ¨æœåŠ¡å™¨ä¸Šï¼Œé€šè¿‡æµè§ˆå™¨å°±èƒ½å¤Ÿä½¿ç”¨ã€‚è¿™é‡Œä½¿ç”¨ dzhuang/tinymediamanager-docker: A repository for creating a docker container including TinyMediaManager with GUI interface. (github.com) ç‰ˆæœ¬ï¼Œä¸»è¦åŠ å…¥äº†ä¸­æ–‡å­—ä½“æ”¯æŒã€‚éƒ¨ç½²å‘½ä»¤å¦‚ä¸‹ï¼Œä¸»è¦å‚æ•°ï¼š ç«¯å£ä¸º 8095ï¼Œå°† -p 8095:5800 ä¿®æ”¹ä¸ºæƒ³ä½¿ç”¨çš„ç«¯å£å³å¯ã€‚ é…ç½®æ–‡ä»¶å¤¹ /config ï¼Œå°† /data/jellyfin/.tmm/config ä¿®æ”¹ä¸ºæƒ³ä½¿ç”¨çš„ç›®å½•å³å¯ã€‚è¯¥ç›®å½•ä¸ Jellyfin æ²¡æœ‰å…³è”ï¼Œå¯ä»¥ä»»æ„é€‰å–å¯ç”¨ç›®å½•ã€‚ åª’ä½“æ–‡ä»¶å¤¹ /media ï¼Œå°† /data/jellyfin ä¿®æ”¹ä¸ºæƒ³ä½¿ç”¨çš„ç›®å½•å³å¯ã€‚è¯¥ç›®å½•ä¸ Jellyfin ä¸­çš„åª’ä½“ç›®å½•éœ€è¦ä¿æŒä¸€è‡´ï¼docker run -p 8095:5800 --user 0:0 -v /data/jellyfin/.tmm/config:/config -v /data/jellyfin/:/media dzhuang/tinymediamanagerä¹‹ååœ¨è®¾ç½®ä¸­é…ç½®å¥½ ç”µå½±ã€å‰§ å„è‡ªçš„ç›®å½•ï¼Œç„¶åç‚¹å‡»æ›´æ–°æº æŒ‰é’®å°±å¯çœ‹åˆ°è‡ªå·±çš„è§†é¢‘æ–‡ä»¶ï¼Œå³é”®ä»»æ„èµ„æºå³å¯è¿›è¡Œä¸€ç³»åˆ—æ“ä½œã€‚ç½‘ç»œé—®é¢˜å¯ä»¥åœ¨è®¾ç½®ä¸­é…ç½®ä»£ç†è§£å†³ã€‚ TinyMediaManager éœ€è¦æ³¨æ„åª’ä½“æ–‡ä»¶å¤¹çš„è¯»å†™æƒé™ï¼å¦åˆ™ä¼šå¤±è´¥ã€‚è§†é¢‘ä¸‹è½½ç»„åˆï¼šFrostwire + TransmissionFrostwire æ˜¯ä¸€ä¸ªæä¾›äº† BT æœç´¢çš„ä¸‹è½½å®¢æˆ·ç«¯ï¼Œè¿™é‡Œå€Ÿç”¨å…¶æœç´¢åŠŸèƒ½å¯»æ‰¾è§†é¢‘èµ„æºï¼Œå®˜ç½‘ï¼šFrostWire - BitTorrent Client, Cloud Downloader, Media Player. 100% Free Download, No subscriptions required.Transmission æ˜¯ä¸€ä¸ªèƒ½å¤Ÿåœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œçš„ BT ä¸‹è½½å®¢æˆ·ç«¯ï¼Œé€šè¿‡ç½‘é¡µå³å¯ç®¡ç†ï¼Œè§æ•™ç¨‹ï¼šHow to set up transmission-daemon on a Raspberry Pi and control it via web interface - LinuxConfig.org\t \t\t åŸºæœ¬ä½¿ç”¨æµç¨‹ï¼š Frostwire ä¸Šæœç´¢ä½ æƒ³è¦çš„è§†é¢‘ å³é”®å¤åˆ¶ magent ä¿¡æ¯ åœ¨ Transmission ä¸­ä¸‹è½½ TinyMediaManager åˆ®å‰Š Jellyfin è§‚çœ‹çªç ´å†…ç½‘é™åˆ¶ï¼šZerotier/n2n/SoftEtherè¿™é‡Œä¸å†ä»‹ç»è¿™ä¸‰æ¬¾è½¯ä»¶ã€‚è€ƒè™‘åˆ° Zerotier èƒ½å¤Ÿä»¥æœ€é«˜æˆåŠŸç‡å®ç°è·¨ Nat ç›´è¿è€Œæ— éœ€è‡ªå·±çš„ä¸­è½¬æœåŠ¡å™¨ï¼Œå»ºè®®ä½¿ç”¨ Zerotier ä»¥èŠ‚çœæµé‡ã€‚è¯·å‚è€ƒä»¥ä¸‹åšå®¢ï¼š Zerotierï¼šç”¨ZeroTieræ­å»ºå±äºè‡ªå·±çš„è™šæ‹Ÿå±€åŸŸç½‘(VLAN) - çŸ¥ä¹ (zhihu.com) SoftEtherï¼šä½¿ç”¨ SoftEther VPN æ­å»ºè™šæ‹Ÿå±€åŸŸç½‘ - ç±³Vç±³ (mivm.cn) n2nï¼šn2nå®ç°å†…ç½‘ç©¿é€ - ç®€ä¹¦ (jianshu.com)SoftEther è‡ªå¯åŠ¨æ–°å»º /etc/init.d/vpnclient ï¼Œå†…å®¹å¦‚ä¸‹ï¼š#!/bin/sh# Start/stop the vpnclien daemon#### BEGIN INIT INFO# Provides: vpnclient# Required-Start: $local_fs $syslog $time# Required-Stop: $local_fs $syslog $time# Should-Start: $network# Should-Stop: $network# Default-Start: 2 3 4 5# Default-Stop:# Short-Description: vpn client service# Description: Softether vpn client service.### END INIT INFOEXE_DIR=/opt/vpnclient/SER=\"$EXE_DIR\"vpnclientCMD=\"$EXE_DIR\"vpncmdstart(){ echo start $SER start $CMD localhost /client /cmd accountconnect ã€ä½ çš„è¿æ¥åç§°ã€‚å¦‚æœè¯¥è¿æ¥è®¾ç½®äº†è‡ªå¯åŠ¨ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦äº†ã€‘ ifconfig ã€ä½ çš„vpnçš„ç½‘ç»œé€‚é…å™¨åç§°ã€‘ ã€ä½ çš„ipã€‘ netmask 255.0.0.0 echo end}stop(){ $SER stop}case \"$1\" instart)start;;stop)stop;;esacexit 0æ³¨æ„è¿˜éœ€è¦ç»™å®ƒæ‰§è¡Œæƒé™ï¼šsudo chmod +x /etc/init.d/vpnclientç„¶åäº¤ç”± systemd ç®¡ç†ï¼šsudo ln -s /etc/init.d/vpnclient /etc/rc5.d/S99vpnclientsudo systemctl enable vpnclientsudo systemctl start vpnclientä¹‹åå³å¯å¼€æœºè‡ªå¯ã€‚" }, { "title": "Linux æ¡Œé¢ä¸Šçš„å…¨å±€èœå•å®ç°åŸç†", "url": "/posts/Linux-Global-Menu-Principle/", "categories": "", "tags": "Linux", "date": "2021-06-09 06:09:18 +0800", "snippet": " å…¨å±€èœå•æŒ‡çš„æ˜¯å°†åŸæœ¬å±äºåº”ç”¨çª—å£å†…éƒ¨çš„èœå•æ ï¼ˆä¸€èˆ¬ä½äºæ ‡é¢˜æ ä¸‹é¢ï¼‰è„±ç¦»çª—å£ç‹¬ç«‹å„è‡ªçš„åº”ç”¨çª—å£æ˜¾ç¤ºï¼Œä¸”æ²¡æœ‰å¯¼è‡´åŸæœ‰çš„åŠŸèƒ½ç¼ºå¤±ã€‚macOS ä¸Šé¢å°±æœ‰ç›¸å½“å®Œå–„çš„å…¨å±€èœå•æœºåˆ¶ï¼ŒLinuxä¸Šæœ€è¿‘å‡ å¹´å„å¤§æ¡Œé¢ç¯å¢ƒè¯¸å¦‚ KDEã€Gnome ä¹Ÿé™†ç»­æ”¯æŒå…¨å±€èœå•ï¼ˆKDEæ˜¯æœ‰å®˜æ–¹æ”¯æŒçš„ï¼ŒGnomeåˆ™æ˜¯ç¬¬ä¸‰æ–¹æ’ä»¶å®ç°çš„ï¼‰ã€‚å¹¶æ²¡æœ‰è€ƒè¯è¿‡å…¨å±€èœå•åœ¨ Linux ä¸Šçš„å‘å±•å†å²ï¼Œä½†æ˜¯ä» KDE å®ç°å…¨å±€èœå•çš„åŸç†æ¥çœ‹ï¼Œä½¿ç”¨åˆ°äº† com.canonical.AppMenu.Registrar.xml ä»¥åŠ com.canonical.dbusmenu.xml ä¸¤ä¸ª DBus æè¿°æ–‡ä»¶ï¼Œä»è¿™ä¸¤ä¸ªæ–‡ä»¶åå­—æ¥çœ‹ï¼Œåº”è¯¥æ˜¯åŸºäº unity çš„é—ç•™è´¢äº§äº†ã€‚è¿™é‡Œåªä»‹ç» KDE ä¸Šçš„å…¨å±€èœå•åŸç†ã€‚åŸºæœ¬åŸç†ç®€å•æ¥è¯´ï¼Œå°±æ˜¯å°†åº”ç”¨ç¨‹åºå†…éƒ¨çš„èœå•æ ï¼Œé€šè¿‡åºåˆ—åŒ–çš„æ–¹å¼æš´éœ²åˆ°æ ‡å‡†çš„ DBus ä¸Šï¼Œç„¶åç”±å…¨å±€èœå•æœåŠ¡ä»å¯¹åº”çš„ DBus ä¸­ååºåˆ—åŒ–å›èœå•æ å¹¶æ˜¾ç¤ºå‡ºæ¥ã€‚æ‰€ä»¥è¦åšçš„äº‹æƒ…æœ‰ï¼š ä¸åŒç±»å‹çš„åº”ç”¨ç¨‹åºå°†è‡ªå·±çš„èœå•æ åºåˆ—åŒ–æš´éœ²åˆ° DBus ä¸Šï¼šè¿™ä¸€æ­¥æ˜¾ç„¶å¾—æ˜¯æ¡†æ¶æ”¯æŒï¼ŒQt,GTKä¹‹ç±»çš„ é€šè¿‡ DBus ååºåˆ—åŒ–å¾—åˆ°èœå•ï¼Œå¹¶æ ¹æ®å½“å‰çª—å£çš„ id æ˜¾ç¤ºå¯¹åº”çš„èœå•æ å…ˆè¯´åºåˆ—åŒ–ä¸ååºåˆ—åŒ–èœå•çš„æƒ…å†µï¼šè¿™ä¸ªå…¶å®å·²ç»æœ‰ç°æˆå®ç°å¾—äº†ï¼Œç›´æ¥æ‹¿æ¥ç”¨å°±å¥½äº†ï¼Œappmenu-qt,appmenu-gtk-module è¿™äº›ï¼Œæ‰€ä»¥è¿™ä¸€å—å°±ä¸ç”¨æ“å¿ƒäº†ã€‚å…¶æ¬¡æ˜¯æ€ä¹ˆæ ·æ‰èƒ½çŸ¥é“æ¯ä¸ªç¨‹åºå…¨å±€èœå•çš„ DBus? æ˜¾ç„¶éœ€è¦æ¡†æ¶ä¸»åŠ¨å‘Šè¯‰ç³»ç»Ÿï¼Œè¯¥ç¨‹åºçš„ DBus service name æ˜¯ä»€ä¹ˆï¼Œpath æ˜¯ä»€ä¹ˆï¼Œè¿™æ ·æ‰æœ‰å¯èƒ½æˆåŠŸè·å–åˆ°èœå•ã€‚åœ¨è¿™ä»¶äº‹æƒ…ä¸Šï¼ŒQt å’Œ Gtk çš„å¤„ç†æ–¹æ³•æ˜¯ä¸åŒçš„ã€‚ Qté¦–å…ˆ Qt æœ¬èº«å·²ç»æ”¯æŒå…¨å±€èœå•äº†ï¼Œå‚è§ Qtæ–‡æ¡£ã€‚å½“ com.canonical.AppMenu.Registrar DBus å­˜åœ¨çš„æ—¶å€™ï¼Œç¨‹åºå°±ä¼šè‡ªåŠ¨å‘è¯¥ DBus æ³¨å†Œï¼Œé‚£åªéœ€è¦åœ¨å®ç°è¿™ä¸ª DBus Service çš„æ—¶å€™ï¼Œè®°å½•ä¸‹æ¥ Qt ä¸ŠæŠ¥çš„å†…å®¹å°±èƒ½å¤ŸçŸ¥é“è¯¥ Qt ç¨‹åºçš„ DBus æœåŠ¡åç§°ä»¥åŠè·¯å¾„ï¼Œå†ç»“åˆçª—å£ IDï¼Œå°±å¾ˆå®¹æ˜“å®šä½åˆ° Gtkgtk æœ¬èº«æ˜¯ä¸æ”¯æŒå…¨å±€èœå•çš„ï¼Œéœ€è¦å€ŸåŠ© GTK_MODULES=appmenu-gtk-module æ‰èƒ½å¤Ÿå®ç°ã€‚å½“ä½¿ç”¨äº†è¯¥ module åï¼Œå®ƒä¹Ÿä¼šæ£€æµ‹ com.canonical.AppMenu.Registrar DBus æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å°±å¯åŠ¨å…¨å±€èœå•ã€‚ ä½†æ˜¯ä¸åŒçš„æ˜¯ï¼ŒGtk å¹¶ä¸ä¼šå‘è¿™ä¸ª Dbus æ³¨å†Œç¨‹åºçš„ DBus æœåŠ¡åç§°å’Œè·¯å¾„ï¼Œè€Œæ˜¯å°†è¿™äº›ä¿¡æ¯å†™åœ¨äº†çª—å£å±æ€§é‡Œï¼Œéœ€è¦ä½¿ç”¨ xlib ä¹‹ç±»çš„è¿›è¡Œå¯¹åº”å±æ€§çš„è·å–ã€‚ä¸‹é¢æ˜¯å‡ ä¸ªæ¯”è¾ƒå…³é”®çš„å±æ€§åç§°ï¼Œå¯ä»¥å‚ç…§ gtk wiki æŸ¥çœ‹ã€‚ _GTK_APPLICATION_OBJECT_PATH _GTK_WINDOW_OBJECT_PATH _GTK_MENUBAR_OBJECT_PATH _GTK_APP_MENU_OBJECT_PATHé‚£ä¹ˆæ€è·¯å°±å¾ˆæ¸…æ¥šäº†ï¼ŒQt ç¨‹åºçš„è¯ï¼Œå°±é€šè¿‡ com.canonical.AppMenu.Registrar DBUS è¯»å–ç¨‹åºçš„å…¨å±€èœå•çš„ dbus æœåŠ¡åç§°å’Œè·¯å¾„ï¼ŒGTK çš„è¯ï¼Œå°±é€šè¿‡çª—å£å±æ€§ã€‚KDE åŸç†KDE ä¸º Qt å’Œ Gtk åšäº†ç»Ÿä¸€ï¼Œæœ€ç»ˆå°†ç¨‹åºçš„ dbus åç§°å’Œè·¯å¾„å†™åœ¨äº†çª—å£å±æ€§ _KDE_NET_WM_APPMENU_SERVICE_NAME ä»¥åŠ _KDE_NET_WM_APPMENU_OBJECT_PATHã€‚é¦–å…ˆæ˜¯Qtï¼Œå…·ä½“ä»£ç è¯·å‚è€ƒ plasma-workspace/appmenuã€‚å®ƒå®ç°äº† com.canonical.AppMenu.Registrar DBus æœåŠ¡ï¼Œå¹¶åœ¨çª—å£æ³¨å†Œå®ç°é‡Œï¼Œå°†å…¨å±€èœå•çš„ dbus æœåŠ¡åç§°å’Œè·¯å¾„è®°å½•åœ¨äº†çª—å£å±æ€§ä¸­ã€‚åºåˆ—åŒ–çš„æ–¹å¼æ˜¯ dbusmenuå…¶æ¬¡æ˜¯ Gtkï¼Œç”±äº Gtk é‡‡ç”¨çš„æ˜¯å¦å¤–ä¸€å¥—åºåˆ—åŒ–å·¥å…·ï¼Œæ‰€ä»¥ KDE åšäº†ä¸€ä¸ªä»£ç†ï¼Œè§ gmenu-dbusmenu-proxyã€‚è¿™é‡Œé¢åšäº†ä¸¤ä»¶äº‹ï¼Œä¸€æ˜¯è¯»å– Gtk çª—å£çš„å±æ€§å¹¶è®°å½•åˆ° _KDE_NET_WM_APPMENU_SERVICE_NAME ä»¥åŠ _KDE_NET_WM_APPMENU_OBJECT_PATHï¼›äºŒæ˜¯å°† Gtk åºåˆ—åŒ–çš„æ–¹å¼è½¬ä¸ºäº† dbusmenu æ–¹å¼ã€‚æœ€åå°±æ˜¯å…¨å±€èœå•çš„æ’ä»¶äº†ï¼Œç›‘æ§çª—å£å˜åŒ–äº‹ä»¶ï¼ŒDBus ä¸Šçš„èœå•æ›´æ–°äº‹ä»¶ï¼Œä¸ºæ¯ä¸ªçª—å£å‘ˆç°å„è‡ªçš„å…¨å±€èœå•ï¼Œè§ plasma-active-window-controlDeepin OS ä¸Šçš„å…¨å±€èœå•å®ç°å…·ä½“è§ï¼š SeptemberHX/dde-top-panel: dde top panel for Deepin V20 (github.com) ï¼šè´Ÿè´£ç›‘æ§ DBus å¹¶ä» DBus ä¸­è¯»å–å¹¶æ˜¾ç¤ºå‡ºå½“å‰æ´»è·ƒçª—å£çš„èœå• SeptemberHX/dde-globalmenu-service: DBus service registery for dde-globalmenu (github.com) ï¼šè´Ÿè´£å¯åŠ¨ DBus å¹¶å°†ä¸åŒçš„å…¨å±€èœå•å®ç°ï¼ˆQtã€Gtkç­‰ï¼‰åšä¸€å±‚ç»Ÿä¸€ä»£ç†ä»¥æ–¹ä¾¿ç»Ÿä¸€è°ƒç”¨" } ]
